---
import "../styles/global.css";
import { ViewTransitions } from "astro:transitions";

const {
  title = "RadioABF",
  description = "RadioABF ‚Äî Alternative Bass Fr√©quence | The DJs' Frequency. Live electronic music streaming on radioabf.com. Vote for your favorite tracks, discover DJ programs and weekly charts."
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site || "https://radioabf.com").toString();
---

<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- SEO Core -->
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />
    <meta name="robots" content="index, follow" />
    <meta name="author" content="Loic Mounier - RadioABF" />
    <meta
      name="keywords"
      content="radioabf, radio abf, alternative bass fr√©quence, electronic music radio, live dj streaming, radioabf.com, house music, deep house, progressive, track voting"
    />

    <!-- ===== FAVICONS ===== -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" id="abfFavicon" />
    <link rel="icon" href="/favicon-32.png" sizes="32x32" />
    <link rel="icon" href="/favicon-16.png" sizes="16x16" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:site_name" content="RadioABF ‚Äî Alternative Bass Fr√©quence" />
    <meta property="og:image" content="https://radioabf.com/og-image.jpg" />
    <meta property="og:image:alt" content="RadioABF Logo ‚Äî Alternative Bass Fr√©quence" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:locale:alternate" content="fr_FR" />

    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content="https://radioabf.com/og-image.jpg" />
    <meta name="twitter:site" content="@abfonair" />
    <meta name="twitter:domain" content="radioabf.com" />

    <!-- Structured Data -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "RadioStation",
        "name": "RadioABF",
        "alternateName": "Alternative Bass Fr√©quence",
        "description": "Live electronic music radio streaming on radioabf.com. Community track voting, DJ programs and high-quality audio.",
        "url": "https://radioabf.com",
        "logo": "https://radioabf.com/logo-abf.png",
        "sameAs": [
          "https://x.com/abfonair",
          "https://www.facebook.com/abfonair",
          "https://www.instagram.com/abfonair"
        ],
        "genre": "Electronic, House, Deep House, Progressive, Bass Music"
      }
    </script>

    <slot name="head" />
    <ViewTransitions />

    <style is:inline>
      /* ===================== LOGO PULSE (STABLE) ===================== */
      @keyframes abfBeatPulse {
        0% { transform: scale(1); filter: drop-shadow(0 0 10px rgba(47,194,255,.35)); opacity: .95; }
        25% { transform: scale(1.3); filter: drop-shadow(0 0 52px rgba(47,194,255,1)); opacity: 1; }
        100% { transform: scale(1); filter: drop-shadow(0 0 10px rgba(47,194,255,.35)); opacity: .95; }
      }
      #abfBrandLogo{
        transform: translateZ(0);
        will-change: transform, filter, opacity;
      }
      #abfBrandLogo.abf-beat{
        animation: abfBeatPulse 0.55s ease-out;
      }

      /* Desktop dropdown */
      .abf-dd summary::-webkit-details-marker { display: none; }
      .abf-dd summary { list-style: none; }
      .abf-dd { position: relative; }
      .abf-dd > .abf-dd-panel { display: none; }
      .abf-dd[open] > .abf-dd-panel { display: block; }

      /* Fix select option colors */
      #streamSelect option,
      #streamSelectMobile option,
      #fsStreamSelect option,
      #yearSelect option{
        background:#050B14; color:#fff;
      }

      /* Range thumb */
      input[type="range"]{ accent-color: #2FC2FF; }

      /* Canvas: √©vite certains glitches pendant transitions */
      #visualizerCanvas{ display:block; }

      /* Fullscreen overlay safety */
      #fsOverlay[aria-hidden="true"]{ pointer-events:none; }
      #fsOverlay[aria-hidden="false"]{ pointer-events:auto; }

      /* ===================== MODALS (Build + Legal + Cookies) ===================== */
      .abfModal{
        position: fixed;
        inset: 0;
        z-index: 70;
        display: none;
      }
      .abfModal[aria-hidden="false"]{ display:block; }
      .abfModalBackdrop{
        position:absolute; inset:0;
        background: rgba(5,11,20,0.78);
        backdrop-filter: blur(18px);
      }
      .abfModalWrap{
        position:relative;
        height:100%;
        width:100%;
        display:flex;
        align-items:center;
        justify-content:center;
        padding: 18px;
      }
      .abfModalCard{
        width: min(920px, 100%);
        max-height: min(78vh, 820px);
        overflow: hidden;
        border-radius: 20px;
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(5,11,20,0.78);
        box-shadow: 0 30px 120px rgba(0,0,0,0.55);
      }
      .abfModalTop{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap: 12px;
        padding: 14px 14px 10px 14px;
        border-bottom: 1px solid rgba(255,255,255,0.10);
        background: rgba(255,255,255,0.03);
      }
      .abfModalTitle{
        font-weight: 800;
        letter-spacing: .08em;
        text-transform: uppercase;
        font-size: 12px;
        color: rgba(255,255,255,0.75);
      }
      .abfModalClose{
        width: 40px;
        height: 40px;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.15);
        background: rgba(255,255,255,0.05);
        transition: .15s ease;
      }
      .abfModalClose:hover{ background: rgba(255,255,255,0.10); }
      .abfModalBody{
        padding: 14px;
        overflow: auto;
        max-height: calc(min(78vh, 820px) - 60px);
      }
      .buildList{ display:flex; flex-direction:column; gap:10px; }
      .buildItem{
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        gap: 12px;
        padding: 12px;
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.10);
        background: rgba(255,255,255,0.04);
      }
      .buildLeft{ min-width:0; }
      .buildVer{
        font-weight: 800;
        color: rgba(47,194,255,0.95);
        letter-spacing: .02em;
      }
      .buildTxt{ color: rgba(255,255,255,0.75); font-size: 13px; margin-top: 4px; line-height: 1.35; }
      .buildDate{
        flex: none;
        font-size: 12px;
        color: rgba(255,255,255,0.55);
        border: 1px solid rgba(255,255,255,0.10);
        background: rgba(255,255,255,0.03);
        padding: 6px 10px;
        border-radius: 999px;
        white-space: nowrap;
        text-align: right;
      }
      .legal h2{
        font-size: 16px;
        font-weight: 800;
        margin: 0 0 10px 0;
      }
      .legal h3{
        font-size: 13px;
        font-weight: 800;
        margin: 16px 0 6px 0;
        color: rgba(255,255,255,0.85);
      }
      .legal p, .legal li{
        font-size: 13px;
        color: rgba(255,255,255,0.75);
        line-height: 1.45;
      }
      .legal ol{
        padding-left: 18px;
        margin: 0;
      }
      .legal .muted{
        color: rgba(255,255,255,0.55);
        font-size: 12px;
        margin-top: 14px;
      }

      .abfFooterLinkBtn{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.10);
        background: rgba(255,255,255,0.04);
        color: rgba(255,255,255,0.72);
        transition: .15s ease;
        white-space: nowrap;
      }
      .abfFooterLinkBtn:hover{
        background: rgba(255,255,255,0.08);
        color: rgba(47,194,255,0.95);
      }

      /* ===================== ABF COVER (fallback gradient + logo fills square) ===================== */
      .abfCover {
        position: relative;
        overflow: hidden;
      }
      .abfCover img {
        position: absolute;
        inset: 0;
        z-index: 4;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .abfCover::after{
        content:"";
        position:absolute;
        inset:0;
        z-index:3;
        pointer-events:none;
        background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,0) 45%);
        opacity:.35;
      }
      .abfCoverFallback {
        position: absolute;
        inset: 0;
        z-index: 1;
        display: grid;
        place-items: center;
        background: radial-gradient(120% 120% at 30% 20%,
          rgba(47,194,255,.30),
          rgba(20,92,143,.18) 45%,
          rgba(10,31,51,1) 100%);
      }
      .abfCoverFallback img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: .95;
        filter: drop-shadow(0 10px 25px rgba(0,0,0,.35));
      }

      /* ===================== PLAYER GLASS (less transparent) ===================== */
      .abf-playerGlass{
        position: relative;
        background: rgba(5,11,20,0.92) !important;
        backdrop-filter: blur(18px) saturate(140%) !important;
      }
      .abf-playerGlass::before{
        content:"";
        position:absolute;
        inset:0;
        pointer-events:none;
        background: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0) 55%);
      }

      /* ===================== ICONS (modern SVG, Android-safe) ===================== */
      .abf-ic{
        display:inline-flex;
        width:20px;
        height:20px;
        align-items:center;
        justify-content:center;
      }
      .abf-ic svg{
        width:20px;
        height:20px;
        stroke: currentColor;
        fill: none;
        stroke-width: 2.2;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      /* ===================== COOKIE BANNER ===================== */
      .abfCookieBar{
        position: fixed;
        left: 0;
        right: 0;
        z-index: 65;
        pointer-events: none;
        bottom: calc(var(--abf-footer-h) + var(--abf-player-h) + 14px);
      }
      .abfCookieBarInner{
        pointer-events: auto;
        width: min(980px, 100%);
        margin: 0 auto;
        padding: 0 16px;
      }
      .abfCookieCard{
        border-radius: 18px;
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(5,11,20,0.92);
        backdrop-filter: blur(18px) saturate(140%);
        box-shadow: 0 20px 80px rgba(0,0,0,0.55);
        padding: 12px;
        display:flex;
        flex-direction: column;
        gap: 10px;
      }
      .abfCookieRow{
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      .abfCookieTitle{
        font-weight: 800;
        letter-spacing: .08em;
        text-transform: uppercase;
        font-size: 11px;
        color: rgba(255,255,255,0.75);
      }
      .abfCookieTxt{
        color: rgba(255,255,255,0.72);
        font-size: 13px;
        line-height: 1.35;
        margin-top: 4px;
        max-width: 62ch;
      }
      .abfCookieActions{
        display:flex;
        gap: 8px;
        flex-wrap: wrap;
        justify-content:flex-end;
      }
      .abfBtn{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        gap:8px;
        padding: 9px 12px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.14);
        background: rgba(255,255,255,0.06);
        color: rgba(255,255,255,0.86);
        transition: .15s ease;
        font-size: 13px;
        font-weight: 700;
        white-space: nowrap;
      }
      .abfBtn:hover{ background: rgba(255,255,255,0.10); }
      .abfBtnPrimary{
        border-color: rgba(47,194,255,0.35);
        background: linear-gradient(90deg, rgba(20,92,143,0.9), rgba(47,194,255,0.9));
        color: rgba(255,255,255,0.95);
      }
      .abfBtnPrimary:hover{
        filter: brightness(1.05);
      }
      .abfBtnGhost{
        background: transparent;
      }
      .abfBtnDanger{
        border-color: rgba(239,68,68,0.35);
        background: rgba(239,68,68,0.10);
        color: rgba(255,255,255,0.90);
      }
      .abfBtnDanger:hover{
        background: rgba(239,68,68,0.16);
      }
      .abfMuted{
        color: rgba(255,255,255,0.55);
        font-size: 12px;
        line-height: 1.35;
      }
      .abfToggle{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap: 12px;
        padding: 12px;
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.10);
        background: rgba(255,255,255,0.04);
      }
      .abfToggle h4{
        margin:0;
        font-size: 13px;
        font-weight: 800;
        color: rgba(255,255,255,0.88);
      }
      .abfToggle p{
        margin: 4px 0 0 0;
        font-size: 13px;
        color: rgba(255,255,255,0.70);
        line-height: 1.35;
      }
      .abfSwitch{
        flex:none;
        width: 48px;
        height: 28px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.15);
        background: rgba(255,255,255,0.06);
        position: relative;
        cursor:pointer;
        transition: .15s ease;
      }
      .abfSwitch::after{
        content:"";
        position:absolute;
        top: 3px;
        left: 3px;
        width: 22px;
        height: 22px;
        border-radius: 999px;
        background: rgba(255,255,255,0.85);
        transition: .15s ease;
      }
      .abfSwitch[data-on="true"]{
        border-color: rgba(47,194,255,0.35);
        background: rgba(47,194,255,0.18);
      }
      .abfSwitch[data-on="true"]::after{
        left: 23px;
        background: rgba(47,194,255,0.95);
      }
    </style>

    <!-- ===================== GA4 STUB (Consent Mode default denied) ===================== -->
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      // Default deny until user explicitly accepts analytics
      gtag('consent', 'default', {
        ad_storage: 'denied',
        analytics_storage: 'denied',
        functionality_storage: 'granted',
        security_storage: 'granted'
      });
    </script>
<script src="/scripts/dedications-global.js" defer></script>
  </head>

  <body
    class="bg-[#050B14] text-white min-h-screen flex flex-col"
    style="
      --abf-footer-h: 0px;
      --abf-player-h: 0px;
      --abf-gap: 1px;
    "
  >
    <!-- ================= HEADER ================= -->
    <header id="siteHeader" class="sticky top-0 z-50">
      <div class="bg-[#050B14]/80 backdrop-blur-xl border-b border-white/10">
        <div class="mx-auto max-w-6xl px-4 sm:px-6 py-4">
          <div class="flex items-center justify-between gap-4">
            <!-- Brand -->
            <a href="/" class="flex items-center gap-3 min-w-0 group">
              <div class="relative w-14 h-14 sm:w-16 sm:h-16 flex items-center justify-center flex-none">
                <div class="absolute inset-0 rounded-full bg-cyan-400/20 blur-2xl opacity-80"></div>
                <div class="absolute inset-0 rounded-full border border-cyan-400/25"></div>
                <img
                  id="abfBrandLogo"
                  src="/logo-abf.png"
                  alt="ABF"
                  class="relative w-full h-full object-contain
                         drop-shadow-[0_0_18px_rgba(47,194,255,0.55)]
                         transition duration-500
                         group-hover:drop-shadow-[0_0_28px_rgba(47,194,255,0.9)]"
                  loading="eager"
                  decoding="async"
                />
              </div>
              <div class="min-w-0 leading-tight">
                <div class="font-extrabold text-white tracking-wide truncate">RadioABF</div>
                <div class="text-xs text-white/60 truncate">Alternative Bass Fr√©quence</div>
                <div
                  class="text-[11px] tracking-wider uppercase
                         bg-gradient-to-r from-cyan-400 via-blue-400 to-cyan-300
                         bg-clip-text text-transparent
                         drop-shadow-[0_0_6px_rgba(47,194,255,0.35)]
                         truncate"
                >
                  The DJs' Frequency
                </div>
              </div>
            </a>

            <!-- Desktop nav -->
            <nav class="hidden md:flex items-center gap-2">
              <a href="/" class="px-3 py-2 rounded-xl text-white/80 hover:text-white hover:bg-white/5 transition">Home</a>
              <a href="/news" class="px-3 py-2 rounded-xl text-white/80 hover:text-white hover:bg-white/5 transition">News</a>
              <a href="/music" class="px-3 py-2 rounded-xl text-white/80 hover:text-white hover:bg-white/5 transition">Music</a>
              <a href="/programs" class="px-3 py-2 rounded-xl text-white/80 hover:text-white hover:bg-white/5 transition">Programs</a>
              <a href="/artists" class="px-3 py-2 rounded-xl text-white/80 hover:text-white hover:bg-white/5 transition">Artists</a>
            </nav>

            <!-- Mobile button -->
            <button
              id="navBtn"
              type="button"
              class="md:hidden inline-flex items-center justify-center w-10 h-10 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 transition"
              aria-label="Open menu"
              aria-expanded="false"
              aria-controls="mobileNav"
            >
              ‚ò∞
            </button>
          </div>

          <!-- Mobile nav -->
          <nav id="mobileNav" class="md:hidden hidden mt-3 p-3 rounded-2xl border border-white/10 bg-white/5">
            <a href="/" class="block px-3 py-2 rounded-xl text-white/80 hover:text-white hover:bg-white/5 transition">Home</a>
            <a href="/news" class="block px-3 py-2 rounded-xl text-white/80 hover:text-white hover:bg-white/5 transition">News</a>
            <a href="/music" class="block px-3 py-2 rounded-xl text-white/80 hover:text-white hover:bg-white/5 transition">Music</a>
            <a href="/programs" class="block px-3 py-2 rounded-xl text-white/80 hover:text-white hover:bg-white/5 transition">Programs</a>
            <a href="/artists" class="block px-3 py-2 rounded-xl text-white/80 hover:text-white hover:bg-white/5 transition">Artists</a>
          </nav>
        </div>
      </div>

      <script is:inline data-astro-rerun>
        (() => {
          const btn = document.getElementById("navBtn");
          const nav = document.getElementById("mobileNav");
          if (!btn || !nav) return;
          btn.onclick = () => {
            const isOpen = !nav.classList.contains("hidden");
            nav.classList.toggle("hidden", isOpen);
            btn.setAttribute("aria-expanded", String(!isOpen));
          };
        })();
      </script>
    </header>

<!-- DEDICATIONS BAR (global) -->
<div class="dedications-bar" transition:persist="dedications">
  <div class="dedications-inner">
    <div class="dedications-label">
      DEDICATIONS
      <span id="dedicationsBadge" class="dedications-badge hidden">NEW</span>
    </div>

    <div class="dedications-scroll">
      <div class="dedications-scroll-inner" id="dedicationsInner"></div>
    </div>

    <button id="openDedicationModal" type="button" class="dedications-send-btn">
      Send yours! üé§
    </button>
  </div>
</div>


<style is:inline>
  @keyframes marquee {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }
  .animate-marquee {
    animation: marquee 90s linear infinite;
  }
  .animate-marquee:hover {
    animation-play-state: paused;
  }
</style>

    <!-- ================= GLOBAL FORMATTER (ARTIST/TITLE) ================= -->
    <script is:inline data-astro-rerun>
      (() => {
        if (window.ABF_FMT) return;

        function upperArtist(s){
          return String(s || "‚Äî").trim().toUpperCase();
        }

        function titleCaseEN(input){
          const s = String(input || "").trim();
          if (!s) return "‚Äî";
          const lowerWords = new Set([
            "a","an","the","and","but","or","nor","for","so","yet",
            "as","at","by","for","from","in","into","near","of","on","onto","over","per","to","up","via","with","within","without"
          ]);
          const parts = s.split(/(\s+)/);
          return parts.map((chunk, idx) => {
            if (/^\s+$/.test(chunk)) return chunk;
            const word = chunk;
            if (word === word.toUpperCase() && /[A-Z]/.test(word) && word.length <= 6) return word;

            const hyParts = word.split("-");
            const rebuilt = hyParts.map((w, hIdx) => {
              const cleaned = w.replace(/[^\p{L}\p{N}'‚Äô]/gu, "");
              const lower = cleaned.toLowerCase();
              const isFirst = idx === 0 && hIdx === 0;
              const isLast = idx === parts.length - 1 && hIdx === hyParts.length - 1;
              if (!cleaned) return w;
              if (!isFirst && !isLast && lowerWords.has(lower)) return w.replace(cleaned, lower);
              const cap = lower.charAt(0).toUpperCase() + lower.slice(1);
              return w.replace(cleaned, cap);
            });
            return rebuilt.join("-");
          }).join("");
        }

        function apply(root = document){
          root.querySelectorAll("[data-abf-artist]").forEach((el) => {
            const raw = (el.getAttribute("data-abf-artist") || "").trim();
            const val = raw ? raw : el.textContent;
            el.textContent = upperArtist(val);
          });
          root.querySelectorAll("[data-abf-title]").forEach((el) => {
            const raw = (el.getAttribute("data-abf-title") || "").trim();
            const val = raw ? raw : el.textContent;
            el.textContent = titleCaseEN(val);
          });
        }

        window.ABF_FMT = { artist: upperArtist, title: titleCaseEN, apply };

        const run = () => requestAnimationFrame(() => apply(document));
        document.addEventListener("DOMContentLoaded", run);
        document.addEventListener("astro:page-load", run);
        document.addEventListener("astro:after-swap", run);
      })();
    </script>

    <!-- ================= PAGE ================= -->
    <main
      id="mainContent"
      class="mx-auto w-full max-w-6xl flex-1 px-4 sm:px-6 pt-6"
      style="padding-bottom: calc(var(--abf-player-h) + var(--abf-footer-h) + var(--abf-gap) + 24px);"
    >
      <slot />
    </main>

    <!-- ================= PLAYER (compact) ================= -->
    <div
      id="playerContainer"
      class="fixed left-0 right-0 z-50 pointer-events-none"
      style="bottom: calc(var(--abf-footer-h) + var(--abf-gap));"
    >
      <div class="mx-auto max-w-6xl px-4 sm:px-6 pb-4 pointer-events-auto">
        <div class="abf-playerGlass rounded-2xl overflow-hidden border border-white/10">
          <div class="abf-noise" aria-hidden="true"></div>

          <div class="px-3 sm:px-4 py-2.5">
            <div class="flex items-center gap-3">
              <div class="abfCover w-11 h-11 rounded-xl border border-white/10 overflow-hidden flex-none">
                <img id="playerCover" class="hidden" alt="Pochette actuelle" />
                <div id="playerCoverFallback" class="abfCoverFallback">
                  <img src="/logo-abf.png" alt="ABF" loading="lazy" decoding="async" />
                </div>
              </div>

              <div class="min-w-0 flex-1">
                <div id="npArtist" data-abf-artist class="font-semibold text-[13px] leading-tight truncate">‚Äî</div>
                <div id="npTitle" data-abf-title class="text-[12px] text-white/70 leading-tight truncate">‚Äî</div>
              </div>

              <div class="flex items-center gap-2 flex-none">
                <div
                  id="npStatus"
                  class="hidden sm:inline-flex items-center justify-center px-2.5 py-1 rounded-xl border border-white/10 bg-white/5 text-[11px] text-cyan-200/90 uppercase tracking-wider"
                >
                  stopped
                </div>

                <select
                  id="streamSelect"
                  class="hidden md:block bg-[#050B14]/60 border border-white/15 text-white rounded-xl px-2.5 py-2 text-xs backdrop-blur-xl"
                  title="Stream quality"
                >
                  <option value="0">MP3 ‚Ä¢ 320 kbps</option>
                  <option value="1">MP3 ‚Ä¢ 128 kbps</option>
                  <option value="2">AAC+ ‚Ä¢ 32 kbps</option>
                  <option value="3">FLAC ‚Ä¢ 728 kbps</option>
                </select>

                <button id="playBtn" type="button" class="flex items-center justify-center w-10 h-10 rounded-xl border border-white/15 bg-white/10 hover:bg-white/15 transition shadow-[0_10px_30px_rgba(47,194,255,0.18)] hover:shadow-[0_14px_40px_rgba(47,194,255,0.28)]" aria-label="Play/Pause" title="Play/Pause">
                  <span class="abf-ic" data-ic="play"></span>
                </button>
                <button id="stopBtn" type="button" class="flex items-center justify-center w-10 h-10 rounded-xl border border-white/15 bg-white/5 hover:bg-white/10 transition" aria-label="Stop" title="Stop">
                  <span class="abf-ic" data-ic="stop"></span>
                </button>
                <button id="muteBtn" type="button" class="flex items-center justify-center w-10 h-10 rounded-xl border border-white/15 bg-white/5 hover:bg-white/10 transition" aria-label="Mute" title="Mute">
                  <span class="abf-ic" data-ic="volume"></span>
                </button>
                <button id="fsBtn" type="button" class="flex items-center justify-center w-10 h-10 rounded-xl border border-white/15 bg-white/5 hover:bg-white/10 transition" aria-label="Full screen" title="Full screen">
                  <span class="abf-ic" data-ic="fs"></span>
                </button>

                <input id="volRange" type="range" min="0" max="1" step="0.01" value="0.8" class="hidden sm:block w-28" aria-label="Volume" title="Volume" />
              </div>
            </div>

            <div class="mt-2 flex items-center justify-between gap-2 sm:hidden">
              <div id="npStatusMobile" class="inline-flex items-center justify-center px-2.5 py-1 rounded-xl border border-white/10 bg-white/5 text-[11px] text-cyan-200/90 uppercase tracking-wider">
                stopped
              </div>

              <select id="streamSelectMobile" class="bg-[#050B14]/60 border border-white/15 text-white rounded-xl px-2.5 py-2 text-xs backdrop-blur-xl" title="Stream quality">
                  <option value="0">MP3 ‚Ä¢ 320 kbps</option>
                  <option value="1">MP3 ‚Ä¢ 128 kbps</option>
                  <option value="2">AAC+ ‚Ä¢ 32 kbps</option>
                  <option value="3">FLAC ‚Ä¢ 728 kbps</option>
              </select>
            </div>
          </div>

          <div class="border-t border-white/10">
            <canvas id="visualizerCanvas" class="w-full h-8"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= FULLSCREEN PLAYER OVERLAY (NO VISUALIZER) ================= -->
    <div id="fsOverlay" class="fixed inset-0 z-[60] hidden" aria-hidden="true">
      <div class="absolute inset-0 bg-[#050B14]/92 backdrop-blur-2xl"></div>

      <div class="relative h-full w-full">
        <div class="mx-auto max-w-6xl px-4 sm:px-6 pt-5 flex items-center justify-between gap-3">
          <div class="text-xs text-white/50 uppercase tracking-wider">RadioABF ‚Äî Player</div>
          <button id="fsClose" type="button" class="w-10 h-10 rounded-xl border border-white/15 bg-white/5 hover:bg-white/10 transition" aria-label="Close full screen" title="Close">‚úï</button>
        </div>

        <div class="mx-auto max-w-6xl px-4 sm:px-6 pb-6 pt-5 h-[calc(100%-76px)] grid grid-rows-[1fr_auto] gap-5">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-center min-h-0">
            <div class="min-h-0">
              <div class="abfCover aspect-square w-full max-w-[560px] mx-auto rounded-3xl border border-white/10 overflow-hidden relative">
                <img id="fsCover" class="hidden" alt="Pochette actuelle" />
                <div id="fsCoverFallback" class="abfCoverFallback">
                  <img src="/logo-abf.png" alt="ABF" loading="lazy" decoding="async" />
                </div>
              </div>
            </div>

            <div class="min-w-0">
              <div class="flex items-center gap-2 mb-3">
                <div id="fsStatus" class="inline-flex items-center justify-center px-3 py-1 rounded-xl border border-white/10 bg-white/5 text-[11px] text-cyan-200/90 uppercase tracking-wider">
                  stopped
                </div>
                <div class="text-white/40 text-xs">‚Ä¢</div>
                <div class="text-white/60 text-xs">The DJs' Frequency</div>
              </div>

              <div id="fsArtist" data-abf-artist class="text-2xl sm:text-4xl font-extrabold leading-tight truncate">‚Äî</div>
              <div id="fsTitle" data-abf-title class="mt-2 text-white/70 text-base sm:text-lg truncate">‚Äî</div>

              <div class="mt-6 flex flex-wrap items-center gap-2">
                <button id="fsPlay" type="button" class="flex items-center justify-center px-5 py-3 rounded-2xl font-semibold bg-gradient-to-r from-[#145C8F] to-[#2FC2FF] shadow-lg shadow-cyan-500/25 hover:scale-[1.02] transition" aria-label="Play/Pause">
                  <span class="abf-ic" data-ic="play"></span>
                </button>
                <button id="fsStop" type="button" class="flex items-center justify-center px-5 py-3 rounded-2xl font-semibold border border-white/15 bg-white/5 hover:bg-white/10 transition" aria-label="Stop">
                  <span class="abf-ic" data-ic="stop"></span>
                  <span>Stop</span>
                </button>
                <button id="fsMute" type="button" class="flex items-center justify-center px-5 py-3 rounded-2xl font-semibold border border-white/15 bg-white/5 hover:bg-white/10 transition" aria-label="Mute">
                  <span class="abf-ic" data-ic="volume"></span>
                </button>

                <div class="flex items-center gap-2 px-4 py-3 rounded-2xl border border-white/10 bg-white/5">
                  <span class="text-xs text-white/60">Vol</span>
                  <input id="fsVol" type="range" min="0" max="1" step="0.01" value="0.8" class="w-40" aria-label="Volume" />
                </div>

                <select id="fsStreamSelect" class="bg-[#050B14]/60 border border-white/15 text-white rounded-2xl px-4 py-3 text-sm backdrop-blur-xl" title="Stream quality">
                  <option value="0">MP3 ‚Ä¢ 320 kbps</option>
                  <option value="1">MP3 ‚Ä¢ 128 kbps</option>
                  <option value="2">AAC+ ‚Ä¢ 32 kbps</option>
                  <option value="3">FLAC ‚Ä¢ 728 kbps</option>
                </select>
              </div>

              <div class="mt-4 text-sm text-white/50">
                Tip: press <span class="text-white/70">ESC</span> to exit full screen.
              </div>
            </div>
          </div>

          <div class="h-[1px]"></div>
        </div>
      </div>
    </div>

    <!-- ================= BUILD MODAL ================= -->
    <div id="buildModal" class="abfModal" aria-hidden="true">
      <div class="abfModalBackdrop" data-close="build"></div>
      <div class="abfModalWrap">
        <div class="abfModalCard" role="dialog" aria-modal="true" aria-label="Build updates">
          <div class="abfModalTop">
            <div class="abfModalTitle">Build / Updates</div>
            <button class="abfModalClose" id="buildClose" type="button" aria-label="Close">‚úï</button>
          </div>
          <div class="abfModalBody">
            <div id="buildList" class="buildList"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= LEGAL MODAL ================= -->
    <div id="legalModal" class="abfModal" aria-hidden="true">
      <div class="abfModalBackdrop" data-close="legal"></div>
      <div class="abfModalWrap">
        <div class="abfModalCard" role="dialog" aria-modal="true" aria-label="Legal notices">
          <div class="abfModalTop">
            <div class="abfModalTitle">Legal Notices</div>
            <button class="abfModalClose" id="legalClose" type="button" aria-label="Close">‚úï</button>
          </div>
          <div class="abfModalBody legal">
            <h2>Legal Notices</h2>
            <h3>1. Website Publisher / Editor</h3>
            <p>
              This website radioabf.com is published by: <b>Radio ABF</b><br />
              Email: <b>contact@radioabf.com</b>
            </p>
            <p>
            Director of Publication: <b>Loic Mounier</b><br />
            Editorial Manager: <b>Loic Mounier</b><br />
            Technical Manager: <b>Loic Mounier</b>
            </p>
            <h3>2. Hosting Provider</h3>
            <p>The website is hosted by: <b>Vercel</b></p>
            <h3>3. Intellectual Property ‚Äì Copyright</h3>
            <p>
              All content available on radioabf.com (text, graphics, logos, sounds, streams, mixes, photos, videos, software, etc.)
              is protected by French and international copyright laws. Unless expressly authorized in writing, any reproduction,
              representation, modification, publication, total or partial adaptation of the site or its content, by any means whatsoever
              and on any medium whatsoever, is prohibited (art. L.122-4 of the French Intellectual Property Code).
            </p>
            <p>
              The logos, brands and distinctive signs appearing on the site are the property of Radio ABF and/or its partners.
              Any reproduction, in whole or in part, without authorization constitutes an infringement punishable by law.
            </p>
            <h3>4. Personal Data ‚Äì GDPR</h3>
            <p>
              Personal data collected on this website (contact form, newsletter subscription, comments, listening statistics, etc.)
              are processed in accordance with the General Data Protection Regulation (GDPR ‚Äì EU 2016/679) and the French Data Protection Act.
            </p>
            <p>
              Data controller: Same as Publisher above. Purpose of processing: site operation, audience measurement, newsletter,
              response to contact requests. Legal basis: consent and/or legitimate interest. Retention period: time strictly necessary
              for the purposes pursued (max. 3 years for prospects). Recipients: only the publisher and technical service providers
              (host, statistics tool, email service).
            </p>
            <p>
              You have the right to access, rectify, erase, restrict processing, object, and data portability.
              To exercise these rights: contact@radioabf.com.
              You also have the right to lodge a complaint with the CNIL: https://www.cnil.fr
            </p>
            <h3>5. Streaming &amp; Music Broadcasting</h3>
            <p>
              Radio ABF broadcasts music under licenses obtained from the relevant collective management organizations (SACEM, SPPF, SCPP, etc.)
              and, for online streaming, under agreements with relevant performers' and producers' rights societies.
            </p>
            <p>
              Any unauthorized rebroadcasting, recording or commercial use of the streams is strictly prohibited.
            </p>
            <h3>6. External Links</h3>
            <p>
              The site may contain hyperlinks to external websites. Radio ABF has no control over these sites and cannot be held responsible
              for their content or practices.
            </p>
            <h3>7. Limitation of Liability</h3>
            <p>
              Radio ABF makes every effort to ensure the accuracy and updating of information published on the site. However, it cannot guarantee
              the completeness, accuracy or absence of modification by a third party (intrusion, virus, etc.). Consequently, Radio ABF cannot be
              held liable for any direct or indirect damage resulting from the use of the site or the impossibility of accessing it.
            </p>
            <h3>8. Applicable Law ‚Äì Jurisdiction</h3>
            <p>
              These legal notices are governed by French law. Any dispute relating to the validity, interpretation or execution of these legal notices
              will be subject to the exclusive jurisdiction of the competent courts of Paris.
            </p>
            <p class="muted">Last updated: February 2026</p>
            <p class="muted">Thank you for visiting radioabf.com!</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= COOKIES MODAL (RGPD) ================= -->
    <div id="cookiesModal" class="abfModal" aria-hidden="true">
      <div class="abfModalBackdrop" data-close="cookies"></div>
      <div class="abfModalWrap">
        <div class="abfModalCard" role="dialog" aria-modal="true" aria-label="Cookie preferences">
          <div class="abfModalTop">
            <div class="abfModalTitle">Cookie preferences</div>
            <button class="abfModalClose" id="cookiesClose" type="button" aria-label="Close">‚úï</button>
          </div>
          <div class="abfModalBody">
            <div class="space-y-3 text-sm text-white/75 leading-relaxed">
              <p class="text-white/85 font-semibold">
                We use cookies to keep the site working and (optionally) to measure audience with Google Analytics (GA4).
              </p>

              <div class="abfToggle">
                <div class="min-w-0">
                  <h4>Necessary cookies</h4>
                  <p>
                    Required for core features (player preferences, security). Always enabled.
                  </p>
                </div>
                <div class="abfSwitch" data-on="true" aria-hidden="true" title="Always on"></div>
              </div>

              <div class="abfToggle">
                <div class="min-w-0">
                  <h4>Analytics (GA4)</h4>
                  <p>
                    Helps us understand traffic and improve the experience. Disabled by default until you accept.
                  </p>
                </div>
                <button id="analyticsToggle" type="button" class="abfSwitch" data-on="false" aria-label="Toggle analytics"></button>
              </div>

              <div class="flex flex-wrap gap-2 pt-2">
                <button id="cookiesAccept" type="button" class="abfBtn abfBtnPrimary">Accept analytics</button>
                <button id="cookiesDecline" type="button" class="abfBtn">Decline</button>
                <button id="cookiesSave" type="button" class="abfBtn abfBtnGhost">Save</button>
              </div>

              <p class="abfMuted">
                You can change your choice any time from the footer (‚ÄúCookies‚Äù).
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= COOKIE BANNER (shown until choice) ================= -->
    <div id="cookieBar" class="abfCookieBar hidden" aria-hidden="true">
      <div class="abfCookieBarInner">
        <div class="abfCookieCard">
          <div class="abfCookieRow">
            <div>
              <div class="abfCookieTitle">Cookies</div>
              <div class="abfCookieTxt">
                We use necessary cookies for core features. With your permission, we also use GA4 analytics to improve RadioABF.
              </div>
            </div>
            <div class="abfCookieActions">
              <button id="cookieManage" type="button" class="abfBtn">Manage</button>
              <button id="cookieDecline" type="button" class="abfBtn">Decline</button>
              <button id="cookieAccept" type="button" class="abfBtn abfBtnPrimary">Accept</button>
            </div>
          </div>
          <div class="abfMuted">
            By clicking ‚ÄúAccept‚Äù, you allow analytics cookies (GA4). You can change your choice anytime.
          </div>
        </div>
      </div>
    </div>

    <!-- ================= PLAYER LOGIC + VISUALIZER + TAB/FAVICON LIVE ================= -->
    <script is:inline data-astro-rerun>
      (() => {
        // ========= GLOBAL STATE =========
        window.__abf = window.__abf || {};
        const S = window.__abf;

        S.isStopped = S.isStopped ?? true;
        const LS_KEY = "abf_stream_index";
        const VOL_KEY = "abf_volume";

        // ‚úÖ cookie consent id (cookie, not localStorage)
        const CONSENT_COOKIE = "abf_consent_v1"; // value: "a1" (analytics yes) or "a0" (analytics no)

        S.streams = S.streams || [
          { url: "https://stream.radioabf.com/abf-hd.mp3" },
          { url: "https://stream.radioabf.com/abf-sd.mp3" },
          { url: "https://stream.radioabf.com/abf-low.aac" },
          { url: "https://stream.radioabf.com/abf-uhd.flac" },
        ];

        S.audio = S.audio || new Audio();
        const audio = S.audio;
        audio.preload = "none";
        audio.crossOrigin = "anonymous";

        const $ = (id) => document.getElementById(id);

        // ========= ICONS (SVG) =========
        function setIcon(el, name){
          if (!el) return;

          const icons = {
            play: `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>`,
            pause:`<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 5v14M17 5v14"/></svg>`,
            stop: `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 7h10v10H7z"/></svg>`,
            volume:`<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M11 5 6 9H3v6h3l5 4z"/><path d="M15 9a4 4 0 0 1 0 6"/><path d="M17 7a7 7 0 0 1 0 10"/></svg>`,
            mute: `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M11 5 6 9H3v6h3l5 4z"/><path d="M16 9l5 6"/><path d="M21 9l-5 6"/></svg>`,
            fs:   `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8 3H3v5"/><path d="M16 3h5v5"/><path d="M8 21H3v-5"/><path d="M16 21h5v-5"/></svg>`,
          };

          el.innerHTML = icons[name] || "";
        }

        function initIcons(){
          document.querySelectorAll(".abf-ic").forEach((slot) => {
            const name = slot.getAttribute("data-ic") || "";
            setIcon(slot, name);
          });
        }

        S.lastBeat = S.lastBeat || 0;
        S.__beat = S.__beat || { ema: 0, ema2: 0, last: 0 };
        S.__viz = S.__viz || { raf: 0, canvas: null, ctx: null, dpr: 1, w: 0, h: 0 };
        S.__fs = S.__fs || { active: false };

        function fmtApply(){
          try { window.ABF_FMT?.apply(document); } catch {}
        }

        function setStatus(text){
          const a = $("npStatus");
          const b = $("npStatusMobile");
          if (a) a.textContent = text;
          if (b) b.textContent = text;
          const fsStatus = $("fsStatus");
          if (fsStatus) fsStatus.textContent = text;
        }

        function pulseLogo(){
          const logo = document.getElementById("abfBrandLogo");
          if (!logo) return;
          logo.classList.remove("abf-beat");
          void logo.offsetWidth;
          logo.classList.add("abf-beat");
          logo.addEventListener("animationend", () => {
            logo.classList.remove("abf-beat");
          }, { once: true });
        }

        // ========= LIVE TAB TITLE + FAVICON (animated) =========
        function ensureTabFx(){
          if (S.__tabFx) return S.__tabFx;

          const state = {
            baseTitle: document.title || "RadioABF",
            titleTimer: 0,
            favTimer: 0,
            favFlip: false,
            liveText: "",
            liveOn: false,
            lastFavHref: ""
          };

          const svgNormal =
            "data:image/svg+xml," +
            encodeURIComponent(`
              <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64">
                <defs>
                  <radialGradient id="g" cx="30%" cy="25%" r="75%">
                    <stop offset="0" stop-color="#2FC2FF" stop-opacity="0.9"/>
                    <stop offset="1" stop-color="#050B14" stop-opacity="1"/>
                  </radialGradient>
                </defs>
                <rect width="64" height="64" rx="16" fill="url(#g)"/>
                <path d="M18 39c7-13 12-15 28-14" fill="none" stroke="white" stroke-opacity="0.95" stroke-width="5" stroke-linecap="round"/>
              </svg>
            `);

          const svgLive =
            "data:image/svg+xml," +
            encodeURIComponent(`
              <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64">
                <defs>
                  <radialGradient id="g" cx="30%" cy="25%" r="75%">
                    <stop offset="0" stop-color="#2FC2FF" stop-opacity="0.9"/>
                    <stop offset="1" stop-color="#050B14" stop-opacity="1"/>
                  </radialGradient>
                </defs>
                <rect width="64" height="64" rx="16" fill="url(#g)"/>
                <path d="M18 39c7-13 12-15 28-14" fill="none" stroke="white" stroke-opacity="0.95" stroke-width="5" stroke-linecap="round"/>
                <circle cx="50" cy="14" r="7" fill="#EF4444"/>
              </svg>
            `);

          function getFaviconEl(){
            return document.getElementById("abfFavicon");
          }

          function setFavicon(href){
            const el = getFaviconEl();
            if (!el) return;
            if (state.lastFavHref === href) return;
            el.setAttribute("href", href);
            state.lastFavHref = href;
          }

          function stopAll(){
            state.liveOn = false;
            state.liveText = "";
            if (state.titleTimer){ clearInterval(state.titleTimer); state.titleTimer = 0; }
            if (state.favTimer){ clearInterval(state.favTimer); state.favTimer = 0; }
            document.title = state.baseTitle;
            setFavicon(svgNormal);
          }

          function startAll(text){
            state.liveOn = true;
            state.liveText = String(text || "").trim();
            if (!state.liveText) return stopAll();

            const pad = "   ‚Ä¢   ";
            const s = state.liveText + pad;
            let i = 0;

            if (!state.titleTimer){
              state.titleTimer = setInterval(() => {
                const view = s.slice(i) + s.slice(0, i);
                document.title = view;
                i = (i + 1) % s.length;
              }, 220);
            }

            if (!state.favTimer){
              state.favFlip = false;
              setFavicon(svgLive);
              state.favTimer = setInterval(() => {
                state.favFlip = !state.favFlip;
                setFavicon(state.favFlip ? svgLive : svgNormal);
              }, 520);
            }
          }

          function update(isLive, artist, title){
            const a = String(artist || "").trim();
            const t = String(title || "").trim();

            if (!isLive || !a || !t){
              stopAll();
              return;
            }

            const A = (window.ABF_FMT?.artist?.(a) || a);
            const T = (window.ABF_FMT?.title?.(t) || t);
            const txt = `üî¥ LIVE ‚Ä¢ ${A} ‚Äî ${T} | RadioABF`;

            if (state.liveOn && state.liveText === txt) {
              setFavicon(state.favFlip ? svgLive : svgNormal);
              return;
            }

            stopAll();
            startAll(txt);
          }

          setFavicon(svgNormal);

          S.__tabFx = { update, stopAll, state };
          return S.__tabFx;
        }

        function refreshTabFxAfterSwap(){
          const fx = ensureTabFx();
          fx.state.baseTitle = document.title || fx.state.baseTitle;
          const artist = document.getElementById("npArtist")?.textContent || "";
          const title  = document.getElementById("npTitle")?.textContent || "";
          fx.update(isLiveNow(), artist, title);
        }

        function resetTabOnNav(){
          const fx = ensureTabFx();
          fx.state.baseTitle = document.title || fx.state.baseTitle;
          fx.stopAll();
        }

        // ========= AUDIO GRAPH =========
        let audioCtx, analyser, freqData, timeData, sourceNode;

        function ensureAudioGraph(){
          if (!audioCtx){
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048;
            sourceNode = audioCtx.createMediaElementSource(audio);
            sourceNode.connect(analyser);
            analyser.connect(audioCtx.destination);
            freqData = new Uint8Array(analyser.frequencyBinCount);
            timeData = new Uint8Array(analyser.frequencyBinCount);
          }
        }

        async function resumeAudioCtx(){
          try {
            if (audioCtx && audioCtx.state === "suspended") await audioCtx.resume();
          } catch {}
        }

        // ========= VISUALIZER (MAIN) =========
        function getCanvasAlive(){
          const c = document.getElementById("visualizerCanvas");
          if (!c) return null;
          if (!c.isConnected) return null;
          return c;
        }

        function bindCanvasIfNeeded(){
          const c = getCanvasAlive();
          if (!c) return false;
          if (S.__viz.canvas !== c){
            S.__viz.canvas = c;
            S.__viz.ctx = c.getContext("2d");
            S.__viz.w = 0;
            S.__viz.h = 0;
          }
          return true;
        }

        function resizeCanvasIfPossible(){
          const c = S.__viz.canvas;
          const ctx = S.__viz.ctx;
          if (!c || !ctx) return false;
          const rect = c.getBoundingClientRect();
          if (rect.width <= 2 || rect.height <= 2) return false;
          const dpr = window.devicePixelRatio || 1;
          const w = Math.max(1, Math.floor(rect.width * dpr));
          const h = Math.max(1, Math.floor(rect.height * dpr));
          if (w !== S.__viz.w || h !== S.__viz.h || dpr !== S.__viz.dpr){
            S.__viz.dpr = dpr;
            S.__viz.w = w;
            S.__viz.h = h;
            c.width = w;
            c.height = h;
          }
          return true;
        }

        function stopVisualizer(){
          if (S.__viz.raf){
            cancelAnimationFrame(S.__viz.raf);
            S.__viz.raf = 0;
          }
          const c = getCanvasAlive();
          if (c){
            const ctx = c.getContext("2d");
            const rect = c.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            c.width = Math.max(1, Math.floor(rect.width * dpr));
            c.height = Math.max(1, Math.floor(rect.height * dpr));
            ctx.fillStyle = "#050B14";
            ctx.fillRect(0,0,c.width,c.height);
          }
        }

        function draw(){
          S.__viz.raf = requestAnimationFrame(draw);
          if (!bindCanvasIfNeeded()) return;
          if (!resizeCanvasIfPossible()) return;
          if (!analyser || !freqData || !timeData) return;

          const canvas = S.__viz.canvas;
          const vctx = S.__viz.ctx;
          const W = canvas.width;
          const H = canvas.height;

          vctx.fillStyle = "#050B14";
          vctx.fillRect(0, 0, W, H);

          analyser.getByteFrequencyData(freqData);

          const targetBarWidth = 7;
          const barCount = Math.max(1, Math.floor(W / targetBarWidth));
          const realBarWidth = W / barCount;

          for (let i = 0; i < barCount; i++) {
            const x = i * realBarWidth;
            const freqIndex = Math.floor((i / barCount) * freqData.length);
            const v = (freqData[freqIndex] || 0) / 255;
            const vv = Math.pow(v, 1.1);
            const hh = vv * H;
            const y = H - hh;
            const g = vctx.createLinearGradient(0, y, 0, H);
            g.addColorStop(0, "rgba(47,194,255,0.95)");
            g.addColorStop(1, "rgba(20,92,143,0.85)");
            vctx.fillStyle = g;
            vctx.fillRect(Math.floor(x), y, Math.ceil(realBarWidth), hh);
          }

          vctx.fillStyle = "rgba(20,92,143,0.85)";
          vctx.fillRect(W - 1, 0, 1, H);

          // Beat detection (logo pulse)
          let bassEnergy = 0;
          const bassBinCount = Math.max(10, Math.floor(analyser.frequencyBinCount * 0.04));
          for (let i = 0; i < bassBinCount; i++) bassEnergy += freqData[i];
          bassEnergy /= bassBinCount;

          const now = Date.now();
          const B = (S.__beat = S.__beat || { ema: 0, ema2: 0, last: 0 });
          const alpha = 0.08;

          B.ema = (B.ema || bassEnergy) * (1 - alpha) + bassEnergy * alpha;
          B.ema2 = (B.ema2 || bassEnergy * bassEnergy) * (1 - alpha) + (bassEnergy * bassEnergy) * alpha;

          const variance = Math.max(0, B.ema2 - B.ema * B.ema);
          const std = Math.sqrt(variance);

          const rising = bassEnergy - (B.last || bassEnergy);
          const threshold = Math.max(B.ema + 1.05 * std, 62);
          const cooldown = 120;
          const since = now - (S.lastBeat || 0);

          const strongBeat = (bassEnergy > threshold && rising > 3 && since > cooldown);
          const fallbackBeat = (since > 900 && bassEnergy > Math.max(B.ema + 0.6 * std, 75));

          if (strongBeat || fallbackBeat){
            pulseLogo();
            S.lastBeat = now;
          }

          B.last = bassEnergy;

          // waveform overlay
          analyser.getByteTimeDomainData(timeData);
          vctx.beginPath();
          const n = timeData.length;
          for (let i = 0; i < n; i++) {
            const v = timeData[i] / 128.0;
            const y = (v * H) / 2;
            const x = (n === 1) ? 0 : (i * (W / (n - 1)));
            if (i === 0) vctx.moveTo(x, y);
            else vctx.lineTo(x, y);
          }
          vctx.lineWidth = 5;
          vctx.strokeStyle = "rgba(47,194,255,0.25)";
          vctx.stroke();
          vctx.lineWidth = 2.5;
          vctx.strokeStyle = "rgba(255,255,255,0.95)";
          vctx.stroke();
        }

        function isMainCanvasAlive(){
          return !!(S.__viz.canvas && S.__viz.canvas.isConnected);
        }

        function startVisualizer(){
          ensureAudioGraph();
          if (S.__viz.raf && !isMainCanvasAlive()){
            cancelAnimationFrame(S.__viz.raf);
            S.__viz.raf = 0;
            S.__viz.canvas = null;
            S.__viz.ctx = null;
            S.__viz.w = 0;
            S.__viz.h = 0;
          }
          if (!S.__viz.raf){
            bindCanvasIfNeeded();
            resizeCanvasIfPossible();
            draw();
          }
        }

        function ensureVisualizerReady(){
          const start = performance.now();
          const maxMs = 1400;
          const tick = async () => {
            if (audio.paused) return;
            ensureAudioGraph();
            await resumeAudioCtx();
            bindCanvasIfNeeded();
            const ok = resizeCanvasIfPossible();
            if (!ok){
              if (performance.now() - start < maxMs) requestAnimationFrame(tick);
              return;
            }
            startVisualizer();
          };
          requestAnimationFrame(tick);
        }

        // ========= COVERS (SERVER SOURCE) =========
        function setPlayerCover(url) {
          const img = $("playerCover");
          const fb = $("playerCoverFallback");
          if (!img) return;

          img.onerror = () => {
            img.removeAttribute("src");
            img.classList.add("hidden");
            if (fb) fb.style.display = "";
          };

          if (url) {
            img.src = url;
            img.classList.remove("hidden");
            if (fb) fb.style.display = "none";
          } else {
            img.removeAttribute("src");
            img.classList.add("hidden");
            if (fb) fb.style.display = "";
          }
        }

        function setFsCover(url){
          const img = $("fsCover");
          const fb = $("fsCoverFallback");
          if (!img) return;

          img.onerror = () => {
            img.removeAttribute("src");
            img.classList.add("hidden");
            if (fb) fb.style.display = "";
          };

          if (url){
            img.src = url;
            img.classList.remove("hidden");
            if (fb) fb.style.display = "none";
          } else {
            img.removeAttribute("src");
            img.classList.add("hidden");
            if (fb) fb.style.display = "";
          }
        }

        // ========= SERVER NOW PLAYING =========
        async function fetchServerNowPlaying(limit = 12){
          try{
            const res = await fetch(`/api/nowplaying?limit=${limit}`, { cache: "no-store" });
            const data = await res.json().catch(()=> ({}));
            if (!data?.ok) return { now: null, history: [] };
            return { now: data.now || null, history: Array.isArray(data.history) ? data.history : [] };
          }catch{
            return { now: null, history: [] };
          }
        }

        async function fetchNowPlaying() {
          try {
            const { now, history } = await fetchServerNowPlaying(12);

            const artist = String(now?.artist || "").trim();
            const title = String(now?.title || "").trim();
            const full = String(now?.raw || "").trim() || (artist || title ? `${artist} - ${title}`.trim() : "");

            const a = $("npArtist");
            const t = $("npTitle");

            if (a) a.textContent = artist || "‚Äî";
            if (t) t.textContent = title || (full || "‚Äî");

            fmtApply();

            // ‚úÖ cover from API (Directus assets)
            const coverUrl = String(now?.cover_url || "").trim();
            setPlayerCover(coverUrl);

            if (S.__fs?.active) syncFullscreenUI();

            const played_at_ms_now =
              Number(now?.played_at_ms) || (now?.played_at ? new Date(now.played_at).getTime() : Date.now());

            const payload = {
              ok: true,
              now: {
                raw: full,
                artist,
                title,
                track_key: now?.track_key || "",
                played_at: now?.played_at || "",
                played_at_ms: played_at_ms_now,
                cover_url: coverUrl
              },
              history: (history || []).map((row) => ({
                raw: row?.raw || `${row?.artist || ""} - ${row?.title || ""}`.trim(),
                artist: row?.artist || "",
                title: row?.title || "",
                track_key: row?.track_key || "",
                played_at: row?.played_at || "",
                played_at_ms: Number(row?.played_at_ms) || (row?.played_at ? new Date(row.played_at).getTime() : 0),
                cover_url: String(row?.cover_url || "").trim()
              }))
            };

            S.__nowplaying = payload;
            try { window.dispatchEvent(new CustomEvent("abf:nowplaying-updated", { detail: payload })); } catch {}
            try { window.dispatchEvent(new CustomEvent("abf:history-updated", { detail: payload })); } catch {}

            const fx = ensureTabFx();
            fx.update(isLiveNow(), artist, title);
          } catch {
            const a = $("npArtist");
            const t = $("npTitle");
            if (a) a.textContent = "‚Äî";
            if (t) t.textContent = "‚Äî";
            setPlayerCover("");
            fmtApply();
            if (S.__fs?.active) syncFullscreenUI();

            const fx = ensureTabFx();
            fx.update(false, "", "");
          }
        }

        function setStream(index) {
          const safe = Math.max(0, Math.min(S.streams.length - 1, index));
          S.currentStreamIndex = safe;
          try { localStorage.setItem(LS_KEY, String(safe)); } catch {}
          audio.src = S.streams[safe].url;
          audio.load();
        }

        function isLiveNow(){
          return !S.isStopped && !audio.paused;
        }

        function computeStatus(){
          if (S.isStopped) return "stopped";
          if (audio.paused) return "paused";
          if (audio.muted || audio.volume <= 0.0001) return "muted";
          return "live";
        }

        function syncFullscreenUI(){
          const fa = $("fsArtist");
          const ft = $("fsTitle");
          const fsStatus = $("fsStatus");
          const fsPlay = $("fsPlay");
          const fsMute = $("fsMute");
          const fsVol = $("fsVol");
          const fsSel = $("fsStreamSelect");

          if (fa) fa.textContent = $("npArtist")?.textContent || "‚Äî";
          if (ft) ft.textContent = $("npTitle")?.textContent || "‚Äî";
          if (fsStatus) fsStatus.textContent = computeStatus();

          const fsPlayIc = fsPlay?.querySelector(".abf-ic");
          const fsMuteIc = fsMute?.querySelector(".abf-ic");
          setIcon(fsPlayIc, audio.paused ? "play" : "pause");
          setIcon(fsMuteIc, audio.muted ? "mute" : "volume");

          if (fsVol) fsVol.value = String(audio.volume);
          if (fsSel) {
            let idx = 0;
            try { idx = Number(localStorage.getItem(LS_KEY) || 0); } catch {}
            fsSel.value = String(S.currentStreamIndex ?? idx);
          }

          const pCover = $("playerCover");
          const pSrc = pCover?.getAttribute("src") || "";
          setFsCover(pSrc || "");

          fmtApply();
        }

        function openFullscreen(){
          const o = $("fsOverlay");
          if (!o) return;
          S.__fs.active = true;
          o.classList.remove("hidden");
          o.setAttribute("aria-hidden", "false");
          document.documentElement.style.overflow = "hidden";
          syncFullscreenUI();
          ensureAudioGraph();
          resumeAudioCtx?.();
        }

        function closeFullscreen(){
          const o = $("fsOverlay");
          if (!o) return;
          S.__fs.active = false;
          o.classList.add("hidden");
          o.setAttribute("aria-hidden", "true");
          document.documentElement.style.overflow = "";
        }

        function syncUI(){
          const playBtn = $("playBtn");
          const muteBtn = $("muteBtn");

          const playIc = playBtn?.querySelector(".abf-ic");
          const muteIc = muteBtn?.querySelector(".abf-ic");
          setIcon(playIc, audio.paused ? "play" : "pause");
          setIcon(muteIc, audio.muted ? "mute" : "volume");

          setStatus(computeStatus());

          const fx = ensureTabFx();
          const artist = $("npArtist")?.textContent || "";
          const title = $("npTitle")?.textContent || "";
          fx.update(isLiveNow(), artist, title);

          if (S.__fs?.active) syncFullscreenUI();
        }

        function bindUI(){
          initIcons();

          const playBtn = $("playBtn");
          const stopBtn = $("stopBtn");
          const muteBtn = $("muteBtn");
          const vol = $("volRange");
          const selDesk = $("streamSelect");
          const selMob = $("streamSelectMobile");
          const fsBtn = $("fsBtn");
          const fsClose = $("fsClose");
          const fsPlay = $("fsPlay");
          const fsStop = $("fsStop");
          const fsMute = $("fsMute");
          const fsVol = $("fsVol");
          const fsSel = $("fsStreamSelect");

          if (!playBtn || !stopBtn || !muteBtn || !vol || !selMob) return;

            if (!audio.src){
            let idx = 0;
            try { idx = Number(localStorage.getItem(LS_KEY) || 0); } catch {}
            
            // D√©tection mobile : force Low Data (index 2 = AAC+ 32kbps) au premier lancement

            const isMobile = window.innerWidth < 768 || /Mobi|Android|iPhone|iPad|iPod/.test(navigator.userAgent);
            if (isMobile && localStorage.getItem(LS_KEY) === null) {
              idx = 2; // Low Data en premier sur mobile
            }
            
            setStream(idx);
          }

          const savedVol = (() => {
            try { return Number(localStorage.getItem(VOL_KEY) || "0.8"); } catch { return 0.8; }
          })();
          audio.volume = Math.max(0, Math.min(1, savedVol));
          vol.value = String(audio.volume);
          if (fsVol) fsVol.value = String(audio.volume);

          const syncSelectValues = () => {
            let idx = 0;
            try { idx = Number(localStorage.getItem(LS_KEY) || 0); } catch {}
            const v = String(S.currentStreamIndex ?? idx);
            if (selDesk) selDesk.value = v;
            if (selMob) selMob.value = v;
            if (fsSel) fsSel.value = v;
          };
          syncSelectValues();

          if (!S.__npTimer){
            fetchNowPlaying();
            S.__npTimer = setInterval(fetchNowPlaying, 10000);
          }

          if (!S.__bound){
            audio.addEventListener("play", async () => {
              ensureAudioGraph();
              await resumeAudioCtx();
              startVisualizer();
              ensureVisualizerReady();
              syncUI();
            });

            audio.addEventListener("pause", () => {
              stopVisualizer();
              syncUI();
            });

            audio.addEventListener("volumechange", syncUI);
            S.__bound = true;
          }

          playBtn.onclick = async () => {
            if (!audio.paused){
              audio.pause();
              S.isStopped = false;
            } else {
              S.isStopped = false;
              audio.load();
              try { await audio.play(); } catch(e){ console.error(e); }
            }
            syncUI();
          };

          stopBtn.onclick = () => {
            audio.pause();
            S.isStopped = true;
            stopVisualizer();
            S.__beat = { ema: 0, ema2: 0, last: 0 };
            syncUI();
          };

          muteBtn.onclick = () => {
            audio.muted = !audio.muted;
            syncUI();
          };

          vol.oninput = (e) => {
            audio.volume = Number(e.target.value);
            try { localStorage.setItem(VOL_KEY, String(audio.volume)); } catch {}
            if (fsVol) fsVol.value = String(audio.volume);
            syncUI();
          };

          const onChangeStream = async (v) => {
            const wasPlaying = !audio.paused && !S.isStopped;
            setStream(Number(v));
            fetchNowPlaying();
            syncSelectValues();
            if (wasPlaying){
              audio.load();
              try { await audio.play(); } catch(e){ console.error(e); }
            }
            ensureVisualizerReady();
            syncUI();
          };

          if (selDesk) selDesk.onchange = (e) => onChangeStream(e.target.value);
          if (selMob) selMob.onchange = (e) => onChangeStream(e.target.value);

          if (fsBtn) fsBtn.onclick = () => openFullscreen();
          if (fsClose) fsClose.onclick = () => closeFullscreen();

          if (fsPlay) fsPlay.onclick = () => { $("playBtn")?.click(); syncFullscreenUI(); };
          if (fsStop) fsStop.onclick = () => { $("stopBtn")?.click(); syncFullscreenUI(); };
          if (fsMute) fsMute.onclick = () => { $("muteBtn")?.click(); syncFullscreenUI(); };

          if (fsVol) fsVol.oninput = (e) => {
            audio.volume = Number(e.target.value);
            try { localStorage.setItem(VOL_KEY, String(audio.volume)); } catch {}
            syncUI();
            syncFullscreenUI();
          };

          if (fsSel) fsSel.onchange = (e) => {
            const v = e.target.value;
            if (selDesk) { selDesk.value = v; selDesk.dispatchEvent(new Event("change")); }
            if (selMob) { selMob.value = v; selMob.dispatchEvent(new Event("change")); }
            syncFullscreenUI();
          };

          if (!S.__escBound){
            document.addEventListener("keydown", (e) => {
              if (e.key === "Escape") closeFullscreen();
            });
            S.__escBound = true;
          }

          fmtApply();
          syncUI();
        }

        ensureTabFx();
        bindUI();

        const onAstroNav = () => {
          S.__fs.active = false;
          closeFullscreen();
          resetTabOnNav();

          bindUI();
          fetchNowPlaying();
          window.__abfUpdateLayout?.();

          if (!audio.paused){
            ensureVisualizerReady();
            requestAnimationFrame(() => ensureVisualizerReady());
            setTimeout(() => ensureVisualizerReady(), 120);
          }

          syncUI();
          fmtApply();
        };

        document.addEventListener("astro:page-load", onAstroNav);
        document.addEventListener("astro:after-swap", onAstroNav);
        document.addEventListener("astro:page-load", refreshTabFxAfterSwap);
        document.addEventListener("astro:after-swap", refreshTabFxAfterSwap);

        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible" && !audio.paused) ensureVisualizerReady();
        });

        window.addEventListener("pageshow", () => {
          if (!audio.paused) ensureVisualizerReady();
        });

        window.addEventListener("resize", () => {
          if (!audio.paused) ensureVisualizerReady();
        });

        // ========= PURGE OPTION (clears old local keys + consent) =========
        function purgeClientStorage(){
          try {
            const keys = [
              "abf_covers_v1",         // legacy
              "abf_history",           // legacy
              "abf_stream_index",
              "abf_volume",
              "abf_remind_next_show"   // home reminder
            ];
            for (const k of keys) localStorage.removeItem(k);
          } catch {}

          // remove consent cookie
          try {
            document.cookie = `${CONSENT_COOKIE}=; Max-Age=0; Path=/; SameSite=Lax`;
          } catch {}

          // best-effort: stop GA if loaded (doesn't fully unload script, but stops new config)
          try {
            gtag('consent', 'update', { analytics_storage: 'denied', ad_storage: 'denied' });
          } catch {}

          // UI refresh
          try { window.location.reload(); } catch {}
        }

        // expose for other scripts/buttons
        window.__abfPurge = purgeClientStorage;
      })();
    </script>

    <!-- ================= FOOTER ================= -->
    <footer id="siteFooter" class="fixed bottom-0 left-0 right-0 z-40 bg-[#050B14]/80 backdrop-blur-xl border-t border-white/10">
      <div class="mx-auto max-w-6xl px-4 sm:px-6 py-3 flex flex-col md:flex-row justify-between items-center gap-4 text-xs text-white/60">
        <div class="text-center md:text-left">
          ¬© 2026 Radio ABF - Alternative Bass Fr√©quence | The DJs' Frequency | www.radioabf.com
        </div>

        <div class="flex items-center gap-3 flex-wrap justify-center">
          <button id="openBuild" type="button" class="abfFooterLinkBtn" aria-label="Open build updates" title="Build / Updates">
            Build <span id="buildVersion" class="text-cyan-200/90 font-semibold">‚Äî</span>
          </button>

        <button id="openLegal" type="button" class="abfFooterLinkBtn" aria-label="Open legal notices" title="Legal notices">
			Legal
		</button>

          <button id="openCookies" type="button" class="abfFooterLinkBtn" aria-label="Cookie preferences" title="Cookies">
            Cookies
          </button>

          <button id="purgeBtn" type="button" class="abfFooterLinkBtn" aria-label="Purge local data" title="Purge local data">
            Purge
          </button>

          <div class="h-5 w-px bg-white/10 hidden sm:block"></div>

          <a href="https://x.com/abfonair" target="_blank" rel="noopener noreferrer" aria-label="X / Twitter" class="text-white/60 hover:text-cyan-300 transition">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
          </a>

          <a href="https://www.instagram.com/abfonair/" target="_blank" rel="noopener noreferrer" aria-label="Instagram" class="text-white/60 hover:text-cyan-300 transition">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.919-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98C23.986 15.668 24 15.259 24 12c0-3.259-.014-3.668-.072-4.948-.2-4.358-2.618-6.78-6.98-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 100 12.324 6.162 6.162 0 000-12.324zm0 10.162a4 4 0 110-8 4 4 0 010 8zm6.406-11.845a1.44 1.44 0 11-2.88 0 1.44 1.44 0 012.88 0z"/>
            </svg>
          </a>

          <a href="https://www.facebook.com/abfonair" target="_blank" rel="noopener noreferrer" aria-label="Facebook" class="text-white/60 hover:text-cyan-300 transition">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.67 4.533-4.67 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
          </a>

          <a href="https://www.tiktok.com/@abfonair" target="_blank" rel="noopener noreferrer" aria-label="TikTok" class="text-white/60 hover:text-cyan-300 transition">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M12.53.02C13.84 0 15.14 0 16.44.02c.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v3.04c-1.71-.01-3.45-.51-4.68-1.74-.33-.33-.63-.68-.89-1.05-.18-.25-.36-.51-.51-.78-.06-.1-.12-.19-.17-.29-.09-.15-.17-.3-.25-.45-.08-.14-.15-.28-.22-.42-.07-.13-.13-.27-.19-.41-.06-.13-.11-.26-.16-.4-.05-.13-.09-.27-.13-.4-.04-.13-.07-.26-.11-.39-.03-.12-.06-.25-.09-.37-.03-.11-.05-.22-.07-.33-.01-.05-.02-.1-.03-.15-.01-.05-.02-.1-.02-.15v-.01h-3.91v9.09c.01 2.22-1.8 4.02-4.02 4.03-2.22.01-4.02-1.8-4.03-4.02-.01-2.22 1.8-4.02 4.02-4.03.96-.01 1.87.32 2.59 1.02v3.51c-.72-.68-1.62-1.08-2.59-1.07-3.34.01-6.05 2.72-6.04 6.06.01 3.34 2.72 6.05 6.06 6.04 3.34-.01 6.05-2.72 6.04-6.06V7.63c1.32 1.07 2.91 1.68 4.59 1.68 1.68 0 3.27-.62 4.47-1.74 1.2-1.12 1.86-2.62 1.85-4.2v-.01h.01z"/>
            </svg>
          </a>

          <a href="https://www.youtube.com/@abfonair" target="_blank" rel="noopener noreferrer" aria-label="YouTube" class="text-white/60 hover:text-cyan-300 transition">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.75 15.02V8.98l6.25 3.01-6.25 3.01z"/>
            </svg>
          </a>
        </div>
      </div>
    </footer>

    <!-- ================= MODALS + BUILD DATA + PURGE + COOKIE CONSENT ================= -->
    <script is:inline data-astro-rerun>
      (() => {
        const buildModal = document.getElementById("buildModal");
        const legalModal = document.getElementById("legalModal");
        const cookiesModal = document.getElementById("cookiesModal");

        const openBuild = document.getElementById("openBuild");
        const openLegal = document.getElementById("openLegal");
        const openCookies = document.getElementById("openCookies");
        const purgeBtn = document.getElementById("purgeBtn");

        const buildClose = document.getElementById("buildClose");
        const legalClose = document.getElementById("legalClose");
        const cookiesClose = document.getElementById("cookiesClose");

        const buildList = document.getElementById("buildList");
        const buildVersion = document.getElementById("buildVersion");

        if (!buildModal || !legalModal || !cookiesModal || !openBuild || !buildClose || !buildList || !buildVersion) return;

        // Build / Updates (latest first) ‚Äî Feb 2026
        const BUILDS = [
  {
  v: "3.3.3",
  d: "Feb 19, 2026",
  t: "Directus-first cover system implemented. Top charts and Music page now prioritize manual cover uploads with lock support. Vote API enriched and legacy cover cache removed."
  },
  {
  v: "3.3.2",
  d: "Feb 18, 2026",
  t: "Added complete Dedications feature: submission modal, Directus integration, marquee scrolling, feedback UI and badge. Improved marquee with 10√ó text duplication and reflow fix for long messages."
  },		
  {
    v: "3.3.1",
    d: "Feb 17, 2026",
    t: "HTTPS Proxy Streams rollout: stable fixed HTTPS endpoints for all qualities (UHD FLAC, HD 320k MP3, SD 128k MP3, Low 32k AAC+). Bypass firewalls/corporate networks. Updated left mini-card with proxy info and \"Details & URLs\" button. Enhanced Stream Qualities modal with detailed explanations, external player instructions (VLC etc. per OS), and direct copy-paste URLs."
  },
  {
    v: "3.3.0",
    d: "Feb 16, 2026",
    t: "UI & UX refinements: fixed vote display and modal persistence on homepage (server-only covers, no local fallbacks), redesigned Artists page with all artist cards unified in a single large container card, moved filter buttons to hero section for cleaner layout and improved visual flow."
  },
  {
    v: "3.2.0",
    d: "Feb 16, 2026",
    t: "Infrastructure & data stabilization: full GitHub ‚Üí Vercel production deployment, Directus live integration hardened (SSR + cache headers), vote API normalization to prevent duplicate track keys, ABF CLUB vote restriction, improved weekly aggregation logic, cleaned and standardized Artists base (local assets + naming), and overall front/back sync reliability improvements."
  },
  {
    v: "3.1.0",
    d: "Feb 15, 2026",
    t: "Home + player stability milestone: Latest News now uses Directus SSR with Vercel cache headers, dates switched to English (US), improved On Air live detection + countdowns + stronger live highlight, Hero Top #1 weekly card added, and safer rebind after Astro page swaps (fullscreen/listeners). Minor UI polish across sections."
  },
  {
    v: "3.0.8",
    d: "Feb 14, 2026",
    t: "UI & stability fixes: fixed cover fallbacks (no broken-image square after navigation), adjusted ABF logo sizing in fallback blocks, reduced visual glitches during page swaps (player + covers), and improved card image ratio handling/centering."
  },
  {
    v: "3.0.7",
    d: "Feb 14, 2026",
    t: "Programs & On Air improvements: ensured Programs lands on the correct current day, restored On Air cues and improved current show highlight styling, tightened schedule cards while preserving artwork ratios, and reduced excess spacing under the pinned player / footer."
  },
  {
    v: "3.0.6",
    d: "Feb 13, 2026",
    t: "Fullscreen + view transitions fix: fullscreen now remains usable after navigation (re-initialized listeners after Astro swaps), improved player control stability across pages, and refined floating 'Back to top' button placement."
  },
  {
    v: "3.0.5",
    d: "Feb 13, 2026",
    t: "News routing + SEO: stabilized SSR dynamic news routes, added year filtering and cleaner /news listing grid, improved OG preview logic, and tuned Directus micro-cache + Vercel caching behavior."
  },
  {
    v: "3.0.4",
    d: "Feb 12, 2026",
    t: "Player UI refinement: made the bottom player more compact, restored missing controls (incl. volume) with clearer play/pause states, upgraded the visualizer to a thinner modern full-width style, and improved header pulse behavior consistency."
  },
  {
    v: "3.0.3",
    d: "Feb 12, 2026",
    t: "Music + charts UX: restored title-casing rules for readability, improved Last Played rendering consistency, and hardened weekly vote aggregation + cover usage."
  },
  {
    v: "3.0.2",
    d: "Feb 11, 2026",
    t: "Build system + modals: Build/Updates modal cleanup (dates aligned, better spacing), footer build version now reads dynamically from latest entry, and added/normalized Stream Quality + FLAC info modals."
  },
  {
    v: "3.0.1",
    d: "Feb 11, 2026",
    t: "Directus integration stabilization: safer handling of optional published_at, reduced unnecessary fallbacks where local assets exist, and general cleanup for deployment readiness."
  },
  {
    v: "3.0.0",
    d: "Feb 08, 2026",
    t: "Major redesign: new ABF UI system (modern cards, gradients, spacing), persistent pinned player architecture foundations, refreshed layout/navigation, and the first Home structure (Now Playing hero, Last Played carousel, schedule preview)."
  }
];

        const latest = BUILDS[0]?.v || "‚Äî";
        buildVersion.textContent = latest;
        window.__abfBuildVersion = latest;

        const esc = (s) => String(s || "")
          .replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;")
          .replace(/'/g,"&#039;");

        buildList.innerHTML = BUILDS.map(b => `
          <div class="buildItem">
            <div class="buildLeft">
              <div class="buildVer">v${esc(b.v)}</div>
              <div class="buildTxt">${esc(b.t)}</div>
            </div>
            <div class="buildDate">${esc(b.d)}</div>
          </div>
        `).join("");

        const lockScroll = (on) => { document.documentElement.style.overflow = on ? "hidden" : ""; };
        const open = (modal) => { modal.setAttribute("aria-hidden","false"); lockScroll(true); };
        const close = (modal) => { modal.setAttribute("aria-hidden","true"); lockScroll(false); };

        openBuild.onclick = () => open(buildModal);

        if (openLegal){
          openLegal.addEventListener("click", (e) => {
            e.preventDefault();
            open(legalModal);
          });
        }

        if (openCookies){
          openCookies.addEventListener("click", (e) => {
            e.preventDefault();
            open(cookiesModal);
          });
        }

        if (purgeBtn){
          purgeBtn.onclick = () => {
            if (confirm("Purge local data on this device? (volume, stream quality, reminders, consent)")) {
              window.__abfPurge?.();
            }
          };
        }

        buildClose.onclick = () => close(buildModal);
        if (legalClose) legalClose.onclick = () => close(legalModal);
        if (cookiesClose) cookiesClose.onclick = () => close(cookiesModal);

        document.addEventListener("click", (e) => {
          const t = e.target;
          if (t?.dataset?.close === "build") close(buildModal);
          if (t?.dataset?.close === "legal") close(legalModal);
          if (t?.dataset?.close === "cookies") close(cookiesModal);
        });

        document.addEventListener("keydown", (e) => {
          if (e.key !== "Escape") return;
          if (buildModal.getAttribute("aria-hidden") === "false") close(buildModal);
          if (legalModal.getAttribute("aria-hidden") === "false") close(legalModal);
          if (cookiesModal.getAttribute("aria-hidden") === "false") close(cookiesModal);
        });
      })();
    </script>

    <!-- ================= COOKIE CONSENT LOGIC (GA4) ================= -->
    <script is:inline data-astro-rerun>
      (() => {
        const GA_ID = "G-8KQY09E05H";
        const CONSENT_COOKIE = "abf_consent_v1"; // "a1" or "a0"

        const bar = document.getElementById("cookieBar");
        const btnAccept = document.getElementById("cookieAccept");
        const btnDecline = document.getElementById("cookieDecline");
        const btnManage = document.getElementById("cookieManage");

        const cookiesModal = document.getElementById("cookiesModal");
        const cookiesAccept = document.getElementById("cookiesAccept");
        const cookiesDecline = document.getElementById("cookiesDecline");
        const cookiesSave = document.getElementById("cookiesSave");
        const analyticsToggle = document.getElementById("analyticsToggle");

        function getCookie(name){
          const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([.$?*|{}()[\]\\/+^])/g, '\\$1') + '=([^;]*)'));
          return m ? decodeURIComponent(m[1]) : "";
        }

        function setCookie(name, value, days){
          const maxAge = Math.floor((days || 180) * 24 * 60 * 60);
          document.cookie = `${name}=${encodeURIComponent(value)}; Max-Age=${maxAge}; Path=/; SameSite=Lax`;
        }

        function showBar(){
          if (!bar) return;
          bar.classList.remove("hidden");
          bar.setAttribute("aria-hidden", "false");
        }

        function hideBar(){
          if (!bar) return;
          bar.classList.add("hidden");
          bar.setAttribute("aria-hidden", "true");
        }

        function setToggle(on){
          if (!analyticsToggle) return;
          analyticsToggle.setAttribute("data-on", on ? "true" : "false");
        }

        function readConsent(){
          const v = getCookie(CONSENT_COOKIE);
          if (v === "a1") return true;
          if (v === "a0") return false;
          return null;
        }

        function ensureGaLoaded(){
          if (window.__abfGaLoaded) return;
          window.__abfGaLoaded = true;

          const s = document.createElement("script");
          s.async = true;
          s.src = `https://www.googletagmanager.com/gtag/js?id=${encodeURIComponent(GA_ID)}`;
          document.head.appendChild(s);

          // init when loaded
          window.dataLayer = window.dataLayer || [];
          function gtag(){ dataLayer.push(arguments); }
          window.gtag = window.gtag || gtag;

          gtag('js', new Date());
          gtag('config', GA_ID, {
            send_page_view: true,
            anonymize_ip: true
          });
        }

        function applyConsent(analyticsOn){
          try {
            gtag('consent', 'update', {
              ad_storage: 'denied',
              analytics_storage: analyticsOn ? 'granted' : 'denied',
              functionality_storage: 'granted',
              security_storage: 'granted'
            });
          } catch {}

          if (analyticsOn) ensureGaLoaded();
        }

        function saveConsent(analyticsOn){
          setCookie(CONSENT_COOKIE, analyticsOn ? "a1" : "a0", 180);
          applyConsent(analyticsOn);
          hideBar();
        }

        // initial
        const initial = readConsent();
        if (initial === null){
          showBar();
          setToggle(false);
          applyConsent(false); // default denied
        } else {
          setToggle(!!initial);
          applyConsent(!!initial);
          hideBar();
        }

        // banner buttons
        if (btnAccept) btnAccept.onclick = () => saveConsent(true);
        if (btnDecline) btnDecline.onclick = () => saveConsent(false);
        if (btnManage && cookiesModal){
          btnManage.onclick = () => {
            setToggle(readConsent() === true);
            cookiesModal.setAttribute("aria-hidden", "false");
            document.documentElement.style.overflow = "hidden";
          };
        }

        // modal logic (toggle + save)
        if (analyticsToggle){
          analyticsToggle.onclick = () => {
            const on = analyticsToggle.getAttribute("data-on") === "true";
            setToggle(!on);
          };
        }

        if (cookiesAccept) cookiesAccept.onclick = () => {
          setToggle(true);
          saveConsent(true);
          // close modal if open
          if (cookiesModal){
            cookiesModal.setAttribute("aria-hidden","true");
            document.documentElement.style.overflow = "";
          }
        };

        if (cookiesDecline) cookiesDecline.onclick = () => {
          setToggle(false);
          saveConsent(false);
          if (cookiesModal){
            cookiesModal.setAttribute("aria-hidden","true");
            document.documentElement.style.overflow = "";
          }
        };

        if (cookiesSave) cookiesSave.onclick = () => {
          const on = analyticsToggle?.getAttribute("data-on") === "true";
          saveConsent(!!on);
          if (cookiesModal){
            cookiesModal.setAttribute("aria-hidden","true");
            document.documentElement.style.overflow = "";
          }
        };

        // When user clicks footer ‚ÄúCookies‚Äù, modal is opened by other script;
        // keep toggle in sync:
        document.addEventListener("click", (e) => {
          const t = e.target;
          if (!t) return;
          if (t.id === "openCookies"){
            setToggle(readConsent() === true);
          }
        });

        // allow purge to re-show banner
        window.__abfConsentReset = () => {
          try { document.cookie = `${CONSENT_COOKIE}=; Max-Age=0; Path=/; SameSite=Lax`; } catch {}
          applyConsent(false);
          showBar();
        };
      })();
    </script>

    <!-- ================= LAYOUT measure ================= -->
    <script is:inline data-astro-rerun>
      (() => {
        const footer = document.getElementById("siteFooter");
        const player = document.getElementById("playerContainer");
        if (!footer || !player) return;

        const apply = () => {
          const fh = footer.offsetHeight || 0;
          const ph = player.offsetHeight || 0;
          document.body.style.setProperty("--abf-footer-h", fh + "px");
          document.body.style.setProperty("--abf-player-h", ph + "px");
        };

        window.__abfUpdateLayout = apply;

        const ro = new ResizeObserver(apply);
        ro.observe(footer);
        ro.observe(player);

        apply();

        window.addEventListener("resize", apply);
        document.addEventListener("astro:page-load", apply);
        document.addEventListener("astro:after-swap", apply);
      })();
    </script>

    <!-- Back to top button -->
    <script is:inline data-astro-rerun>
      (() => {
        const btn = document.getElementById("backToTop");
        if (!btn) return;

        const update = () => {
          const y = window.scrollY || document.documentElement.scrollTop;
          if (y > 320) {
            btn.classList.remove("opacity-0", "pointer-events-none");
            btn.classList.add("opacity-100");
          } else {
            btn.classList.add("opacity-0", "pointer-events-none");
            btn.classList.remove("opacity-100");
          }
        };

        btn.onclick = () => window.scrollTo({ top: 0, behavior: "smooth" });

        window.addEventListener("scroll", update, { passive: true });
        window.addEventListener("resize", update);
        document.addEventListener("astro:page-load", update);
        document.addEventListener("astro:after-swap", update);

        update();
      })();
    </script>

    <div
      class="fixed left-0 right-0 z-[55] pointer-events-none"
      style="bottom: calc(var(--abf-footer-h) + var(--abf-player-h) + 20px);"
    >
      <div class="mx-auto max-w-6xl px-4 sm:px-6 flex justify-end">
        <button
          id="backToTop"
          type="button"
          aria-label="Back to top"
          class="pointer-events-auto
                 rounded-2xl border border-white/15
                 bg-[#050B14]/80 backdrop-blur-xl
                 w-12 h-12 flex items-center justify-center
                 text-white/80 hover:text-cyan-200
                 hover:bg-white/10 transition
                 shadow-xl shadow-black/40
                 opacity-0 pointer-events-none"
        >
          ‚Üë
        </button>
      </div>
    </div>
<script is:inline data-astro-rerun>
  (() => {
    const h = document.getElementById("siteHeader");
    const apply = () => document.documentElement.style.setProperty("--header-height", (h?.offsetHeight || 80) + "px");
    apply();
    document.addEventListener("astro:after-swap", apply);
    window.addEventListener("resize", apply);
  })();
</script>

</body>
<!-- ================= DEDICATION MODAL ================= -->
<div
  id="dedicationModal"
  class="hidden fixed inset-0 z-[80] flex items-center justify-center"
  aria-hidden="true"
>

  <!-- BACKDROP -->
  <div
    id="dedicationBackdrop"
    class="absolute inset-0 bg-black/70 backdrop-blur-md"
  ></div>

  <!-- CARD -->
  <div
    class="relative w-[min(760px,94vw)] rounded-3xl border border-white/10 bg-[#050B14]/95 shadow-2xl overflow-hidden"
  >

    <!-- HEADER -->
    <div class="flex items-center justify-between gap-3 px-6 py-4 border-b border-white/10 bg-white/5">
      <div class="text-xs uppercase tracking-wider text-white/70 font-extrabold">
        Send a dedication
      </div>

      <button
        id="closeDedicationModal"
        type="button"
        class="w-10 h-10 rounded-xl border border-white/15 bg-white/5 hover:bg-white/10 transition"
        aria-label="Close"
      >
        ‚úï
      </button>
    </div>

    <!-- FORM -->
    <form id="dedicationForm" class="p-6 space-y-4">

      <!-- NAME -->
      <div>
        <label class="block text-xs text-white/60 mb-2">
          Your name
        </label>
       <input
  id="dedName"
  name="name"
  type="text"
  maxlength="40"
  class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-cyan-400/40 transition"
  placeholder="Your name"
  required
/>

      </div>

      <!-- MESSAGE (AGRANDI) -->
      <div>
        <label class="block text-xs text-white/60 mb-2">
          Your message
        </label>

       <textarea
  id="dedMessage"
  name="message"
  maxlength="280"
  rows="5"
  class="w-full rounded-2xl border border-white/10 bg-white/5 px-4 py-3 text-sm outline-none focus:border-cyan-400/40 transition"
  placeholder="Your message"
  required
></textarea>


        <div class="text-[11px] text-white/40 mt-2">
          Max 300 characters.
        </div>
      </div>

      <!-- FEEDBACK -->
     <div
  id="dedicationFeedback"
  class="hidden text-sm font-medium transition-all"
></div>

      <!-- ACTIONS -->
      <div class="flex items-center justify-end gap-3 pt-2">

        <button
          id="dedCancel"
          type="button"
          class="px-5 py-3 rounded-2xl border border-white/15 bg-white/5 hover:bg-white/10 transition text-sm font-semibold"
        >
          Cancel
        </button>

        <button
          type="submit"
          class="px-6 py-3 rounded-2xl font-semibold bg-gradient-to-r from-[#145C8F] to-[#2FC2FF] shadow-lg shadow-cyan-500/25 hover:scale-[1.02] transition text-sm"
        >
          Send üé§
        </button>

      </div>

      <div class="text-xs text-white/45 pt-1">
        Your message will be sent as <b>draft</b> for moderation.
      </div>

    </form>

  </div>
</div>


</html>
