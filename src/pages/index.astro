---
import Base from "../layouts/Base.astro";
import { directusGet, directusAsset } from "../lib/directus";

export const prerender = false;

type NewsItem = {
  id: number;
  status: string;
  title: string;
  slug: string;
  excerpt?: string | null;
  cover?: string | null;
  published_at?: string | null;
  date_created?: string | null;
};

type DirectusResp = { data: NewsItem[] };

// DerniÃ¨res news (3)
const fields = "id,status,title,slug,excerpt,cover,published_at,date_created";
let latestNews: NewsItem[] = [];
try {
  const resp = await directusGet<DirectusResp>(
    `/items/news?fields=${encodeURIComponent(fields)}&filter[status][_eq]=published&sort=-published_at,-date_created&limit=3`
  );
  latestNews = resp?.data ?? [];
} catch {
  latestNews = [];
}

// Cache Vercel (home SSR)
Astro.response.headers.set(
  "Cache-Control",
  "public, s-maxage=180, stale-while-revalidate=86400"
);

const fmtDate = (iso?: string | null) => {
  if (!iso) return "";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "";
  return d.toLocaleDateString("en-US", {
    day: "2-digit",
    month: "long",
    year: "numeric",
  });
};

type Program = {
  id: string | number;
  title?: string | null;
  description?: string | null;
  cover?: string | null;
  status?: string | null;
};

type Occurrence = {
  id: string | number;
  status?: string | null;
  day_of_week?: string | null;
  start_time?: string | null;
  end_time?: string | null;
  is_live?: boolean | null;
  program?: Program | null;
};

type DirectusListResp<T> = { data: T[] };

const DAY_KEYS = ["mon","tue","wed","thu","fri","sat","sun"];

function safeStr(v: any): string {
  return typeof v === "string" ? v : v == null ? "" : String(v);
}
function normalizeDay(v: any): string {
  const s = safeStr(v).toLowerCase().trim();

  // DÃ©jÃ  au bon format
  if (["mon","tue","wed","thu","fri","sat","sun"].includes(s)) return s;

  // NumÃ©rique (string ou number)
  const n = Number(s);
  if (!Number.isNaN(n)) {
    // Support 1..7 (1=lun ... 7=dim)
    if (n === 1) return "mon";
    if (n === 2) return "tue";
    if (n === 3) return "wed";
    if (n === 4) return "thu";
    if (n === 5) return "fri";
    if (n === 6) return "sat";
    if (n === 7) return "sun";

    // Support 0..6 (0=dim ... 6=sam) au cas oÃ¹
    if (n === 0) return "sun";
    if (n === 1) return "mon";
    if (n === 2) return "tue";
    if (n === 3) return "wed";
    if (n === 4) return "thu";
    if (n === 5) return "fri";
    if (n === 6) return "sat";
  }

  // Texte long (au cas oÃ¹)
  if (s === "monday") return "mon";
  if (s === "tuesday") return "tue";
  if (s === "wednesday") return "wed";
  if (s === "thursday") return "thu";
  if (s === "friday") return "fri";
  if (s === "saturday") return "sat";
  if (s === "sunday") return "sun";

  return "";
}
function normalizeTimeFromDirectus(v: any): string {
  // Directus time usually: "18:00:00" â†’ we keep "18:00"
  const t = safeStr(v).trim();
  const m = t.match(/^(\d{2}):(\d{2})(?::\d{2})?$/);
  return m ? `${m[1]}:${m[2]}` : t;
}

function buildScheduleFromOccurrences(rows: Occurrence[]) {
  const schedule: Record<string, any[]> = { mon: [], tue: [], wed: [], thu: [], fri: [], sat: [], sun: [] };

  for (const row of rows || []) {
    const day = normalizeDay(row.day_of_week);
    if (!day) continue;

    const time = normalizeTimeFromDirectus(row.start_time) || "00:00";
    const p = row.program || null;

    const title = safeStr(p?.title) || "Untitled program";
    const desc  = safeStr(p?.description) || "";

    const coverId = safeStr(p?.cover);
    const imgUrl  = coverId ? directusAsset(coverId) : "";

    schedule[day].push({ time, img: imgUrl, title, desc });
  }

  return schedule;
}

let directusSchedule: Record<string, any[]> | null = null;

try {
  const fields =
    "id,status,day_of_week,start_time,end_time,is_live," +
    "program.id,program.status,program.title,program.description,program.cover";

  const resp = await directusGet<DirectusListResp<Occurrence>>(
    `/items/program_occurrences?fields=${encodeURIComponent(fields)}&filter[status][_eq]=published&filter[program][status][_eq]=published&limit=500&sort=day_of_week,start_time`
  );

  directusSchedule = buildScheduleFromOccurrences(resp?.data ?? []);
} catch (e) {
  console.error("[INDEX] Directus schedule fetch failed:", e);
  directusSchedule = null;
}
---

<Base title="Radio ABF â€” Alternative Bass FrÃ©quence | The DJs' Frequency">
  <!-- BIG NOW PLAYING HERO -->
  <section class="relative overflow-hidden rounded-3xl border border-white/10 bg-[#0A1F33] p-6 md:p-8 shadow-2xl">
    <!-- Background glow -->
    <div class="absolute -top-40 -left-40 w-[600px] h-[600px] bg-cyan-500/20 rounded-full blur-[120px]"></div>
    <div class="absolute -bottom-40 -right-40 w-[600px] h-[600px] bg-blue-600/20 rounded-full blur-[120px]"></div>

    <div class="relative z-10">
      <div class="flex items-center gap-3 mb-4 text-sm tracking-widest text-white/60 uppercase">
        <span class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></span>
        Now Playing
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-center">
        <!-- LEFT: Cover + Text -->
        <div class="lg:col-span-2 min-w-0">
          <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
            <!-- Medium Large Cover -->
            <div
              id="homeCoverWrapper"
              class="abfCover w-40 h-40 md:w-52 md:h-52 rounded-3xl border border-white/10 overflow-hidden flex-none shadow-xl transition-all duration-500"
            >
              <img id="homeCover" class="hidden" alt="Pochette actuelle" />
              <div class="abfCoverFallback">
                <img src="/logo-abf.png" alt="ABF" loading="lazy" decoding="async" />
              </div>
            </div>

            <!-- Text -->
            <div class="min-w-0">
              <div id="homeArtist" data-abf-artist class="text-2xl md:text-4xl font-extrabold leading-tight truncate">â€”</div>
              <div id="homeTitle" data-abf-title class="mt-1 text-white/70 text-base md:text-lg truncate">â€”</div>

              <div class="mt-4 flex gap-3 flex-wrap md:flex-nowrap">
                <button
                  id="jumpToPlayer"
                  type="button"
                  class="bg-gradient-to-r from-[#145C8F] to-[#2FC2FF]
                         px-5 py-2.5 rounded-xl text-sm font-semibold
                         shadow-md shadow-cyan-500/20
                         hover:scale-[1.02] transition whitespace-nowrap"
                >
                  Open player â†“
                </button>

                <a
                  href="/music"
                  class="border border-white/20 px-5 py-2.5 rounded-xl
                         text-sm text-white/80 hover:bg-white/5 transition whitespace-nowrap"
                >
                  Vote & charts
                </a>

                <a
                  href="/programs"
                  class="border border-white/20 px-5 py-2.5 rounded-xl
                         text-sm text-white/80 hover:bg-white/5 transition whitespace-nowrap"
                >
                  Programs
                </a>
              </div>

              <div class="mt-3 text-sm text-white/50">
                The player stays pinned at the bottom of the screen.
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT: Weekly minimal block (with #1) -->
        <div class="bg-white/5 border border-white/10 rounded-2xl p-6">
          <div class="text-sm text-white/50 uppercase tracking-wider mb-3">
            This week
          </div>

          <div class="space-y-3">
            <div class="flex items-center justify-between border-b border-white/5 pb-3">
              <div class="text-white/70 text-sm">Top voted tracks</div>
              <a class="text-cyan-300 hover:text-cyan-200 text-sm" href="/music">See â†’</a>
            </div>

            <!-- #1 dynamic -->
            <div id="heroTop1" class="rounded-2xl border border-white/10 bg-white/5 p-3 hidden">
              <div class="flex items-center gap-3">
                <div
                  id="heroTop1CoverWrap"
                  class="abfCover w-12 h-12 rounded-xl border border-white/10 overflow-hidden flex-none"
                >
                  <img id="heroTop1Cover" class="hidden" alt="" />
                  <div class="abfCoverFallback">
                    <img src="/logo-abf.png" alt="ABF" loading="lazy" decoding="async" />
                  </div>
                </div>

                <div class="min-w-0 flex-1">
                  <div class="text-xs text-white/50 uppercase tracking-wider">#1</div>
                  <div id="heroTop1Artist" data-abf-artist class="font-semibold text-sm truncate">â€”</div>
                  <div id="heroTop1Title" data-abf-title class="text-xs text-white/70 truncate">â€”</div>
                </div>
              </div>
            </div>

            <div id="heroTop1Empty" class="text-white/60 text-sm hidden">
              No votes yet â€” be the first ðŸ™‚
            </div>

            <div class="text-white/70 text-sm">
              Vote on tracks you love and shape the weekly chart.
            </div>

            <a
              href="/music"
              class="inline-flex items-center justify-center w-full
                     bg-gradient-to-r from-[#145C8F] to-[#2FC2FF]
                     px-5 py-3 rounded-xl font-semibold
                     shadow-lg shadow-cyan-500/25
                     hover:scale-[1.01] transition"
            >
              Vote now
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- LAST PLAYED (CAROUSEL) -->
  <section class="mt-8 bg-[#0A1F33] border border-white/10 rounded-2xl p-6">
    <div class="flex items-center justify-between gap-4 mb-4">
      <div class="text-sm text-white/50 uppercase tracking-wider">
        Last played
      </div>
      <a href="/music" class="text-cyan-300 hover:text-cyan-200 text-sm">
        Full history â†’
      </a>
    </div>

    <!-- horizontal carousel -->
    <div
      id="homeLastCarousel"
      class="flex gap-4 overflow-x-auto pb-2
             snap-x snap-mandatory
             [-ms-overflow-style:none] [scrollbar-width:none]"
    ></div>

    <style is:inline>
      #homeLastCarousel::-webkit-scrollbar{ display:none; }
    </style>
  </section>

  <!-- ON AIR -->
  <section class="mt-8 bg-[#0A1F33] border border-white/10 rounded-2xl p-6">
    <div class="flex items-center justify-between gap-4 mb-4">
      <div class="text-sm text-white/50 uppercase tracking-wider">
        On Air
      </div>
      <a href="/programs" class="text-cyan-300 hover:text-cyan-200 text-sm">Full schedule â†’</a>
    </div>
    <div id="onAirTonight" class="text-white/70"></div>
  </section>

  <!-- LATEST NEWS -->
  <section class="mt-8 bg-[#0A1F33] border border-white/10 rounded-2xl p-6">
    <div class="flex items-center justify-between gap-4 mb-4">
      <div class="text-sm text-white/50 uppercase tracking-wider">
        Latest News
      </div>
      <a href="/news" class="text-cyan-300 hover:text-cyan-200 text-sm">
        All news â†’
      </a>
    </div>

    {latestNews?.length ? (
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        {latestNews.map((post) => {
          const dateLabel = fmtDate(post.published_at || post.date_created);
          const cover = directusAsset(post.cover, { w: 900, h: 540, fit: "cover", quality: 85 });
          return (
            <a
              href={`/news/${post.slug}`}
              class="group rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 transition overflow-hidden"
            >
              <div class="relative aspect-[16/9] bg-gradient-to-br from-[#145C8F] to-[#2FC2FF]">
                {cover ? (
                  <img
                    src={cover}
                    alt=""
                    class="absolute inset-0 w-full h-full object-cover opacity-90 group-hover:opacity-100 transition"
                    loading="lazy"
                    decoding="async"
                  />
                ) : null}
                <div class="absolute inset-0 bg-gradient-to-t from-[#050B14]/75 via-[#050B14]/10 to-transparent"></div>
                <div class="absolute left-4 bottom-3 right-4 flex items-end justify-between gap-3">
                  <div class="min-w-0">
                    <div class="text-[11px] text-white/65 uppercase tracking-wider">
                      {dateLabel || ""}
                    </div>
                    <div class="mt-1 font-extrabold text-base leading-tight truncate">
                      {post.title}
                    </div>
                  </div>
                  <div class="flex-none w-9 h-9 rounded-xl border border-white/15 bg-white/5 grid place-items-center text-cyan-200/90">
                    â†’
                  </div>
                </div>
              </div>
              <div class="p-4">
                <p class="text-white/70 text-sm leading-relaxed line-clamp-2">
                  {post.excerpt ?? ""}
                </p>
              </div>
            </a>
          );
        })}
      </div>
    ) : (
      <div class="text-white/60 text-sm">
        No news yet â€” check back soon.
      </div>
    )}

    <style is:inline>
      .line-clamp-2{
        display:-webkit-box;
        -webkit-line-clamp:2;
        -webkit-box-orient:vertical;
        overflow:hidden;
      }
    </style>
  </section>

  <!-- Top this week (single card wrapper) -->
  <div class="mt-8 rounded-3xl border border-white/10 bg-[#0A1F33] overflow-hidden">
    <div class="p-5 flex items-center justify-between gap-4">
      <div>
        <div class="text-sm text-white/50 uppercase tracking-wider">Top this week</div>
        <div class="text-white/70 text-sm mt-1">Top voted tracks (this week).</div>
      </div>
      <a href="/music" class="text-cyan-200 hover:text-cyan-100 text-sm transition">
        Vote & charts â†’
      </a>
    </div>

    <div class="border-t border-white/10 p-4">
      <div id="topWeekGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
        {Array.from({ length: 8 }).map((_, i) => (
          <article
            class="rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 transition overflow-hidden"
            data-topweek-card
          >
            <div class="p-3 flex items-center gap-3">
              <div class="abfCover w-12 h-12 rounded-xl border border-white/10 overflow-hidden flex-none">
                <img class="hidden" alt="" />
                <div class="abfCoverFallback">
                  <img src="/logo-abf.png" alt="ABF" loading="lazy" decoding="async" />
                </div>
              </div>
              <div class="min-w-0 flex-1">
                <div class="text-xs text-white/50 uppercase tracking-wider" data-rank>#{i + 1}</div>
                <div class="font-semibold text-sm truncate" data-artist>â€”</div>
                <div class="text-xs text-white/70 truncate" data-title>â€”</div>
              </div>
              <div class="flex-none text-xs text-white/50" data-count>â€”</div>
            </div>
          </article>
        ))}
      </div>

      <div id="topWeekEmpty" class="mt-4 text-white/50 text-sm hidden">
        No votes yet this week â€” go vote on
        <a class="text-cyan-200 hover:text-cyan-100 transition" href="/music">/music</a> ðŸ™‚
      </div>
    </div>
  </div>

  <!-- Feature mini-cards (now with gradients + FLAC modal) -->
  <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-3">
    <!-- Card 1 (darker / UHD-HD) -->
    <div class="rounded-2xl border border-white/10 p-4 overflow-hidden relative
                bg-gradient-to-br from-[#061220] via-[#0A1F33] to-[#050B14]">
      <div class="absolute -top-24 -right-24 w-[240px] h-[240px] bg-cyan-500/20 rounded-full blur-[80px]"></div>
      <div class="relative">
        <div class="text-xs text-white/50 uppercase tracking-wider">New</div>
        <div class="font-extrabold text-lg">ABF Live in UHD &amp; HD</div>
        <p class="text-sm text-white/70 mt-1">
          Ultra clean stream modes via stable HTTPS endpoints â€” bypass firewalls, corporate networks (best-effort availability).
        </p>
        <div class="mt-3 flex items-center gap-2 text-xs">
          <span class="px-2 py-1 rounded-xl border border-white/10 bg-white/5 text-cyan-200">UHD</span>
          <span class="px-2 py-1 rounded-xl border border-white/10 bg-white/5 text-white/80">HD</span>
          <span class="px-2 py-1 rounded-xl border border-white/10 bg-white/5 text-white/80">SD</span>
          <span class="px-2 py-1 rounded-xl border border-white/10 bg-white/5 text-white/80">Low Data</span>
        </div>
        <div class="mt-3">
          <button
            id="openStreamQualityModal"
            type="button"
            class="inline-flex items-center text-sm text-cyan-200 hover:text-cyan-100 transition"
          >
            Learn more â†’
          </button>
        </div>
      </div>
    </div>

    <!-- Card 2 (medium / FLAC) -->
    <div class="rounded-2xl border border-white/10 p-4
                bg-gradient-to-br from-[#0B2540] via-[#0A1F33] to-[#061220]">
      <div class="text-xs text-white/50 uppercase tracking-wider">Audio</div>
      <div class="font-extrabold text-lg">Lossless FLAC Mode</div>
      <p class="text-sm text-white/70 mt-1">
        For audiophiles: maximum quality when available.
      </p>
      <div class="mt-3 flex items-center gap-2">
        <button
          id="openFlacModal"
          type="button"
          class="inline-flex items-center gap-2 text-sm text-cyan-200 hover:text-cyan-100 transition
                 px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10"
        >
          What is FLAC? â†’
        </button>
        <button
          id="openFlacModal2"
          type="button"
          class="inline-flex items-center text-sm text-white/70 hover:text-white transition"
        >
          Learn more â†’
        </button>
      </div>
    </div>

    <!-- Card 3 â€“ Support / Donation call -->
<div class="rounded-2xl border border-white/10 p-4 bg-gradient-to-br from-[#102B44] via-[#0A1F33] to-[#0B2540] relative overflow-hidden">
  <div class="absolute -top-20 -right-20 w-40 h-40 bg-cyan-500/10 rounded-full blur-3xl"></div>
  
  <div class="relative z-10">
    <div class="text-xs text-white/50 uppercase tracking-wider mb-1">Independent & Ad-Free</div>
    <div class="font-extrabold text-lg leading-tight">Buy us a coffee? â˜•</div>
    <p class="text-sm text-white/70 mt-2">
      Radio ABF stays 100% independent thanks to you.<br class="hidden sm:block">
      A small donation helps cover servers, streaming, and music rights.
    </p>
    
    <button 
      id="openSupportModal" 
      type="button" 
      class="inline-flex mt-4 items-center gap-2 px-5 py-2.5 rounded-xl bg-gradient-to-r from-[#145C8F] to-[#2FC2FF] font-semibold text-sm shadow-md shadow-cyan-500/25 hover:scale-[1.02] transition"
    >
      Support us â†’
    </button>
  </div>
</div>
  
<!-- STREAM QUALITY MODAL -->
<div id="streamQualityModal" class="abfModal" aria-hidden="true">
  <div class="abfModalBackdrop" data-close="streamquality"></div>
  <div class="abfModalWrap">
    <div class="abfModalCard" role="dialog" aria-modal="true" aria-label="Stream qualities info">
      <div class="abfModalTop">
        <div class="abfModalTitle">Stream Qualities & HTTPS Proxy</div>
        <button class="abfModalClose" id="streamQualityClose" type="button" aria-label="Close">âœ•</button>
      </div>
      <div class="abfModalBody">
        <div class="space-y-4 text-sm text-white/75 leading-relaxed">
          <p class="text-white/85 font-semibold">ABF offers four stream qualities via stable HTTPS proxy endpoints.</p>
          <p>These fixed URLs are perfect for direct listening, external players (VLC, Winamp, foobar2000, etc.), widgets, apps, or to bypass firewalls/corporate networks.</p>
          <ul class="space-y-3">
            <li> <span class="font-semibold text-cyan-200">UHD (FLAC ~728kbps)</span>: Lossless studio quality â€” maximum fidelity for high-end setups.</li>
            <li> <span class="font-semibold text-white/90">HD (MP3 320kbps)</span>: High bitrate for excellent clarity on good connections.</li>
            <li> <span class="font-semibold text-white/90">SD (MP3 128kbps)</span>: Balanced quality/bitrate for everyday listening.</li>
            <li> <span class="font-semibold text-white/90">Low connection (AAC+ 32kbps)</span>: Ultra-light for mobile data or unstable networks.</li>
          </ul>
          <p>The embedded player automatically selects the best quality, but you can force one manually in the controls.</p>
          <div class="mt-6 pt-4 border-t border-white/10">
            <p class="text-white/85 font-semibold mb-3">How to use in external players</p>
            <ul class="space-y-3 text-sm">
              <li><strong>Windows</strong>: VLC â†’ Media â†’ Open Network Stream â†’ paste URL â†’ Play.<br>Or Winamp/foobar2000 â†’ Add URL.</li>
              <li><strong>Mac</strong>: VLC or IINA â†’ File â†’ Open Network â†’ paste URL.</li>
              <li><strong>Android</strong>: VLC, MX Player, or any radio app â†’ Add stream URL.</li>
              <li><strong>iOS/iPhone</strong>: Apps like "Radio" or VLC â†’ add custom URL (or use Safari for direct play on some).</li>
              <li><strong>Linux</strong>: VLC, Rhythmbox, or mpv â†’ open network stream.</li>
            </ul>
          </div>
          <div class="mt-6 pt-4 border-t border-white/10">
            <p class="text-white/85 font-semibold mb-3">Direct HTTPS URLs (copy-paste ready)</p>
            <ul class="space-y-2 text-cyan-200">
              <li>â€¢ UHD FLAC: <a href="https://stream.radioabf.com/abf-uhd.flac" class="underline hover:text-cyan-100" target="_blank">https://stream.radioabf.com/abf-uhd.flac</a></li>
              <li>â€¢ HD MP3 320kbps: <a href="https://stream.radioabf.com/abf-hd.mp3" class="underline hover:text-cyan-100" target="_blank">https://stream.radioabf.com/abf-hd.mp3</a></li>
              <li>â€¢ SD MP3 128kbps: <a href="https://stream.radioabf.com/abf-sd.mp3" class="underline hover:text-cyan-100" target="_blank">https://stream.radioabf.com/abf-sd.mp3</a></li>
              <li>â€¢ Low AAC+ 32kbps: <a href="https://stream.radioabf.com/abf-low.aac" class="underline hover:text-cyan-100" target="_blank">https://stream.radioabf.com/abf-low.aac</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


  <!-- FLAC MODAL -->
  <div id="flacModal" class="abfModal" aria-hidden="true">
    <div class="abfModalBackdrop" data-close="flac"></div>
    <div class="abfModalWrap">
      <div class="abfModalCard" role="dialog" aria-modal="true" aria-label="FLAC mode info">
        <div class="abfModalTop">
          <div class="abfModalTitle">FLAC Mode</div>
          <button class="abfModalClose" id="flacClose" type="button" aria-label="Close">âœ•</button>
        </div>
        <div class="abfModalBody">
          <div class="space-y-3 text-sm text-white/75 leading-relaxed">
            <p class="text-white/85 font-semibold">
              Lossless audio, studio-like clarity.
            </p>
            <p>
              FLAC (Free Lossless Audio Codec) preserves the original audio signal without compression artifacts.
              Itâ€™s ideal for high-end headphones, DACs, and speakersâ€”especially in quiet listening environments.
            </p>
            <p>
              Heads up: FLAC uses significantly more bandwidth than MP3/AAC. If your connection is unstable,
              you may get smoother playback with MP3 320 or AAC+.
            </p>
            <div class="mt-4 flex flex-wrap gap-2">
              <span class="px-3 py-1.5 rounded-xl border border-white/10 bg-white/5 text-white/80 text-xs">
                Best on Wi-Fi / Fiber
              </span>
              <span class="px-3 py-1.5 rounded-xl border border-white/10 bg-white/5 text-white/80 text-xs">
                Higher data usage
              </span>
              <span class="px-3 py-1.5 rounded-xl border border-white/10 bg-white/5 text-cyan-200 text-xs">
                Premium clarity
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- SUPPORT / DONATION MODAL -->
<div id="supportModal" class="abfModal" aria-hidden="true">
  <div class="abfModalBackdrop" data-close="support"></div>
  <div class="abfModalWrap">
    <div class="abfModalCard" role="dialog" aria-modal="true" aria-label="Support Radio ABF">
      
      <!-- Header -->
      <div class="abfModalTop">
        <div class="abfModalTitle">Buy us a coffee to keep ABF alive? â˜•</div>
        <button class="abfModalClose" id="supportClose" type="button" aria-label="Close">âœ•</button>
      </div>
      
      <!-- Body -->
      <div class="abfModalBody p-6 space-y-6 text-center sm:text-left">
        
        <div class="text-white/80 leading-relaxed">
          <p class="text-lg font-semibold mb-3">Radio ABF is:</p>
          <ul class="space-y-2 text-sm text-white/75 list-disc list-inside mx-auto sm:mx-0 max-w-md">
            <li>24/7 high-quality sound, no ads</li>
            <li>Exclusive mixes and passionate residents</li>
            <li>100% independent (no big labels or corporations)</li>
            <li>Servers, streaming costs and music rights to cover</li>
          </ul>
        </div>

        <p class="text-white/90 font-medium">
          Even <strong>â‚¬3</strong> makes a real difference. Thank you so much â™¥
        </p>

        <!-- Buy Me a Coffee â€“ Option A: Simple stylish button (recommended â€“ lightweight) -->
        <a 
          href="https://www.buymeacoffee.com/radioabf" 
          target="_blank" 
          rel="noopener noreferrer"
          class="inline-flex items-center gap-3 px-7 py-4 rounded-2xl bg-[#FFDD00] text-black font-bold text-base shadow-lg hover:bg-[#FFDD00]/90 transition transform hover:scale-105"
        >
          <img src="https://cdn.buymeacoffee.com/buttons/bmc-new-btn-logo.svg" alt="Buy Me a Coffee" class="h-6 w-6">
          Buy us a coffee (or more!)
        </a>

        <!-- Option B: Full embed widget (uncomment if you prefer â€“ more interactive) -->
        <!--
        <div class="bmc-widget" data-id="radioabf" style="max-width:420px; margin:0 auto;">
          <script data-cfasync="false" src="https://cdn.buymeacoffee.com/widgets/v2/widget.prod.min.js"></script>
        </div>
        -->

        <p class="text-xs text-white/50 pt-4">
          Secure payment â€¢ One-time or become a monthly supporter
        </p>
      </div>
  </div>
</div>
</div>

<!-- âœ… Directus schedule injection (HOME) -->
<script is:inline define:vars={{ directusSchedule }}>
  // Inject as a JS object (not a JSON string)
  window.__abfProgramsFromDirectus = directusSchedule ?? null;
</script>

  <!-- SCRIPT -->
<script is:inline data-astro-rerun>
(() => {
  // âœ… on autorise le re-render sur astro swaps, mais on Ã©vite de re-binder les listeners globaux
  const PROGRAMS_DIR = "/images/programs/";
  const HISTORY_KEY = "abf_history"; // fallback legacy (lecture seulement)
  // -------------------------
  // WEEK ID (same as music)
  // -------------------------
  function getISOWeekId(d = new Date()){
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = date.getUTCDay() || 7;
    date.setUTCDate(date.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
    const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
    return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
  }
  // -------------------------
  // Helpers
  // -------------------------
  function normalizeDashes(s){
    return String(s || "")
      .replace(/\s+â€”\s+/g, " - ")
      .replace(/\s+â€“\s+/g, " - ")
      .replace(/\s+-\s+/g, " - ")
      .trim();
  }

  // Split only on " - " (with spaces) => Jean-Pierre safe
  function splitTrack(entry){
    const s = normalizeDashes(String(entry || "").trim().replace(/^undefined\s*-\s*/i, ""));
    const idx = s.indexOf(" - ");
    if (idx === -1) return { artist: s, title: "" };
    return { artist: s.slice(0, idx).trim(), title: s.slice(idx + 3).trim() };
  }

  function cleanTitleForDisplay(title){
    let t = String(title || "").trim();
    if (!t) return "";

    const killWords =
      "(?:original|extended|radio|club|dub|edit|mix|version|remix|rework|bootleg|vip|instrumental|acapella|a cappella|mono|stereo|clean|explicit|single|album|live|demo)";

    for (let i = 0; i < 6; i++){
      const before = t;

      // (Extended Mix) / [Radio Edit] at end
      t = t.replace(
        new RegExp(`\\s*[\\(\\[][^\\)\\]]*?\\b${killWords}\\b[^\\)\\]]*[\\)\\]]\\s*$`, "i"),
        ""
      );

      // "- Radio Edit" / "â€“ Extended Mix" / "â€” Original Mix" at end
      t = t.replace(new RegExp(`\\s*(?:-|â€“|â€”)\\s*${killWords}\\b.*$`, "i"), "");

      t = t.replace(/\s{2,}/g, " ").trim();
      if (t === before) break;
    }

    return t;
  }

  function cleanArtistForDisplay(artist){
    return String(artist || "").replace(/\s{2,}/g, " ").trim();
  }

  function normKey(a,t){
    return (a + " - " + t)
      .toLowerCase()
      .replace(/\s+/g," ")
      .replace(/[â€œâ€"']/g,"")
      .trim();
  }
  function esc(s){
    return String(s || "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }
  // Cover HTML helper (server url only)
  function coverHtmlByUrl(url, sizeClass = "w-14 h-14 rounded-2xl") {
    const u = String(url || "").trim();
    return `
      <div class="abfCover ${sizeClass} border border-white/10 overflow-hidden flex-none">
        <img src="${u ? esc(u) : ""}" alt="" class="${u ? "" : "hidden"}" loading="lazy" decoding="async" />
        <div class="abfCoverFallback">
          <img src="/logo-abf.png" alt="ABF" loading="lazy" decoding="async" />
        </div>
      </div>
    `;
  }
  function setCover(url){
    const img = document.getElementById("homeCover");
    if (!img) return;
    const u = String(url || "").trim();
    if (u){
      img.src = u;
      img.classList.remove("hidden");
    } else {
      img.removeAttribute("src");
      img.classList.add("hidden");
    }
  }
  function setHeroTop1Cover(url){
    const img = document.getElementById("heroTop1Cover");
    if (!img) return;
    const u = String(url || "").trim();
    if (u){
      img.src = u;
      img.classList.remove("hidden");
    } else {
      img.removeAttribute("src");
      img.classList.add("hidden");
    }
  }
  // -------------------------
  // History fallback (legacy, read-only)
  // -------------------------
  function loadHistoryLocal(){
    let raw = [];
    try{ raw = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]"); }
    catch{ raw = []; }
    return (raw || []).map((x) => {
      if (typeof x === "string") return { t: x, ts: 0, cover_url: "" };
      if (x && typeof x === "object" && typeof x.t === "string"){
        return { t: x.t, ts: Number(x.ts) || 0, cover_url: String(x.cover_url || "") };
      }
      return null;
    }).filter(Boolean);
  }
  // -------------------------
  // âœ… Server nowplaying (expects cover_url)
  // -------------------------
  async function fetchServerNowPlaying(limit = 12){
    try{
      const res = await fetch(`/api/nowplaying?limit=${limit}`, { cache: "no-store" });
      const data = await res.json().catch(()=> ({}));
      if (!data?.ok) return [];
      const out = [];
      if (data?.now){
        const rawNow = String(data?.now?.raw || "").trim();
        const a = String(data?.now?.artist || "").trim();
        const t = String(data?.now?.title || "").trim();
        const raw = rawNow || (a || t ? `${a} - ${t}`.trim() : "");
        if (raw){
          out.push({
            t: raw,
            ts: Number(data?.now?.played_at_ms) ||
                (data?.now?.played_at ? new Date(data.now.played_at).getTime() : Date.now()),
            cover_url: String(data?.now?.cover_url || "")
          });
        }
      }
      if (Array.isArray(data?.history)){
        for (const row of data.history){
          const raw = String(row?.raw || `${row?.artist || ""} - ${row?.title || ""}`.trim() || "").trim();
          if (!raw) continue;
          out.push({
            t: raw,
            ts: Number(row?.played_at_ms) ||
                (row?.played_at ? new Date(row.played_at).getTime() : 0),
            cover_url: String(row?.cover_url || "")
          });
        }
      }
      // dedupe (case-insensitive)
      const seen = new Set();
      const deduped = [];
      for (const item of out){
        const k = String(item.t || "").toLowerCase();
        if (!k || seen.has(k)) continue;
        seen.add(k);
        deduped.push(item);
      }
      return deduped.slice(0, limit);
    }catch{
      return [];
    }
  }
  // -------------------------
  // Votes
  // -------------------------
  async function apiGetTopWeek(week){
    const r = await fetch(`/api/vote?week=${encodeURIComponent(week)}`, { cache: "no-store" });
    if (!r.ok) return { week, top: [] };
    const j = await r.json().catch(() => ({}));
    return { week: j?.week || week, top: Array.isArray(j?.top) ? j.top : [] };
  }
  let __homeVotesCache = window.__abfHomeVotesCache || { week: "", ts: 0, top: [] };
  window.__abfHomeVotesCache = __homeVotesCache;
  async function getTopWeekCached(week){
    const now = Date.now();
    if (__homeVotesCache.week === week && (now - __homeVotesCache.ts) < 8000) {
      return __homeVotesCache.top || [];
    }
    const data = await apiGetTopWeek(week);
    __homeVotesCache = { week, ts: now, top: data.top || [] };
    window.__abfHomeVotesCache = __homeVotesCache;
    return __homeVotesCache.top || [];
  }
  // -------------------------
  // âœ… NOW PLAYING + LAST PLAYED (server cover_url, no cover cache)
  // -------------------------
  async function renderNowPlayingAndLast(){
    const artistEl = document.getElementById("homeArtist");
    const titleEl = document.getElementById("homeTitle");
    const host = document.getElementById("homeLastCarousel");
    if (!artistEl || !titleEl || !host) return;
    let history = await fetchServerNowPlaying(12);
    if (!history.length) history = loadHistoryLocal(); // fallback legacy only
    if (!history.length){
      artistEl.textContent = "â€”";
      titleEl.textContent = "â€”";
      setCover("");
      host.innerHTML = `<div class="text-white/50">No history yet â€” start the player.</div>`;
      window.__abfHomeCoverByNorm = {};
      return;
    }
    // Build cover map from server payload (Top can reuse)
    const coverByNorm = {};
    for (const entry of history){
      const t = splitTrack(entry.t);
      const n = normKey(t.artist, t.title);
      const u = String(entry.cover_url || "").trim();
      if (n && u) coverByNorm[n] = u;
    }
    window.__abfHomeCoverByNorm = coverByNorm;
    // NOW
    const currentEntry = history[0];
    const current = splitTrack(currentEntry.t);
    const artist = cleanArtistForDisplay(current.artist);
    const title = cleanTitleForDisplay(current.title);
    // on laisse Base faire le formatage global via data-abf-*
    artistEl.textContent = artist || "â€”";
    titleEl.textContent = title || "â€”";
    setCover(String(currentEntry.cover_url || "").trim() || coverByNorm[normKey(artist, title)] || "");
    // LAST PLAYED carousel: 3 items
    const items = history.slice(1, 4);
    if (!items.length){
      host.innerHTML = `<div class="text-white/50">No history yet â€” start the player.</div>`;
      return;
    }
    host.innerHTML = items.map((entry) => {
      const t = splitTrack(entry.t);
      const a = cleanArtistForDisplay(t.artist);
      const ti = cleanTitleForDisplay(t.title);
      const url = String(entry.cover_url || "").trim() || coverByNorm[normKey(a, ti)] || "";
      return `
        <a href="/music"
           class="snap-start flex-none w-[260px] md:w-[300px]
                  rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10
                  transition p-4 flex items-center gap-4">
          ${coverHtmlByUrl(url, "w-14 h-14 rounded-2xl")}
          <div class="min-w-0">
            <div class="font-semibold text-white truncate" data-abf-artist>${esc(a || "â€”")}</div>
            <div class="text-white/60 text-sm truncate" data-abf-title>${esc(ti || "â€”")}</div>
          </div>
        </a>
      `;
    }).join("");
    // applique le formatter global aprÃ¨s injection HTML
    try { window.ABF_FMT?.apply(document); } catch {}
  }
  // -------------------------
  // âœ… HERO #1 (uses coverByNorm from history; no local cover cache)
  // -------------------------
  async function renderHeroTop1(){
    const box = document.getElementById("heroTop1");
    const empty = document.getElementById("heroTop1Empty");
    const aEl = document.getElementById("heroTop1Artist");
    const tEl = document.getElementById("heroTop1Title");
    if (!box || !empty || !aEl || !tEl) return;
    const week = getISOWeekId();
    const top = await getTopWeekCached(week);
    const first = top?.[0];
    if (!first || !first.track_key){
      box.classList.add("hidden");
      empty.classList.remove("hidden");
      setHeroTop1Cover("");
      return;
    }
    const artistRaw = cleanArtistForDisplay(first.artist) || "â€”";
    const titleRaw = cleanTitleForDisplay(first.title) || "â€”";
    aEl.textContent = artistRaw;
    tEl.textContent = titleRaw;
    const coverByNorm = window.__abfHomeCoverByNorm || {};
    const url =
      String(first.cover_url || "").trim() ||
      coverByNorm[normKey(artistRaw, titleRaw)] ||
      "";
    setHeroTop1Cover(url);
    empty.classList.add("hidden");
    box.classList.remove("hidden");
    try { window.ABF_FMT?.apply(document); } catch {}
  }
  // -------------------------
  // âœ… TOP 8 GRID (uses coverByNorm from history; no local cover cache)
  // -------------------------
  async function renderTop(){
    const cards = Array.from(document.querySelectorAll("[data-topweek-card]"));
    const empty = document.getElementById("topWeekEmpty");
    if (!cards.length) return;
    const week = getISOWeekId();
    const top = await getTopWeekCached(week);
    const coverByNorm = window.__abfHomeCoverByNorm || {};
    if (!top.length){
      if (empty) empty.classList.remove("hidden");
      cards.forEach((card, i) => {
        const rankEl = card.querySelector("[data-rank]");
        const aEl = card.querySelector("[data-artist]");
        const tEl = card.querySelector("[data-title]");
        const cEl = card.querySelector("[data-count]");
        const img = card.querySelector("img");
        if (rankEl) rankEl.textContent = `#${i+1}`;
        if (aEl) aEl.textContent = "â€”";
        if (tEl) tEl.textContent = "Vote on /music to build this chart";
        if (cEl) cEl.textContent = "";
        if (img){ img.removeAttribute("src"); img.classList.add("hidden"); }
      });
      return;
    }
    if (empty) empty.classList.add("hidden");
    cards.forEach((card, i) => {
      const rankEl = card.querySelector("[data-rank]");
      const aEl = card.querySelector("[data-artist]");
      const tEl = card.querySelector("[data-title]");
      const cEl = card.querySelector("[data-count]");
      const img = card.querySelector("img");
      if (rankEl) rankEl.textContent = `#${i+1}`;
      const row = top[i];
      if (!row){
        if (aEl) aEl.textContent = "â€”";
        if (tEl) tEl.textContent = "â€”";
        if (cEl) cEl.textContent = "";
        if (img){ img.removeAttribute("src"); img.classList.add("hidden"); }
        return;
      }
      const artistRaw = cleanArtistForDisplay(row.artist) || "â€”";
      const titleRaw = cleanTitleForDisplay(row.title) || "â€”";
      const count = Number(row.count) || 0;
      const coverUrl =
        String(row.cover_url || "").trim() ||
        coverByNorm[normKey(artistRaw, titleRaw)] ||
        "";
      if (img){
        if (coverUrl){
          img.src = coverUrl;
          img.classList.remove("hidden");
        } else {
          img.removeAttribute("src");
          img.classList.add("hidden");
        }
      }
      if (aEl){ aEl.textContent = artistRaw; aEl.setAttribute("data-abf-artist",""); }
      if (tEl){ tEl.textContent = titleRaw; tEl.setAttribute("data-abf-title",""); }
      if (cEl) cEl.textContent = `${count}`;
    });
    try { window.ABF_FMT?.apply(document); } catch {}
  }
  // -------------------------
  // ON AIR (inchangÃ©)
  // -------------------------
  // -------------------------
  // âœ… ON AIR (Directus schedule)
  // -------------------------
  function getSchedule(){
    const raw = window.__abfProgramsFromDirectus;
    if (raw && typeof raw === "object") return raw;
    return { mon: [], tue: [], wed: [], thu: [], fri: [], sat: [], sun: [] };
  }

  function dayKey(){
    const d = new Date().getDay();
    if (d === 0) return "sun";
    if (d === 1) return "mon";
    if (d === 2) return "tue";
    if (d === 3) return "wed";
    if (d === 4) return "thu";
    if (d === 5) return "fri";
    return "sat";
  }
function parseTimeToMinutes(t){
  const s = String(t || "").trim();

  // "18:00" ou "18:00:00"
  let m = s.match(/^(\d{1,2}):(\d{2})(?::\d{2})?$/);
  if (m) return Number(m[1]) * 60 + Number(m[2]);

  // "18h00"
  m = s.match(/^(\d{1,2})h(\d{2})$/i);
  if (m) return Number(m[1]) * 60 + Number(m[2]);

  return null;
}
  function fmtCountdown(ms){
    if (ms <= 0) return "Starting now";
    const totalMin = Math.floor(ms / 60000);
    const h = Math.floor(totalMin / 60);
    const m = totalMin % 60;
    if (h <= 0) return `Starts in ${m}m`;
    return `Starts in ${h}h ${String(m).padStart(2,"0")}m`;
  }
  function injectOnAirStylesOnce(){
    if (document.getElementById("abfHomeOnAirStyles")) return;
    const st = document.createElement("style");
    st.id = "abfHomeOnAirStyles";
    st.textContent = `
      .onAirCard{
        border-color: rgba(248,113,113,.35) !important;
        background: radial-gradient(1200px 220px at 20% 0%,
          rgba(239,68,68,0.22),
          rgba(255,255,255,0.05) 45%,
          rgba(255,255,255,0.03) 100%);
        box-shadow:
          0 0 0 1px rgba(239,68,68,0.15) inset,
          0 20px 70px rgba(239,68,68,0.14),
          0 10px 35px rgba(0,0,0,0.35);
        position: relative;
      }
      .onAirCard::before{
        content:"";
        position:absolute;
        inset:-1px;
        border-radius: 1rem;
        pointer-events:none;
        background: linear-gradient(90deg,
          rgba(239,68,68,0.22),
          rgba(239,68,68,0.10),
          rgba(239,68,68,0.22));
        filter: blur(18px);
        opacity: .55;
      }
      .line-clamp-2{
        display:-webkit-box;
        -webkit-line-clamp:2;
        -webkit-box-orient:vertical;
        overflow:hidden;
      }
    `;
    document.head.appendChild(st);
  }
// --------- WORLD TIME (Paris -> UTC) ----------
function parseTimeToMinutesFlexible(t){
  const s = String(t || "").trim();
  const m = s.match(/^(\d{1,2})[:h](\d{2})(?::\d{2})?$/i);
  if (!m) return null;
  const hh = Number(m[1]);
  const mm = Number(m[2]);
  if (!Number.isFinite(hh) || !Number.isFinite(mm)) return null;
  return hh * 60 + mm;
}

function minutesToHHMM(min){
  const m = ((min % 1440) + 1440) % 1440;
  const hh = Math.floor(m / 60);
  const mm = m % 60;
  return `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}`;
}

function getTimeZoneOffsetMinutes(date, timeZone){
  const dtf = new Intl.DateTimeFormat("en-US", {
    timeZone,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: false,
  });
  const parts = Object.fromEntries(
    dtf.formatToParts(date).map(p => [p.type, p.value])
  );
  const asUTC = Date.UTC(
    Number(parts.year),
    Number(parts.month) - 1,
    Number(parts.day),
    Number(parts.hour),
    Number(parts.minute),
    Number(parts.second)
  );
  return Math.round((asUTC - date.getTime()) / 60000);
}

function formatWorldTimeLabel(timeHHMM){
  const minsParis = parseTimeToMinutesFlexible(timeHHMM);
  if (minsParis == null) return esc(timeHHMM || "");

  const now = new Date();
  const offset = getTimeZoneOffsetMinutes(now, "Europe/Paris");

  const utcMins = minsParis - offset;
  const utcHHMM = minutesToHHMM(utcMins);

  const tzLabel = offset === 60 ? "CET" : offset === 120 ? "CEST" : "CET";

  return (
    minutesToHHMM(minsParis) + " " + tzLabel +
    ' <span class="text-white/60 font-medium">(Paris)</span>' +
    ' <span class="text-white/30">â€¢</span> ' +
    '<span class="text-white/80 font-semibold">' + utcHHMM + " UTC</span>"
  );
}

  function renderOnAirTonight(){
    const host = document.getElementById("onAirTonight");
    if (!host) return;
    const day = dayKey();
    const schedule = getSchedule();
    const items = (schedule[day] || [])
      .map(x => ({...x, min: parseTimeToMinutesFlexible(x.time)}))
      .filter(x => x.min !== null)
      .sort((a,b) => a.min - b.min);
    const now = new Date();
    const nowMin = now.getHours() * 60 + now.getMinutes();
    let liveIndex = -1;
    for (let i=0;i<items.length;i++){
      const startMin = items[i].min;
      const endMin = (i < items.length - 1) ? items[i+1].min : 24*60;
      if (startMin <= nowMin && nowMin < endMin){
        liveIndex = i;
        break;
      }
    }
    let selected = [];
    let mode = "next";
    let subline = "";
    if (liveIndex >= 0){
      mode = "live";
      selected = items.slice(liveIndex, liveIndex + 3);
      const endMin = (liveIndex < items.length - 1) ? items[liveIndex+1].min : 24*60;
      const end = new Date(now);
      end.setHours(Math.floor(endMin/60), endMin%60, 0, 0);
      const msLeft = (end ? end.getTime() : 0) - now.getTime();
      const totalMin = Math.max(0, Math.floor(msLeft/60000));
      const h = Math.floor(totalMin/60);
      const m = totalMin%60;
      subline = (h <= 0) ? `Ends in ${m}m` : `Ends in ${h}h ${String(m).padStart(2,"0")}m`;
    } else {
      selected = items.filter(x => x.min >= nowMin).slice(0, 3);
      if (selected[0]){
        const start = new Date(now);
        start.setHours(Math.floor(selected[0].min/60), selected[0].min%60, 0, 0);
        subline = fmtCountdown(((start ? start.getTime() : 0) - now.getTime()));
      }
    }
    if (!selected.length){
      // âœ… fallback: show next available day (tomorrow or later)
      const order = ["mon","tue","wed","thu","fri","sat","sun"];
      const curIndex = order.indexOf(day);
      const rotate = order.slice(curIndex + 1).concat(order.slice(0, curIndex + 1));

      let nextDay = "";
      for (const dk of rotate){
        const arr = (schedule[dk] || [])
          .map(x => ({...x, min: parseTimeToMinutesFlexible(x.time)}))
          .filter(x => x.min !== null)
          .sort((a,b) => a.min - b.min);
        if (arr.length){
          nextDay = dk;
          selected = arr.slice(0, 3);
          mode = "next";
          subline = `Next shows: ${dk.toUpperCase()}`;
          break;
        }
      }

      if (!selected.length){
        host.innerHTML = `
          <div class="text-white/70">
            No schedule found yet â€” check the full schedule.
          </div>
          <div class="mt-4">
            <a href="/programs"
               class="inline-flex items-center justify-center
                      bg-white/5 hover:bg-white/10 border border-white/10
                      rounded-xl px-5 py-3 text-white/85 transition">
              Open schedule â†’
            </a>
          </div>
        `;
        return;
      }

      // âœ… override day label if we switched day
      // (optional, purely visual)
    }
    const first = selected[0];
    const others = selected.slice(1);
    const badge = (mode === "live")
      ? `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-red-500/15 border border-red-500/25 text-red-200 text-xs font-semibold tracking-wider">
           <span class="w-2 h-2 rounded-full bg-red-400 animate-pulse"></span>
           LIVE NOW
         </span>`
      : `<span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10 text-white/80 text-xs font-semibold tracking-wider">
           NEXT
         </span>`;
    const liveWrapClass = (mode === "live") ? "onAirCard" : "";
    let firstDisplayTitle = first.title;
    if (firstDisplayTitle.startsWith("ABF CLUB - ")) {
      const parts = firstDisplayTitle.split(" - ", 2);
      firstDisplayTitle = parts[0] + " - " + parts[1].toUpperCase();
    }
    host.innerHTML = `
      <div class="space-y-4">
        <div class="rounded-2xl bg-white/5 border border-white/10 p-4 md:p-5 ${liveWrapClass}">
          <div class="flex items-center justify-between gap-3 flex-wrap mb-4">
            ${badge}
            <div class="text-white/50 text-sm">${esc(subline || "")}</div>
          </div>
          <div class="flex flex-col md:flex-row gap-6 items-stretch">
            <div class="w-full md:w-56 flex-none">
              <div class="h-full rounded-2xl border border-white/10 bg-black/20 overflow-hidden flex items-center justify-center p-2">
                <img
                  src="${esc(first.img || "")}"
                  alt="${esc(first.title)}"
                  class="w-full h-full object-contain"
                  loading="lazy"
                  decoding="async"
                />
              </div>
            </div>
            <div class="min-w-0 flex-1">
              <div class="text-cyan-300 font-bold text-xl md:text-2xl">
                ${formatWorldTimeLabel(first.time)}
              </div>
              <div class="mt-2 text-white font-semibold text-xl md:text-2xl truncate">
                ${esc(firstDisplayTitle)}
              </div>
              <div class="mt-2 text-white/70 text-base md:text-lg leading-relaxed">
                ${esc(first.desc)}
              </div>
              <div class="mt-5 flex gap-3 flex-wrap">
                <a href="/programs"
                   class="bg-gradient-to-r from-[#145C8F] to-[#2FC2FF]
                          px-6 py-3 rounded-xl font-semibold shadow-lg shadow-cyan-500/20
                          hover:scale-[1.01] transition">
                  View schedule
                </a>
                <button id="onAirRemindBtn"
                        type="button"
                        class="bg-white/5 hover:bg-white/10 border border-white/10
                               rounded-xl px-6 py-3 text-white/85 transition">
                  Remind me
                </button>
              </div>
              <div id="onAirRemindNote" class="mt-3 text-white/50 text-sm hidden">
                Reminder saved locally (this device).
              </div>
            </div>
          </div>
        </div>
        ${others.length ? `
          <div class="rounded-2xl bg-white/5 border border-white/10 p-4 md:p-5">
            <div class="text-sm text-white/50 uppercase tracking-wider mb-4">
              ${mode === "live" ? "Up next" : "Later"}
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              ${others.map(x => {
                let displayTitle = x.title;
                if (displayTitle.startsWith("ABF CLUB - ")) {
                  const parts = displayTitle.split(" - ", 2);
                  displayTitle = parts[0] + " - " + parts[1].toUpperCase();
                }
                return `
                  <div class="flex gap-4 items-center border border-white/10 rounded-xl p-3 bg-white/5 hover:bg-white/10 transition">
                    <div class="w-24 flex-none">
                      <div class="h-24 rounded-xl overflow-hidden border border-white/10 bg-black/20 flex items-center justify-center p-1">
                        <img
                          src="${esc(x.img || "")}"
                          alt="${esc(x.title)}"
                          class="w-full h-full object-contain"
                          loading="lazy"
                          decoding="async"
                        />
                      </div>
                    </div>
                    <div class="min-w-0 flex-1">
                      <div class="flex items-center justify-between gap-2">
                        <div class="text-cyan-300 font-bold text-sm">
                          ${formatWorldTimeLabel(x.time)}
                        </div>
                      </div>
                      <div class="mt-1 text-white font-semibold text-sm truncate">
                        ${esc(displayTitle)}
                      </div>
                      <div class="mt-1 text-white/60 text-xs leading-snug line-clamp-2">
                        ${esc(x.desc || "")}
                      </div>
                    </div>
                  </div>
                `;
              }).join("")}
            </div>
          </div>
        ` : ""}
      </div>
    `;
    const remindBtn = document.getElementById("onAirRemindBtn");
    const note = document.getElementById("onAirRemindNote");
    if (remindBtn){
      remindBtn.onclick = () => {
        try{
          const target = (mode === "live" && selected[1]) ? selected[1] : selected[0];
          const ts = (() => {
            const d = new Date();
            d.setHours(Math.floor(target.min/60), target.min%60, 0, 0);
            return d ? d.getTime() : 0;
          })();
          localStorage.setItem("abf_remind_next_show", JSON.stringify({
            day,
            time: target.time,
            title: target.title,
            ts
          }));
          if (note) note.classList.remove("hidden");
        }catch{}
      };
    }
  }
  // -------------------------
  // âœ… Modals (FIX Astro swap) â€” event delegation
  // -------------------------
  function bindHomeModalsOnce(){
    if (window.__abfHomeModalsBound) return;
    const lockScroll = (on) => { document.documentElement.style.overflow = on ? "hidden" : ""; };
    const openModal = (id) => {
      const modal = document.getElementById(id);
      if (!modal) return;
      modal.setAttribute("aria-hidden", "false");
      lockScroll(true);
    };
    const closeModal = (id) => {
      const modal = document.getElementById(id);
      if (!modal) return;
      modal.setAttribute("aria-hidden", "true");
      lockScroll(false);
    };
    // Click delegation (works after astro swaps)
    document.addEventListener("click", (e) => {
      const t = e.target;
      // OPEN buttons
      if (t?.closest?.("#openFlacModal") || t?.closest?.("#openFlacModal2")) {
        openModal("flacModal");
        return;
      }
      if (t?.closest?.("#openStreamQualityModal")) {
        openModal("streamQualityModal");
        return;
      }
      if (t?.closest?.("#openSupportModal")) {
        openModal("supportModal");
        return;
      }
      // CLOSE buttons
      if (t?.closest?.("#flacClose")) {
        closeModal("flacModal");
        return;
      }
      if (t?.closest?.("#streamQualityClose")) {
        closeModal("streamQualityModal");
        return;
      }
      if (t?.closest?.("#supportClose")) {
        closeModal("supportModal");
        return;
      }
      // Backdrop click close (data-close="...")
      const closeKey = t?.dataset?.close;
      if (closeKey === "flac") {
        closeModal("flacModal");
        return;
      }
      if (closeKey === "streamquality") {
        closeModal("streamQualityModal");
        return;
      }
      if (closeKey === "support") {
        closeModal("supportModal");
        return;
      }
    });
    // ESC close â€” tous les modals
    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      const flac = document.getElementById("flacModal");
      if (flac && flac.getAttribute("aria-hidden") === "false") closeModal("flacModal");
      const qual = document.getElementById("streamQualityModal");
      if (qual && qual.getAttribute("aria-hidden") === "false") closeModal("streamQualityModal");
      const support = document.getElementById("supportModal");
      if (support && support.getAttribute("aria-hidden") === "false") closeModal("supportModal");
    });
    window.__abfHomeModalsBound = true;
  }
  // -------------------------
  // Boot
  // -------------------------
  async function initHome(){
    injectOnAirStylesOnce();
    bindHomeModalsOnce();
    await renderNowPlayingAndLast(); // crÃ©e coverByNorm
    renderOnAirTonight();
    await renderTop();
    await renderHeroTop1();
    const jump = document.getElementById("jumpToPlayer");
    if (jump && !jump.dataset.bound){
      jump.dataset.bound = "1";
      jump.onclick = () => {
        // scroll vers le bas (le player est pinned)
        window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
      };
    }
    // timers (nettoyage avant de re-crÃ©er)
    if (window.__abfHomeTimer) clearInterval(window.__abfHomeTimer);
    window.__abfHomeTimer = setInterval(async () => {
      await renderNowPlayingAndLast();
      renderOnAirTonight();
      renderTop();
      renderHeroTop1();
    }, 8000);
    if (!window.__abfOnAirTimer){
      window.__abfOnAirTimer = setInterval(renderOnAirTonight, 30000);
    }
  }
  function initHomePage(){
    // home only
    if (window.location.pathname !== "/") return;
    requestAnimationFrame(() => requestAnimationFrame(initHome));
  }
  initHomePage();
  // bind listeners once
  if (!window.__abfHomeListeners){
    document.addEventListener("astro:page-load", initHomePage);
    document.addEventListener("astro:after-swap", initHomePage);
    document.addEventListener("astro:before-swap", () => {
      if (window.__abfHomeTimer) clearInterval(window.__abfHomeTimer);
    });
    // rafraÃ®chir dÃ¨s que le player met Ã  jour l'historique (server-side now)
    window.addEventListener("abf:history-updated", initHomePage);
    window.__abfHomeListeners = true;
  }
})();
</script>
</Base>
