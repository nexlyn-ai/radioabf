---
import Base from "../../layouts/Base.astro";
import { directusGet } from "../../lib/directus";

export const prerender = false;

type VideoItem = {
  id: number;
  status: string;
  slug: string;
  title: string;
  description?: string | null;
  youtube_url?: string | null;
  category?: string | null;
};

type DirectusResp = { data: VideoItem[] };

const { slug } = Astro.params;

let video: VideoItem | null = null;

try {
  const resp = await directusGet<DirectusResp>(
    `/items/videos?fields=id,status,slug,title,description,youtube_url,category&filter[status][_eq]=published&filter[slug][_eq]=${encodeURIComponent(
      String(slug || "")
    )}&limit=1`
  );
  video = resp?.data?.[0] ?? null;
} catch {
  video = null;
}

// ---------- helpers ----------
function youtubeIdFromUrl(url?: string | null) {
  if (!url) return null;
  try {
    const u = new URL(url);

    if (u.hostname.includes("youtu.be")) {
      return u.pathname.split("/").filter(Boolean)[0] ?? null;
    }
    if (u.searchParams.get("v")) return u.searchParams.get("v");

    const parts = u.pathname.split("/").filter(Boolean);

    const embedIndex = parts.indexOf("embed");
    if (embedIndex !== -1) return parts[embedIndex + 1] ?? null;

    const shortsIndex = parts.indexOf("shorts");
    if (shortsIndex !== -1) return parts[shortsIndex + 1] ?? null;

    return null;
  } catch {
    return null;
  }
}

function normCat(s?: string | null) {
  return String(s ?? "").trim();
}

function hashStr(str: string) {
  let h = 0;
  for (let i = 0; i < str.length; i++) h = (h * 31 + str.charCodeAt(i)) | 0;
  return Math.abs(h);
}

const CAT_PALETTE = [
  "border-cyan-300/35 bg-cyan-400/15 text-cyan-200",
  "border-emerald-300/30 bg-emerald-400/15 text-emerald-200",
  "border-violet-300/30 bg-violet-400/15 text-violet-200",
  "border-amber-300/30 bg-amber-400/15 text-amber-200",
  "border-pink-300/30 bg-pink-400/15 text-pink-200",
  "border-sky-300/30 bg-sky-400/15 text-sky-200",
  "border-lime-300/30 bg-lime-400/15 text-lime-200",
  "border-orange-300/30 bg-orange-400/15 text-orange-200",
] as const;

function catColorClass(name: string) {
  const idx = hashStr(name) % CAT_PALETTE.length;
  return CAT_PALETTE[idx];
}

const yid = video ? youtubeIdFromUrl(video.youtube_url) : null;
const embedUrl = yid
  ? `https://www.youtube-nocookie.com/embed/${yid}?rel=0&modestbranding=1&playsinline=1`
  : null;

const cat = normCat(video?.category);
const catClass = cat ? catColorClass(cat) : "";
---

<Base
  title={video ? `${video.title} — Videos | RadioABF` : "Video — RadioABF"}
  description={video?.description ?? "Watch videos on RadioABF."}
  canonical={video ? `/videos/${video.slug}` : "/videos"}
  image="/og-image.jpg"
>
  <div id="videoSlugRoot">
    {video ? (
      <>
        <!-- MAIN CARD -->
        <section class="rounded-3xl border border-white/10 bg-[#0A1F33] overflow-hidden shadow-2xl">
          <!-- HEADER (hero) -->
          <div class="p-3 md:p-4 border-b border-white/10">
            <div class="flex items-start justify-between gap-4 flex-wrap">
              <div class="min-w-0">
                <div class="text-[10px] text-white/50 uppercase tracking-widest">
                  RadioABF Video
                </div>

                <h1 class="mt-1 text-lg sm:text-xl font-extrabold leading-snug text-white">
                  {video.title}
                </h1>

                {video.description ? (
                  <p class="text-white/60 mt-2 text-xs max-w-2xl leading-relaxed">
                    {video.description}
                  </p>
                ) : null}
              </div>

              <!-- ✅ Right side badges in hero -->
              <div class="flex items-center justify-start md:justify-end gap-2 flex-nowrap overflow-x-auto no-scrollbar">
                <a
                  href="/videos"
                  class="inline-flex items-center gap-2 text-xs font-bold text-white/70 hover:text-white border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-1.5 rounded-xl transition-colors flex-none"
                  aria-label="Back to videos"
                  title="Back"
                >
                  ← Back
                </a>

                {cat ? (
                  <span
                    class={["inline-flex items-center rounded-full border px-3 py-1 text-[10px] font-extrabold flex-none", catClass].join(
                      " "
                    )}
                    aria-label="Category"
                    title={cat}
                  >
                    {cat.toUpperCase()}
                  </span>
                ) : null}
              </div>
            </div>
          </div>

          <!-- VIDEO -->
          <div class="p-3 md:p-4">
            <div class="rounded-2xl border border-white/10 bg-black/30 overflow-hidden shadow-xl">
              {embedUrl ? (
                <div class="aspect-video max-h-[42vh] w-full">
                  <iframe
                    class="w-full h-full"
                    src={embedUrl}
                    title={video.title}
                    loading="lazy"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    allowfullscreen
                  ></iframe>
                </div>
              ) : (
                <div class="p-4 text-xs text-white/60">
                  Invalid YouTube link for this video.
                </div>
              )}
            </div>

            <div class="mt-3 flex flex-wrap items-center gap-2">
              <a
                href="/videos"
                class="text-xs font-bold text-white/85 border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-1.5 rounded-xl transition-colors"
              >
                Back to library →
              </a>

              <a
                href="/music"
                class="text-xs font-bold text-[#061220] bg-cyan-300 hover:bg-cyan-200 border border-cyan-200/30 px-3 py-1.5 rounded-xl transition-colors shadow-md shadow-cyan-500/20"
              >
                Music Portal →
              </a>
            </div>
          </div>
        </section>

        <style>
          .tabular-nums { font-variant-numeric: tabular-nums; }
          .no-scrollbar::-webkit-scrollbar { display: none; }
          .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        </style>
      </>
    ) : (
      <section class="rounded-3xl border border-white/10 bg-[#0A1F33] p-5 shadow-2xl">
        <div class="text-sm text-white/60 uppercase tracking-wider">Video</div>
        <div class="mt-2 text-lg font-extrabold text-white">Not found</div>
        <p class="text-white/65 mt-2 text-sm">
          This video doesn’t exist (or is not published).
        </p>
        <div class="mt-3">
          <a
            href="/videos"
            class="inline-flex items-center gap-2 text-xs font-bold text-white/90 border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-1.5 rounded-xl transition-colors"
          >
            ← Back to videos
          </a>
        </div>
      </section>
    )}
  </div>
</Base>