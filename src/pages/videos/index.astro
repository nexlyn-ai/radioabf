---
import Base from "../../layouts/Base.astro";
import { directusGet } from "../../lib/directus";

export const prerender = false;

type VideoItem = {
  id: number;
  status: string;
  slug: string;
  title: string;
  description?: string | null;
  youtube_url?: string | null;
  category?: string | null; // Directus category
};

type DirectusResp = { data: VideoItem[] };

let videos: VideoItem[] = [];

try {
  const resp = await directusGet<DirectusResp>(
    `/items/videos?fields=id,status,slug,title,description,youtube_url,category&filter[status][_eq]=published&sort=-id&limit=120`
  );
  videos = resp?.data ?? [];
} catch {
  videos = [];
}

// -------------------- helpers --------------------
function youtubeIdFromUrl(url?: string | null) {
  if (!url) return null;
  try {
    const u = new URL(url);

    if (u.hostname.includes("youtu.be")) {
      return u.pathname.split("/").filter(Boolean)[0] ?? null;
    }
    if (u.searchParams.get("v")) return u.searchParams.get("v");

    const parts = u.pathname.split("/").filter(Boolean);

    const embedIndex = parts.indexOf("embed");
    if (embedIndex !== -1) return parts[embedIndex + 1] ?? null;

    const shortsIndex = parts.indexOf("shorts");
    if (shortsIndex !== -1) return parts[shortsIndex + 1] ?? null;

    return null;
  } catch {
    return null;
  }
}

function normCat(s?: string | null) {
  return String(s ?? "").trim();
}

function hashStr(str: string) {
  let h = 0;
  for (let i = 0; i < str.length; i++) h = (h * 31 + str.charCodeAt(i)) | 0;
  return Math.abs(h);
}

// ✅ Tailwind-safe palette (explicit class strings)
const CAT_PALETTE = [
  "border-cyan-300/35 bg-cyan-400/15 text-cyan-200",
  "border-emerald-300/30 bg-emerald-400/15 text-emerald-200",
  "border-violet-300/30 bg-violet-400/15 text-violet-200",
  "border-amber-300/30 bg-amber-400/15 text-amber-200",
  "border-pink-300/30 bg-pink-400/15 text-pink-200",
  "border-sky-300/30 bg-sky-400/15 text-sky-200",
  "border-lime-300/30 bg-lime-400/15 text-lime-200",
  "border-orange-300/30 bg-orange-400/15 text-orange-200",
] as const;

function catColorClass(name: string) {
  const idx = hashStr(name) % CAT_PALETTE.length;
  return CAT_PALETTE[idx];
}

function badgeCountClass(isActive: boolean) {
  return isActive
    ? "border border-white/20 bg-white/10 text-white/90"
    : "border border-white/10 bg-white/5 text-white/70";
}

// -------------------- filtering (Directus categories only + All) --------------------
const catParam = Astro.url.searchParams.get("cat");
const activeCat = catParam ? decodeURIComponent(catParam) : null;

// categories list from Directus values only (non-empty)
const counts = new Map<string, number>();
for (const v of videos) {
  const c = normCat(v.category);
  if (!c) continue;
  counts.set(c, (counts.get(c) ?? 0) + 1);
}

const directusCategories = Array.from(counts.entries())
  .sort((a, b) => b[1] - a[1])
  .map(([name, count]) => ({ name, count }));

let filtered = videos;
if (activeCat) {
  filtered = videos.filter((v) => normCat(v.category) === activeCat);
}

const total = videos.length;
const shown = filtered.length;

function hrefForCat(name: string) {
  return `/videos?cat=${encodeURIComponent(name)}`;
}

function isActiveCat(name: string) {
  return !!activeCat && activeCat === name;
}

function isAllActive() {
  return !activeCat;
}
---

<Base
  title="Videos — RadioABF"
  description="Interviews, DJ sets and exclusive content — curated for the ABF community."
  canonical="/videos"
  image="/og-image.jpg"
>
  <div id="videosPageRoot">
    <!-- HERO -->
    <section class="relative overflow-hidden rounded-3xl border border-white/10 bg-[#0A1F33] p-5 sm:p-6 mb-6 shadow-2xl">
      <div class="pointer-events-none absolute -top-40 -left-40 w-[520px] h-[520px] rounded-full bg-cyan-500/15 blur-[120px]"></div>
      <div class="pointer-events-none absolute -bottom-40 -right-40 w-[520px] h-[520px] rounded-full bg-blue-600/15 blur-[120px]"></div>

      <div class="relative z-10">
        <div class="flex items-start justify-between gap-4 flex-wrap">
          <!-- LEFT -->
          <div class="min-w-0">
            <div class="flex items-center gap-3 text-sm tracking-widest text-white/60 uppercase mb-3">
              <span class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></span>
              Videos
            </div>

            <h1 class="text-3xl sm:text-4xl font-extrabold leading-tight text-white">
              Videos & Shows <span class="text-cyan-200">by RadioABF</span>
            </h1>

            <p class="text-white/65 mt-3 max-w-2xl">
              Interviews, DJ sets and exclusive content — curated for the ABF community.
            </p>

            <!-- ✅ Categories under subtitle (ALL + Directus categories only) -->
            <div class="mt-4 flex flex-wrap items-center gap-2">
              <!-- ALL -->
              <a
                href="/videos"
                class={[
                  "inline-flex items-center gap-2 rounded-full border px-4 py-2 text-sm font-extrabold transition-colors",
                  isAllActive()
                    ? "border-white/25 bg-white/10 text-white"
                    : "border-white/10 bg-white/5 text-white/80 hover:bg-white/10",
                ].join(" ")}
                aria-label="Browse all videos"
                title="Browse all videos"
              >
                <span>ALL</span>
                <span class={["inline-flex items-center justify-center rounded-full px-2 py-[2px] text-[11px] font-bold tabular-nums", badgeCountClass(isAllActive())].join(" ")}>
                  {total}
                </span>
              </a>

              {directusCategories.map((c) => {
                const active = isActiveCat(c.name);
                const color = catColorClass(c.name);
                return (
                  <a
                    href={hrefForCat(c.name)}
                    class={[
                      "inline-flex items-center gap-2 rounded-full border px-4 py-2 text-sm font-extrabold transition-colors",
                      active
                        ? `${color} ring-1 ring-white/10`
                        : `${color} hover:brightness-110`,
                    ].join(" ")}
                    aria-label={`Browse ${c.name}`}
                    title={`Browse ${c.name}`}
                  >
                    <span>{c.name.toUpperCase()}</span>
                    <span class={["inline-flex items-center justify-center rounded-full px-2 py-[2px] text-[11px] font-bold tabular-nums", badgeCountClass(active)].join(" ")}>
                      {c.count}
                    </span>
                  </a>
                );
              })}

              {activeCat ? (
                <a
                  href="/videos"
                  class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-4 py-2 text-sm font-extrabold text-white/85 hover:bg-white/10 transition-colors"
                  aria-label="Reset"
                  title="Reset"
                >
                  RESET
                </a>
              ) : null}
            </div>
          </div>

          <!-- RIGHT -->
          <div class="w-full sm:w-[340px]">
            <!-- Stats card -->
            <div class="rounded-3xl border border-white/10 bg-[#07182A]/70 backdrop-blur-xl p-4 shadow-2xl">
              <div class="flex items-center justify-between">
                <div class="text-xs text-white/60 uppercase tracking-widest">Library</div>
                <div class="text-xs text-white/50 tabular-nums">{total} total</div>
              </div>

              <div class="mt-3 grid grid-cols-3 gap-2">
                <div class="rounded-2xl border border-white/10 bg-white/5 p-3">
                  <div class="text-[10px] text-white/50 uppercase tracking-widest">Showing</div>
                  <div class="mt-1 text-sm font-semibold text-white tabular-nums">{shown}</div>
                </div>

                <div class="rounded-2xl border border-white/10 bg-white/5 p-3">
                  <div class="text-[10px] text-white/50 uppercase tracking-widest">Category</div>
                  <div class="mt-1 text-sm font-semibold text-white line-clamp-1">
                    {activeCat ? activeCat : "All"}
                  </div>
                </div>

                <div class="rounded-2xl border border-white/10 bg-white/5 p-3">
                  <div class="text-[10px] text-white/50 uppercase tracking-widest">Updated</div>
                  <div class="mt-1 text-sm font-semibold text-white">Live</div>
                </div>
              </div>

              <div class="mt-3 text-xs text-white/60 leading-relaxed">
                Tap a category to filter the library.
              </div>
            </div>

            <!-- Buttons under the card -->
            <div class="mt-3 flex items-center justify-start sm:justify-end gap-2 flex-nowrap overflow-x-auto no-scrollbar">
              <a
                href="#videosLibrary"
                class="text-xs font-extrabold text-[#061220] bg-cyan-300 hover:bg-cyan-200 border border-cyan-200/30 px-3 py-2 rounded-xl flex-none transition-colors shadow-lg shadow-cyan-500/20"
              >
                Browse ↓
              </a>

              <a
                href="/music"
                class="text-xs font-extrabold text-white/90 border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 rounded-xl flex-none transition-colors"
              >
                Music Portal →
              </a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ONE BIG CARD -->
    <section
      id="videosLibrary"
      class="rounded-3xl border border-white/10 bg-[#0A1F33] overflow-hidden shadow-xl"
    >
      <div class="p-5 md:p-6 border-b border-white/10">
        <div class="flex items-start justify-between gap-4 flex-wrap">
          <div class="min-w-0">
            <div class="text-sm text-white/60 uppercase tracking-wider">Videos library</div>
            <div class="text-xs text-white/50 mt-1">
              {activeCat ? (
                <>Category: <span class="text-white/70 font-semibold">{activeCat}</span> • <span class="tabular-nums">{shown}</span> results</>
              ) : (
                <>All videos • <span class="tabular-nums">{shown}</span> items</>
              )}
            </div>
          </div>

          {activeCat ? (
            <a
              href="/videos"
              class="text-xs font-extrabold text-white/90 border border-white/10 bg-white/5 hover:bg-white/10 px-3 py-2 rounded-xl flex-none transition-colors"
            >
              Reset filter
            </a>
          ) : null}
        </div>
      </div>

      <div class="p-5 md:p-6">
        {filtered.length === 0 ? (
          <div class="rounded-2xl border border-white/10 bg-white/5 p-5 text-sm text-white/70">
            No videos found.
            <a class="text-cyan-300 hover:text-cyan-200 ml-2" href="/videos">Reset</a>
          </div>
        ) : (
          <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
            {filtered.map((v) => {
              const yid = youtubeIdFromUrl(v.youtube_url);
              const thumb = yid ? `https://i.ytimg.com/vi/${yid}/hqdefault.jpg` : null;
              const cat = normCat(v.category);

              return (
                <a
                  href={`/videos/${v.slug}`}
                  class="group rounded-3xl border border-white/10 bg-[#07182A] overflow-hidden shadow-2xl hover:scale-[1.02] transition-transform"
                >
                  <div class="relative aspect-video bg-black">
                    {thumb ? (
                      <img
                        src={thumb}
                        alt={v.title}
                        class="w-full h-full object-cover"
                        loading="lazy"
                      />
                    ) : (
                      <div class="absolute inset-0 flex items-center justify-center text-xs text-white/50">
                        Invalid YouTube link
                      </div>
                    )}

                    <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-black/55 via-black/10 to-transparent opacity-90"></div>

                    {cat ? (
                      <div class="absolute left-3 top-3">
                        <span class={["inline-flex items-center rounded-full border px-2.5 py-1 text-[10px] font-extrabold backdrop-blur", catColorClass(cat), "bg-black/35"].join(" ")}>
                          {cat.toUpperCase()}
                        </span>
                      </div>
                    ) : null}
                  </div>

                  <div class="p-4">
                    <div class="flex items-start justify-between gap-3">
                      <h2 class="text-sm font-semibold text-white line-clamp-1">
                        {v.title}
                      </h2>
                      <span class="shrink-0 text-[10px] text-white/50 border border-white/10 bg-white/5 rounded-full px-2 py-1">
                        ABF
                      </span>
                    </div>

                    {v.description ? (
                      <p class="text-xs text-white/60 mt-1 line-clamp-2">
                        {v.description}
                      </p>
                    ) : (
                      <p class="text-xs text-white/40 mt-1 line-clamp-2">
                        Watch on RadioABF Videos.
                      </p>
                    )}

                    <div class="mt-3 inline-flex items-center gap-2 text-xs text-cyan-300 group-hover:text-cyan-200 transition-colors">
                      Open video →
                    </div>
                  </div>
                </a>
              );
            })}
          </div>
        )}
      </div>
    </section>

    <style>
      .tabular-nums { font-variant-numeric: tabular-nums; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
  </div>
</Base>