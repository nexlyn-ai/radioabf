---
import Base from "../../layouts/Base.astro";
import { directusGet, directusAsset } from "../../lib/directus";

export const prerender = false;

type NewsItem = {
  id: number;
  status: string;
  title: string;
  slug: string;
  excerpt?: string | null;
  content?: string | null;
  cover?: string | null;
  category?: string | null;
  published_at?: string | null;
  date_created?: string | null;
};

type DirectusListResp = { data: NewsItem[] };

const { slug } = Astro.params;
const safeSlug = String(slug || "").trim();

const fields = "id,status,title,slug,excerpt,content,cover,category,published_at,date_created";

let item: NewsItem | null = null;

try {
  const resp = await directusGet<DirectusListResp>(
    `/items/news?fields=${encodeURIComponent(fields)}` +
      `&filter[status][_eq]=published` +
      `&filter[slug][_eq]=${encodeURIComponent(safeSlug)}` +
      `&limit=1`
  );
  item = resp?.data?.[0] ?? null;
} catch {
  item = null;
}

if (!item) return new Response("Not found", { status: 404 });

// Date format (EN)
const fmtDate = (iso?: string | null) => {
  if (!iso) return "";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "";
  return d.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "2-digit" });
};

const dateLabel = fmtDate(item.published_at || item.date_created);

const coverUrl = item.cover
  ? directusAsset(item.cover, { w: 1400, h: 900, fit: "cover", quality: 88 })
  : null;

// Cache SSR
Astro.response.headers.set("Cache-Control", "public, s-maxage=300, stale-while-revalidate=86400");

// Meta
const metaTitle = `${item.title} — RadioABF`;
const metaDesc = item.excerpt || "Latest updates from RadioABF.";
const canonicalPath = `/news/${item.slug}`;
---

<Base title={metaTitle} description={metaDesc} canonical={canonicalPath}>
  <div class="abfPageWrap">

    <!-- HERO FEATURED CARD -->
    <section class="heroCard">
      <div class="heroGlow a"></div>
      <div class="heroGlow b"></div>

      <div class="heroGrid">
        <!-- LEFT -->
        <div class="heroLeft">
          <div class="kicker">
            <span class="dot"></span>
            News
          </div>

          <div class="pillRow">
            <a href="/news" class="pillBack">← Back</a>

            {item.category ? (
              <a href={`/news?cat=${item.category}`} class={`pillCat ${item.category}`}>
                {item.category}
              </a>
            ) : null}

            {dateLabel ? <span class="pillDate">{dateLabel}</span> : null}
          </div>

          <h1 class="heroTitle">{item.title}</h1>

          {item.excerpt ? (
            <p class="heroExcerpt">{item.excerpt}</p>
          ) : null}
        </div>

        <!-- RIGHT -->
        {coverUrl ? (
          <div class="heroMedia">
            <img src={coverUrl} alt="" class="heroImg" loading="eager" decoding="async" />
            <div class="heroShade"></div>
          </div>
        ) : null}
      </div>
    </section>

    <!-- CONTENT + SHARE BUTTONS AT BOTTOM -->
    <article class="contentCard">
      {item.content ? (
        <div class="proseWrap" set:html={item.content} />
      ) : (
        <div class="text-white/70">No content.</div>
      )}

      <!-- Share section - centered at bottom, ultra compact -->
      <div class="shareSection">
        <div class="shareTitle">Share this article</div>
        <div class="shareButtons">
          <a
            href={`https://x.com/intent/post?url=${Astro.url}&text=${encodeURIComponent(item.title + " — RadioABF")}`}
            target="_blank"
            rel="noopener noreferrer"
            class="shareBtn"
            title="Share on X"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
          </a>
          <a
            href={`https://www.facebook.com/sharer/sharer.php?u=${Astro.url}&quote=${encodeURIComponent(item.title + " — RadioABF")}&hashtag=%23RadioABF`}
            target="_blank"
            rel="noopener noreferrer"
            class="shareBtn"
            title="Share on Facebook"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.84 3.44 8.87 8 9.8V15H8v-3h2v-1.5c0-2.5 1.5-3.88 3.75-3.88h1.75v3h-1.25c-.69 0-1.25.56-1.25 1.25V12h2.5l-.5 3h-2v6.8c4.56-.93 8-4.96 8-9.8z"/>
            </svg>
          </a>
          <a
            href={`https://www.linkedin.com/shareArticle?mini=true&url=${Astro.url}&title=${encodeURIComponent(item.title + " — RadioABF")}&summary=${encodeURIComponent(item.excerpt || metaDesc)}&source=RadioABF`}
            target="_blank"
            rel="noopener noreferrer"
            class="shareBtn"
            title="Share on LinkedIn"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
            </svg>
          </a>
          <a
            href={`https://api.whatsapp.com/send?text=${encodeURIComponent(item.title + " — RadioABF\n" + Astro.url)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="shareBtn"
            title="Share on WhatsApp"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21 5.46 0 9.91-4.45 9.91-9.91 0-2.65-1.03-5.14-2.9-7.01C17.18 3.03 14.69 2 12.04 2M12.04 3.67c4.66 0 8.47 3.81 8.47 8.47 0 4.66-3.81 8.47-8.47 8.47-.92 0-1.82-.15-2.68-.42l-.28-.17c-.34-.21-.71-.41-1.1-.58l-3.72.97 1-.96c-.16-.39-.3-.79-.41-1.21-.27-.66-.42-1.36-.42-2.1 0-4.66 3.81-8.47 8.47-8.47M8.53 7.33c-.16 0-.43.06-.66.31-.2.22-.43.57-.43.97 0 .43.13.81.39 1.18.25.37.59.74.96 1.1.38.35.85.66 1.4.93.56.27 1.18.45 1.85.58.67.13 1.3.04 1.86-.18.56-.22 1.04-.61 1.39-1.08.35-.47.55-.99.55-1.55 0-.43-.09-.82-.27-1.16-.18-.34-.43-.61-.75-.81-.32-.2-.7-.3-1.13-.3-.43 0-.83.1-1.19.3-.36.19-.65.46-.86.8l-.29.34c-.14.17-.33.29-.54.29-.21 0-.39-.12-.54-.29l-.27-.3c-.21-.34-.5-.61-.86-.8-.36-.19-.76-.3-1.19-.3"/>
            </svg>
          </a>
          <button
            class="shareBtn"
            onclick={`
              navigator.clipboard.writeText('${item.title} — RadioABF\n${Astro.url}');
              const btn = this;
              const original = btn.innerHTML;
              btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
              setTimeout(() => btn.innerHTML = original, 2000);
            `}
            title="Copy link (Instagram, etc.)"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          </button>
        </div>
      </div>
    </article>
  </div>

  <style is:inline>
    .abfPageWrap{
      width:100%;
      max-width:72rem;
      margin-left:auto;
      margin-right:auto;
    }

    /* HERO CARD */
    .heroCard{
      position:relative;
      overflow:hidden;
      border-radius:28px;
      border:1px solid rgba(255,255,255,.10);
      background:#0A1F33;
      padding:18px;
      margin-bottom:28px;
      box-shadow:0 24px 70px rgba(0,0,0,.35);
    }
    @media (min-width: 640px){
      .heroCard{ padding:22px; }
    }

    .heroGlow{
      position:absolute;
      width:520px;
      height:520px;
      border-radius:999px;
      filter: blur(120px);
      opacity:.55;
      pointer-events:none;
    }
    .heroGlow.a{ top:-220px; left:-220px; background: rgba(34,211,238,.35); }
    .heroGlow.b{ bottom:-220px; right:-220px; background: rgba(59,130,246,.35); }

    /* GRID */
    .heroGrid{
      position:relative;
      z-index:1;
      display:grid;
      gap:16px;
      grid-template-columns: 1fr;
      align-items:stretch;
    }
    @media (min-width: 900px){
      .heroGrid{
        grid-template-columns: 1.35fr .65fr;
        gap:18px;
        align-items:start;
      }
    }

    .heroLeft{
      min-width:0;
      padding:6px 6px;
    }

    .kicker{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: rgba(255,255,255,.60);
      margin-bottom:10px;
      font-weight:800;
    }
    .dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background: rgb(34,211,238);
      box-shadow: 0 0 0 6px rgba(34,211,238,.12);
      animation: pulse 1.6s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform: scale(1); opacity:1; }
      50%{ transform: scale(1.12); opacity:.85; }
    }

    .pillRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .pillBack,.pillDate,.pillCat{
      display:inline-flex;
      align-items:center;
      height:28px;
      padding:0 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.75);
      transition: transform .18s ease, background .18s ease, color .18s ease;
      text-decoration:none;
    }
    .pillBack:hover{ background:rgba(255,255,255,.10); color:rgba(255,255,255,.92); }
    .pillCat:hover{ transform: translateY(-1px); }

    .pillCat.radio{
      border-color:rgba(34,211,238,.35);
      background:rgba(11,37,64,.10);
      color:rgba(165,243,252,.95);
    }
    .pillCat.music{
      border-color:rgba(96,165,250,.35);
      background:rgba(11,37,64,.10);
      color:rgba(191,219,254,.95);
    }

    .heroTitle{
      margin:0;
      font-weight:900;
      letter-spacing:-0.02em;
      line-height:1.12;
      font-size: 22px;
      color:#fff;
      max-width: 56ch;
      word-break: break-word;
    }
    @media (min-width: 640px){
      .heroTitle{ font-size: 28px; }
    }
    @media (min-width: 1024px){
      .heroTitle{ font-size: 30px; }
    }

    .heroExcerpt{
      margin-top:12px;
      margin-bottom:0;
      color: rgba(255,255,255,.66);
      line-height:1.7;
      font-size: 14px;
      max-width: 78ch;
      display:-webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }

    .heroMedia{
      position:relative;
      border-radius:22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      box-shadow: 0 18px 55px rgba(0,0,0,.30);
      aspect-ratio: 16 / 9;
      max-height: 250px;
      width: 100%;
      max-width: 520px;
      justify-self: end;
    }

    @media (min-width: 900px){
      .heroMedia{
        margin-top: 54px;
        max-height: 230px;
      }
    }

    .heroMedia::before{
      content:"";
      position:absolute;
      inset:-40px;
      background: radial-gradient(circle at 30% 40%, rgba(34,211,238,.22), transparent 55%);
      filter: blur(10px);
      opacity:.9;
      pointer-events:none;
      z-index:0;
    }

    .heroImg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      transform: scale(1.10);
      opacity:.95;
      transition: transform .4s ease;
      z-index:1;
    }
    .heroMedia:hover .heroImg{
      transform: scale(1.14);
    }

    .heroShade{
      position:absolute;
      inset:0;
      background: linear-gradient(
        to top,
        rgba(5,11,20,.65),
        rgba(5,11,20,.15),
        transparent
      );
      z-index:2;
    }

    /* CONTENT CARD + SHARE SECTION */
    .contentCard{
      border-radius:28px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      padding:32px;
      padding-bottom:56px;
    }

    .proseWrap{
      color:rgba(255,255,255,.82);
      font-size:15.5px;
      line-height:1.85;
      margin-bottom:48px;
    }
    .proseWrap img{
      max-width:100%;
      border-radius:18px;
      margin:28px 0;
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 14px 45px rgba(0,0,0,.35);
    }
    .proseWrap a{
      color:rgba(165,243,252,.95);
      text-decoration:underline;
      text-decoration-color: rgba(165,243,252,.35);
    }
    .proseWrap a:hover{
      text-decoration-color: rgba(165,243,252,.85);
    }

    /* Share section - ultra compact */
    .shareSection{
      text-align:center;
      margin-top:48px;
      padding-top:36px;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .shareTitle{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:rgba(255,255,255,.65);
      margin-bottom:14px;
      font-weight:700;
    }
    .shareButtons{
      display: inline-flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
      background: rgba(10,31,51,0.45);
      backdrop-blur-xl;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 6px 25px rgba(0,0,0,0.25), 0 0 18px rgba(34,211,238,0.08);
    }
    .shareBtn{
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.80);
      transition: all 0.3s ease;
    }
    .shareBtn:hover{
      background: rgba(34,211,238,0.16);
      color: white;
      transform: translateY(-2px) scale(1.04);
      box-shadow: 0 6px 18px rgba(34,211,238,0.20);
    }
  </style>
</Base>