---
import Base from "../../layouts/Base.astro";
import { directusGet, directusAsset } from "../../lib/directus";

export const prerender = false;

type NewsItem = {
  id: number;
  status: string;
  title: string;
  slug: string;
  excerpt?: string | null;
  content?: string | null;
  cover?: string | null;
  category?: string | null;
  published_at?: string | null;
  date_created?: string | null;
};

type DirectusListResp = { data: NewsItem[] };

const { slug } = Astro.params;
const safeSlug = String(slug || "").trim();

const fields = "id,status,title,slug,excerpt,content,cover,category,published_at,date_created";

let item: NewsItem | null = null;

try {
  const resp = await directusGet<DirectusListResp>(
    `/items/news?fields=${encodeURIComponent(fields)}` +
      `&filter[status][_eq]=published` +
      `&filter[slug][_eq]=${encodeURIComponent(safeSlug)}` +
      `&limit=1`
  );
  item = resp?.data?.[0] ?? null;
} catch {
  item = null;
}

if (!item) return new Response("Not found", { status: 404 });

// Date format (EN)
const fmtDate = (iso?: string | null) => {
  if (!iso) return "";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "";
  return d.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "2-digit" });
};

const dateLabel = fmtDate(item.published_at || item.date_created);

const coverUrl = item.cover
  ? directusAsset(item.cover, { w: 1400, h: 900, fit: "cover", quality: 88 })
  : null;

// Cache SSR
Astro.response.headers.set("Cache-Control", "public, s-maxage=300, stale-while-revalidate=86400");

// Meta
const metaTitle = `${item.title} — RadioABF`;
const metaDesc = item.excerpt || "Latest updates from RadioABF.";
const canonicalPath = `/news/${item.slug}`;
---

<Base title={metaTitle} description={metaDesc} canonical={canonicalPath}>
  <div class="abfPageWrap">

    <!-- HERO FEATURED CARD -->
    <section class="heroCard">
      <div class="heroGlow a"></div>
      <div class="heroGlow b"></div>

      <div class="heroGrid">
        <!-- LEFT -->
        <div class="heroLeft">
          <!-- Boutons de partage premium -->
          <div class="shareButtons">
            <a
              href={`https://x.com/intent/post?url=${Astro.url}&text=${encodeURIComponent(item.title + " — RadioABF")}`}
              target="_blank"
              rel="noopener noreferrer"
              class="shareBtn"
              title="Share on X"
            >
              <svg xmlns="http://www.w plateforme3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
              </svg>
            </a>
            <a
              href={`https://www.facebook.com/sharer/sharer.php?u=${Astro.url}&quote=${encodeURIComponent(item.title + " — RadioABF")}`}
              target="_blank"
              rel="noopener noreferrer"
              class="shareBtn"
              title="Share on Facebook"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
              </svg>
            </a>
            <button
              class="shareBtn"
              onclick={`
                navigator.clipboard.writeText('${Astro.url}');
                const btn = this;
                const original = btn.innerHTML;
                btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                setTimeout(() => btn.innerHTML = original, 2000);
              `}
              title="Copy link"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            </button>
          </div>

          <div class="kicker">
            <span class="dot"></span>
            News
          </div>

          <div class="pillRow">
            <a href="/news" class="pillBack">← Back</a>

            {item.category ? (
              <a href={`/news?cat=${item.category}`} class={`pillCat ${item.category}`}>
                {item.category}
              </a>
            ) : null}

            {dateLabel ? <span class="pillDate">{dateLabel}</span> : null}
          </div>

          <h1 class="heroTitle">{item.title}</h1>

          {item.excerpt ? (
            <p class="heroExcerpt">{item.excerpt}</p>
          ) : null}
        </div>

        <!-- RIGHT -->
        {coverUrl ? (
          <div class="heroMedia">
            <img src={coverUrl} alt="" class="heroImg" loading="eager" decoding="async" />
            <div class="heroShade"></div>
          </div>
        ) : null}
      </div>
    </section>

    <!-- CONTENT -->
    <article class="contentCard">
      {item.content ? (
        <div class="proseWrap" set:html={item.content} />
      ) : (
        <div class="text-white/70">No content.</div>
      )}
    </article>
  </div>

  <style is:inline>
    .abfPageWrap{
      width:100%;
      max-width:72rem;
      margin-left:auto;
      margin-right:auto;
    }

    /* HERO CARD */
    .heroCard{
      position:relative;
      overflow:hidden;
      border-radius:28px;
      border:1px solid rgba(255,255,255,.10);
      background:#0A1F33;
      padding:18px;
      margin-bottom:18px;
      box-shadow:0 24px 70px rgba(0,0,0,.35);
    }
    @media (min-width: 640px){
      .heroCard{ padding:22px; }
    }

    .heroGlow{
      position:absolute;
      width:520px;
      height:520px;
      border-radius:999px;
      filter: blur(120px);
      opacity:.55;
      pointer-events:none;
    }
    .heroGlow.a{ top:-220px; left:-220px; background: rgba(34,211,238,.35); }
    .heroGlow.b{ bottom:-220px; right:-220px; background: rgba(59,130,246,.35); }

    /* Share buttons - premium, dans le bloc texte, haut à droite */
    .shareButtons{
      position: absolute;
      top: 18px;
      right: 18px;
      z-index: 20;
      display: flex;
      gap: 8px;
      background: rgba(10,31,51,0.65);
      backdrop-blur-xl;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.15);
      box-shadow: 0 8px 32px rgba(0,0,0,0.35), 0 0 20px rgba(34,211,238,0.15);
    }
    @media (min-width: 640px){
      .shareButtons{ top: 22px; right: 22px; }
    }
    .shareBtn{
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.90);
      transition: all 0.25s ease;
    }
    .shareBtn:hover{
      background: rgba(34,211,238,0.25);
      color: white;
      transform: translateY(-3px) scale(1.08);
      box-shadow: 0 8px 20px rgba(34,211,238,0.3);
    }

    /* GRID */
    .heroGrid{
      position:relative;
      z-index:1;
      display:grid;
      gap:16px;
      grid-template-columns: 1fr;
      align-items:stretch;
    }
    @media (min-width: 900px){
      .heroGrid{
        grid-template-columns: 1.35fr .65fr;
        gap:18px;
        align-items:start;
      }
    }

    .heroLeft{
      min-width:0;
      padding:6px 6px;
      position: relative;
    }

    .kicker{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: rgba(255,255,255,.60);
      margin-bottom:10px;
      font-weight:800;
    }
    .dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background: rgb(34,211,238);
      box-shadow: 0 0 0 6px rgba(34,211,238,.12);
      animation: pulse 1.6s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform: scale(1); opacity:1; }
      50%{ transform: scale(1.12); opacity:.85; }
    }

    .pillRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .pillBack,.pillDate,.pillCat{
      display:inline-flex;
      align-items:center;
      height:28px;
      padding:0 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.75);
      transition: transform .18s ease, background .18s ease, color .18s ease;
      text-decoration:none;
    }
    .pillBack:hover{ background:rgba(255,255,255,.10); color:rgba(255,255,255,.92); }
    .pillCat:hover{ transform: translateY(-1px); }

    .pillCat.radio{
      border-color:rgba(34,211,238,.35);
      background:rgba(34,211,238,.10);
      color:rgba(165,243,252,.95);
    }
    .pillCat.music{
      border-color:rgba(96,165,250,.35);
      background:rgba(96,165,250,.10);
      color:rgba(191,219,254,.95);
    }

    .heroTitle{
      margin:0;
      font-weight:900;
      letter-spacing:-0.02em;
      line-height:1.12;
      font-size: 22px;
      color:#fff;
      max-width: 56ch;
      word-break: break-word;
    }
    @media (min-width: 640px){
      .heroTitle{ font-size: 28px; }
    }
    @media (min-width: 1024px){
      .heroTitle{ font-size: 30px; }
    }

    .heroExcerpt{
      margin-top:12px;
      margin-bottom:0;
      color: rgba(255,255,255,.66);
      line-height:1.7;
      font-size: 14px;
      max-width: 78ch;
      display:-webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }

    .heroMedia{
      position:relative;
      border-radius:22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      box-shadow: 0 18px 55px rgba(0,0,0,.30);
      aspect-ratio: 16 / 9;
      max-height: 250px;
      width: 100%;
      max-width: 520px;
      justify-self: end;
    }

    @media (min-width: 900px){
      .heroMedia{
        margin-top: 54px;
        max-height: 230px;
      }
    }

    .heroMedia::before{
      content:"";
      position:absolute;
      inset:-40px;
      background: radial-gradient(circle at 30% 40%, rgba(34,211,238,.22), transparent 55%);
      filter: blur(10px);
      opacity:.9;
      pointer-events:none;
      z-index:0;
    }

    .heroImg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      transform: scale(1.10);
      opacity:.95;
      transition: transform .4s ease;
      z-index:1;
    }
    .heroMedia:hover .heroImg{
      transform: scale(1.14);
    }

    .heroShade{
      position:absolute;
      inset:0;
      background: linear-gradient(
        to top,
        rgba(5,11,20,.65),
        rgba(5,11,20,.15),
        transparent
      );
      z-index:2;
    }

    .contentCard{
      border-radius:28px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      padding:24px;
    }

    .proseWrap{
      color:rgba(255,255,255,.80);
      font-size:15px;
      line-height:1.8;
    }
    .proseWrap img{
      max-width:100%;
      border-radius:18px;
      margin:16px 0;
      border:1px solid rgba(255,255,255,.10);
    }
    .proseWrap a{
      color:rgba(165,243,252,.95);
      text-decoration:underline;
      text-decoration-color: rgba(165,243,252,.35);
    }
    .proseWrap a:hover{
      text-decoration-color: rgba(165,243,252,.85);
    }
  </style>
</Base>