---
import Base from "../../layouts/Base.astro";
import { directusGet, directusAsset } from "../../lib/directus";

export const prerender = false;

type NewsItem = {
  id: number;
  status: string;
  title: string;
  slug: string;
  excerpt?: string | null;
  content?: string | null;
  cover?: string | null;
  category?: string | null;
  published_at?: string | null;
  date_created?: string | null;
};

type DirectusListResp = { data: NewsItem[] };

const { slug } = Astro.params;
const safeSlug = String(slug || "").trim();

const fields = "id,status,title,slug,excerpt,content,cover,category,published_at,date_created";

let item: NewsItem | null = null;

try {
  const resp = await directusGet<DirectusListResp>(
    `/items/news?fields=${encodeURIComponent(fields)}` +
      `&filter[status][_eq]=published` +
      `&filter[slug][_eq]=${encodeURIComponent(safeSlug)}` +
      `&limit=1`
  );
  item = resp?.data?.[0] ?? null;
} catch {
  item = null;
}

if (!item) return new Response("Not found", { status: 404 });

// Date format (EN)
const fmtDate = (iso?: string | null) => {
  if (!iso) return "";
  const d = new Date(iso);
  if (Number.isNaN(d.getTime())) return "";
  return d.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "2-digit" });
};

const dateLabel = fmtDate(item.published_at || item.date_created);

const coverUrl = item.cover
  ? directusAsset(item.cover, { w: 1400, h: 900, fit: "cover", quality: 88 })
  : null;

// Cache SSR
Astro.response.headers.set("Cache-Control", "public, s-maxage=300, stale-while-revalidate=86400");

// Meta
const metaTitle = `${item.title} — RadioABF`;
const metaDesc = item.excerpt || "Latest updates from RadioABF.";
const canonicalPath = `/news/${item.slug}`;
---

<Base title={metaTitle} description={metaDesc} canonical={canonicalPath}>
  <div class="abfPageWrap">

    <!-- HERO FEATURED CARD -->
    <section class="heroCard">
      <div class="heroGlow a"></div>
      <div class="heroGlow b"></div>

      <div class="heroGrid">
        <!-- LEFT -->
        <div class="heroLeft">
          <div class="kicker">
            <span class="dot"></span>
            News
          </div>

          <div class="pillRow">
            <a href="/news" class="pillBack">← Back</a>

            {item.category ? (
              <a href={`/news?cat=${item.category}`} class={`pillCat ${item.category}`}>
                {item.category}
              </a>
            ) : null}

            {dateLabel ? <span class="pillDate">{dateLabel}</span> : null}
          </div>

          <h1 class="heroTitle">{item.title}</h1>

          {item.excerpt ? (
            <p class="heroExcerpt">{item.excerpt}</p>
          ) : null}
        </div>

        <!-- RIGHT -->
        {coverUrl ? (
          <div class="heroMedia">
            <img src={coverUrl} alt="" class="heroImg" loading="eager" decoding="async" />
            <div class="heroShade"></div>
          </div>
        ) : null}
      </div>
    </section>

    <!-- CONTENT + SHARE BUTTONS AT BOTTOM -->
    <article class="contentCard">
      {item.content ? (
        <div class="proseWrap" set:html={item.content} />
      ) : (
        <div class="text-white/70">No content.</div>
      )}

      <!-- Share section - centered at bottom -->
      <div class="shareSection">
        <div class="shareTitle">Share this article</div>
        <div class="shareButtons">
          <a
            href={`https://x.com/intent/post?url=${Astro.url}&text=${encodeURIComponent(item.title + " — RadioABF")}`}
            target="_blank"
            rel="noopener noreferrer"
            class="shareBtn"
            title="Share on X"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
          </a>
          <a
            href={`https://www.facebook.com/sharer/sharer.php?u=${Astro.url}&quote=${encodeURIComponent(item.title + " — RadioABF")}&hashtag=%23RadioABF`}
            target="_blank"
            rel="noopener noreferrer"
            class="shareBtn"
            title="Share on Facebook"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
              <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
            </svg>
          </a>
          <a
            href={`https://www.linkedin.com/shareArticle?mini=true&url=${Astro.url}&title=${encodeURIComponent(item.title + " — RadioABF")}&summary=${encodeURIComponent(item.excerpt || metaDesc)}&source=RadioABF`}
            target="_blank"
            rel="noopener noreferrer"
            class="shareBtn"
            title="Share on LinkedIn"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
            </svg>
          </a>
          <a
            href={`https://api.whatsapp.com/send?text=${encodeURIComponent(item.title + " — RadioABF\n" + Astro.url)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="shareBtn"
            title="Share on WhatsApp"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.626.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004c-2.377 0-4.708-.608-6.75-1.758l-.484-.288-4.875.974 1.002-4.603-.235-.486c-1.194-2.47-1.823-5.314-1.82-8.227.003-6.653 5.42-12.071 12.074-12.071 3.226 0 6.263 1.258 8.544 3.541 2.281 2.282 3.536 5.314 3.536 8.542 0 6.652-5.42 12.07-12.072 12.07m10.5-19.875c-2.737-2.737-6.367-4.25-10.23-4.25-7.963 0-14.444 6.48-14.444 14.445 0 2.547.668 5.046 1.938 7.232l-2.048 7.48 7.653-2.01c2.104 1.148 4.465 1.756 6.905 1.756 7.963 0 14.444-6.48 14.444-14.445 0-3.863-1.512-7.492-4.25-10.23"/>
            </svg>
          </a>
          <button
            class="shareBtn"
            onclick={`
              navigator.clipboard.writeText('${item.title} — RadioABF\n${Astro.url}');
              const btn = this;
              const original = btn.innerHTML;
              btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
              setTimeout(() => btn.innerHTML = original, 2000);
            `}
            title="Copy link (Instagram, etc.)"
          >
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          </button>
        </div>
      </div>
    </article>
  </div>

  <style is:inline>
    .abfPageWrap{
      width:100%;
      max-width:72rem;
      margin-left:auto;
      margin-right:auto;
    }

    /* HERO CARD */
    .heroCard{
      position:relative;
      overflow:hidden;
      border-radius:28px;
      border:1px solid rgba(255,255,255,.10);
      background:#0A1F33;
      padding:18px;
      margin-bottom:28px;
      box-shadow:0 24px 70px rgba(0,0,0,.35);
    }
    @media (min-width: 640px){
      .heroCard{ padding:22px; }
    }

    .heroGlow{
      position:absolute;
      width:520px;
      height:520px;
      border-radius:999px;
      filter: blur(120px);
      opacity:.55;
      pointer-events:none;
    }
    .heroGlow.a{ top:-220px; left:-220px; background: rgba(34,211,238,.35); }
    .heroGlow.b{ bottom:-220px; right:-220px; background:8 rgba(59,130,246,.35); }

    /* GRID */
    .heroGrid{
      position:relative;
      z-index:1;
      display:grid;
      gap:16px;
      grid-template-columns: 1fr;
      align-items:stretch;
    }
    @media (min-width: 900px){
      .heroGrid{
        grid-template-columns: 1.35fr .65fr;
        gap:18px;
        align-items:start;
      }
    }

    .heroLeft{
      min-width:0;
      padding:6px 6px;
    }

    .kicker{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color: rgba(255,255,255,.60);
      margin-bottom:10px;
      font-weight:800;
    }
    .dot{
      width:8px;
      height:8px;
      border-radius:999px;
      background: rgb(34,211,238);
      box-shadow: 0 0 0 6px rgba(34,211,238,.12);
      animation: pulse 1.6s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform: scale(1); opacity:1; }
      50%{ transform: scale(1.12); opacity:.85; }
    }

    .pillRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .pillBack,.pillDate,.pillCat{
      display:inline-flex;
      align-items:center;
      height:28px;
      padding:0 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:rgba(255,255,255,.75);
      transition: transform .18s ease, background .18s ease, color .18s ease;
      text-decoration:none;
    }
    .pillBack:hover{ background:rgba(255,255,255,.10); color:rgba(255,255,255,.92); }
    .pillCat:hover{ transform: translateY(-1px); }

    .pillCat.radio{
      border-color:rgba(34,211,238,.35);
      background:rgba(11,37,64,.10);
      color:rgba(165,243,252,.95);
    }
    .pillCat.music{
      border-color:rgba(96,165,250,.35);
      background:rgba(11,37,64,.10);
      color:rgba(191,219,254,.95);
    }

    .heroTitle{
      margin:0;
      font-weight:900;
      letter-spacing:-0.02em;
      line-height:1.12;
      font-size: 22px;
      color:#fff;
      max-width: 56ch;
      word-break: break-word;
    }
    @media (min-width: 640px){
      .heroTitle{ font-size: 28px; }
    }
    @media (min-width: 1024px){
      .heroTitle{ font-size: 30px; }
    }

    .heroExcerpt{
      margin-top:12px;
      margin-bottom:0;
      color: rgba(255,255,255,.66);
      line-height:1.7;
      font-size: 14px;
      max-width: 78ch;
      display:-webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }

    .heroMedia{
      position:relative;
      border-radius:22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      box-shadow: 0 18px 55px rgba(0,0,0,.30);
      aspect-ratio: 16 / 9;
      max-height: 250px;
      width: 100%;
      max-width: 520px;
      justify-self: end;
    }

    @media (min-width: 900px){
      .heroMedia{
        margin-top: 54px;
        max-height: 230px;
      }
    }

    .heroMedia::before{
      content:"";
      position:absolute;
      inset:-40px;
      background: radial-gradient(circle at 30% 40%, rgba(34,211,238,.22), transparent 55%);
      filter: blur(10px);
      opacity:.9;
      pointer-events:none;
      z-index:0;
    }

    .heroImg{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:cover;
      transform: scale(1.10);
      opacity:.95;
      transition: transform .4s ease;
      z-index:1;
    }
    .heroMedia:hover .heroImg{
      transform: scale(1.14);
    }

    .heroShade{
      position:absolute;
      inset:0;
      background: linear-gradient(
        to top,
        rgba(5,11,20,.65),
        rgba(5,11,20,.15),
        transparent
      );
      z-index:2;
    }

    /* CONTENT CARD + SHARE SECTION */
    .contentCard{
      border-radius:28px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      padding:32px;
      padding-bottom:56px;
    }

    .proseWrap{
      color:rgba(255,255,255,.82);
      font-size:15.5px;
      line-height:1.85;
      margin-bottom:48px;
    }
    .proseWrap img{
      max-width:100%;
      border-radius:18px;
      margin:28px 0;
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 14px 45px rgba(0,0,0,.35);
    }
    .proseWrap a{
      color:rgba(165,243,252,.95);
      text-decoration:underline;
      text-decoration-color: rgba(165,243,252,.35);
    }
    .proseWrap a:hover{
      text-decoration-color: rgba(165,243,252,.85);
    }

    /* Share section - centered, lighter */
    .shareSection{
      text-align:center;
      margin-top:48px;
      padding-top:36px;
      border-top:1px solid rgba(255,255,255,.08);
    }
    .shareTitle{
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:rgba(255,255,255,.68);
      margin-bottom:18px;
      font-weight:700;
    }
    .shareButtons{
      display: inline-flex;
      justify-content: center;
      gap: 14px;
      flex-wrap: wrap;
      background: rgba(10,31,51,0.45);
      backdrop-blur-xl;
      padding: 14px 22px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 10px 35px rgba(0,0,0,0.3), 0 0 25px rgba(34,211,238,0.1);
    }
    .shareBtn{
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.88);
      transition: all 0.3s ease;
    }
    .shareBtn:hover{
      background: rgba(34,211,238,0.22);
      color: white;
      transform: translateY(-3px) scale(1.06);
      box-shadow: 0 10px 25px rgba(34,211,238,0.28);
    }
  </style>
</Base>