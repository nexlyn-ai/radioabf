---
import Base from "../layouts/Base.astro";
import { directusGet, directusAsset } from "../lib/directus";

export const prerender = false;

type DirectusFile = string | null;

type Program = {
  id: string;
  title: string;
  slug?: string | null;
  excerpt?: string | null;
  description?: string | null;
  cover?: DirectusFile;
  hero?: DirectusFile;
  status?: string | null;
};

type Occurrence = {
  id: string;
  day_of_week: number;
  start_time: string;
  end_time?: string | null;
  is_live?: boolean | null;
  status?: string | null;
  program: Program | null;
};

type DirectusListResp<T> = { data: T[] };

const isoToKey = (d: number) => {
  if (d === 1) return "mon";
  if (d === 2) return "tue";
  if (d === 3) return "wed";
  if (d === 4) return "thu";
  if (d === 5) return "fri";
  if (d === 6) return "sat";
  return "sun";
};

const timeToDisplay = (t: string) => {
  const m = String(t || "").match(/^(\d{1,2}):(\d{2})/);
  if (!m) return "00h00";
  return Number(m[1]) + "h" + m[2];
};

const pickImage = (p: Program | null) => {
  if (!p) return "/logo-abf.png";
  const id = p.hero || p.cover;
  if (id) return directusAsset(id);
  return "/logo-abf.png";
};

let scheduleByDay: Record<string, any[]> = {
  mon: [],
  tue: [],
  wed: [],
  thu: [],
  fri: [],
  sat: [],
  sun: []
};

try {
  const fields =
    "id,day_of_week,start_time,status," +
    "program.id,program.title,program.excerpt,program.cover,program.hero,program.status";

  const resp = await directusGet<DirectusListResp<Occurrence>>(
    "/items/program_occurrences?fields=" + encodeURIComponent(fields) +
    "&filter[status][_eq]=published" +
    "&sort=day_of_week,start_time"
  );

  const rows = resp && resp.data ? resp.data : [];

  for (const r of rows) {
    if (!r.program) continue;
    if (r.program.status !== "published") continue;

    const key = isoToKey(Number(r.day_of_week));

    scheduleByDay[key].push({
      time: timeToDisplay(r.start_time),
      img: pickImage(r.program),
      title: r.program.title || "Untitled",
      desc: r.program.excerpt || ""
    });
  }
} catch (e) {
  console.error("Programs fetch error:", e);
}
---

<Base
  title="Programs â€” RadioABF"
  description="Discover DJ programs and live schedule on radioabf.com."
  canonical="/programs"
  image="/og-image.jpg"
>

<section class="relative overflow-hidden rounded-3xl border border-white/10 bg-[#0A1F33] p-6 mb-6 shadow-2xl">
  <h1 class="text-3xl font-extrabold">
    Weekly schedule on <span class="text-cyan-200">RadioABF</span>
  </h1>
</section>

<section class="bg-[#0A1F33] border border-white/10 rounded-2xl p-4 mb-6">
  <div class="flex gap-2">
    <button class="dayTab active" data-day="mon">Mon</button>
    <button class="dayTab" data-day="tue">Tue</button>
    <button class="dayTab" data-day="wed">Wed</button>
    <button class="dayTab" data-day="thu">Thu</button>
    <button class="dayTab" data-day="fri">Fri</button>
    <button class="dayTab" data-day="sat">Sat</button>
    <button class="dayTab" data-day="sun">Sun</button>
  </div>
</section>

<section class="bg-[#0A1F33] border border-white/10 rounded-2xl p-4">
  <div id="scheduleList"></div>
</section>

<script is:inline>
(function(){

  var SCHEDULE = {JSON.stringify(scheduleByDay)};

  function todayKey(){
    var d = new Date().getDay();
    if (d === 0) return "sun";
    if (d === 1) return "mon";
    if (d === 2) return "tue";
    if (d === 3) return "wed";
    if (d === 4) return "thu";
    if (d === 5) return "fri";
    return "sat";
  }

  function setActive(day){
    var tabs = document.querySelectorAll(".dayTab");
    for (var i=0;i<tabs.length;i++){
      if (tabs[i].getAttribute("data-day") === day){
        tabs[i].classList.add("active");
      } else {
        tabs[i].classList.remove("active");
      }
    }
  }

  function render(day){
    var list = document.getElementById("scheduleList");
    if (!list) return;

    setActive(day);

    var items = SCHEDULE[day] || [];

    if (!items.length){
      list.innerHTML = "<div class='text-white/50'>No schedule found.</div>";
      return;
    }

    var html = "";

    for (var i=0;i<items.length;i++){
      var it = items[i];
      html +=
        "<div class='mb-4 p-4 border border-white/10 rounded-xl'>" +
        "<div class='text-cyan-200 font-bold mb-2'>" + it.time + "</div>" +
        "<img src='" + it.img + "' class='w-full mb-2' />" +
        "<div class='text-white font-semibold'>" + it.title + "</div>" +
        "<div class='text-white/70 text-sm'>" + it.desc + "</div>" +
        "</div>";
    }

    list.innerHTML = html;
  }

  document.addEventListener("click", function(e){
    var target = e.target;
    if (!(target instanceof Element)) return;

    var btn = target.closest(".dayTab");
    if (!btn) return;

    var day = btn.getAttribute("data-day");
    if (!day) return;

    render(day);
  });

  var initial = todayKey();
  if (!(SCHEDULE[initial] && SCHEDULE[initial].length)){
    var keys = ["mon","tue","wed","thu","fri","sat","sun"];
    for (var i=0;i<keys.length;i++){
      if (SCHEDULE[keys[i]] && SCHEDULE[keys[i]].length){
        initial = keys[i];
        break;
      }
    }
  }

  render(initial);

})();
</script>

</Base>