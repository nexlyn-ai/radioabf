---
import Base from "../layouts/Base.astro";
export const prerender = false;
---

<Base
  title="Chat â€” RadioABF"
  description="Live chat on RadioABF."
  canonical="/chat"
  image="/og-image.jpg"
>
  <div id="abfChatPageRoot">
    <!-- âœ… HERO (ultra compact, but bigger title like /music) -->
    <section class="relative overflow-hidden rounded-3xl border border-white/10 bg-[#0A1F33] p-2 sm:p-3 mb-2 shadow-2xl">
      <div class="pointer-events-none absolute -top-44 -left-44 w-[520px] h-[520px] rounded-full bg-cyan-500/12 blur-[140px]"></div>
      <div class="pointer-events-none absolute -bottom-44 -right-44 w-[520px] h-[520px] rounded-full bg-blue-600/12 blur-[140px]"></div>

      <div class="relative z-10">
        <div class="flex items-start justify-between gap-3 flex-wrap">
          <!-- LEFT -->
          <div class="min-w-0 flex-1">
            <div class="flex items-center gap-2 text-[10px] tracking-widest text-white/60 uppercase mb-1">
              <span class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></span>
              Live Chat
            </div>

            <!-- âœ… bigger title (without increasing hero padding) -->
            <h1 class="text-3xl sm:text-4xl font-extrabold leading-tight">
              RadioABF <span class="text-cyan-200">Chat</span>
            </h1>

            <p class="text-white/65 mt-1 max-w-2xl text-[12px] leading-snug">
              Join the room, talk with listeners, and stay connected during shows.
            </p>

            <!-- âœ… badges (micro) -->
            <div class="flex items-center gap-2 flex-wrap mt-2">
              <span class="text-[10px] text-white/70 border border-white/10 bg-white/5 px-2.5 py-1.5 rounded-xl inline-flex items-center gap-2">
                <span id="abfChatHeroBadgeDot" class="w-2 h-2 rounded-full bg-cyan-300 animate-pulse"></span>
                <span id="abfChatHeroBadgeText">ON AIR</span>
              </span>

              <span class="text-[10px] text-white/70 border border-white/10 bg-white/5 px-2.5 py-1.5 rounded-xl inline-flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-emerald-300/90"></span>
                <span id="abfChatOnline" class="tabular-nums font-semibold">â€”</span>
                online
              </span>

              <span class="text-[10px] text-white/70 border border-white/10 bg-white/5 px-2.5 py-1.5 rounded-xl">
                Smart scroll
              </span>

              <span class="text-[10px] text-white/60">
                Status: <span id="abfChatStatus" class="font-semibold">Connectingâ€¦</span>
              </span>
            </div>

            <div id="abfChatError" class="mt-1 text-[10px] text-red-300 hidden"></div>
          </div>

          <!-- RIGHT: Join card (micro) â€“ plus de select room -->
          <div class="w-full sm:w-[280px] flex-shrink-0">
            <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl shadow-xl p-2.5">
              <div class="text-[10px] text-white/60 uppercase tracking-wider mb-2">
                Join chat
              </div>

              <div class="space-y-2">
                <input
                  id="abfChatPseudo"
                  class="abfInput w-full"
                  placeholder="Pseudo (optionnel)"
                  maxlength="24"
                />

                <button id="abfChatJoin" class="abfBtn abfBtnPrimary w-full" type="button">
                  Join General
                  <span class="abfBtnShine"></span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CHAT -->
    <section class="abfChatShell">
      <div class="abfChatTopBar">
        <div class="abfChatTopLeft">
          <span id="abfChatRoomPill" class="abfRoomPill" data-room="general">#<span id="abfChatRoomLabel">General</span></span>
          <span class="abfMuted">â€¢</span>
          <span class="abfMuted">Premium ABF UI</span>
        </div>
        <button id="abfChatScrollBtn" class="abfBtn abfBtnGhost hidden" title="Scroll to latest">
          Latest
        </button>
      </div>

      <div id="abfChatLog" class="abfChatLog" aria-live="polite"></div>

      <!-- composer -->
      <div class="abfComposer">
        <div class="abfEmojiWrap">
          <button id="abfChatEmojiBtn" class="abfBtn abfBtnGhost abfEmojiBtn" type="button" title="Emoji">
            ðŸ˜Š
          </button>

          <div id="abfChatEmojiPanel" class="abfEmojiPanel hidden" role="dialog" aria-label="Emoji picker">
            <div class="abfEmojiHeader">
              <div class="abfEmojiTitle">Emojis</div>
              <button id="abfChatEmojiClose" class="abfBtn abfBtnGhost abfEmojiClose" type="button" title="Close">
                âœ•
              </button>
            </div>
            <div id="abfChatEmojiGrid" class="abfEmojiGrid"></div>
          </div>
        </div>

        <input id="abfChatMsg" class="abfInput abfComposerInput" placeholder="Messageâ€¦" />
        <button id="abfChatSend" class="abfBtn abfBtnPrimary abfSendBtn">
          Send
          <span class="abfBtnShine"></span>
        </button>
      </div>
    </section>
  </div>

  <style>
    /* -------------------------------------------------------------------
       Tous les styles sont exactement ceux que tu avais fournis
       Aucun changement ici sauf suppression des rÃ¨gles inutiles pour les autres rooms
    ------------------------------------------------------------------- */
    .tabular-nums { font-variant-numeric: tabular-nums; }

    #abfChatPageRoot{
      --abf-border: rgba(255,255,255,.10);
      --abf-text: rgba(232,242,255,.95);
      --abf-muted: rgba(232,242,255,.62);
      color: var(--abf-text);
    }
    #abfChatPageRoot .hidden{ display:none !important; }

    /* Inputs aligned with site (smaller) */
    #abfChatPageRoot .abfInput{
      appearance: none;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.9);
      border-radius: 14px;
      padding: 8px 10px;
      font-size: 11px;
      outline: none;
      transition: 150ms ease;
      height: 36px;
    }
    #abfChatPageRoot .abfInput:focus{
      border-color: rgba(47,194,255,0.35);
      box-shadow: 0 0 0 3px rgba(47,194,255,0.10);
    }

    /* Buttons (smaller) */
    #abfChatPageRoot .abfBtn{
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.9);
      border-radius: 14px;
      padding: 8px 12px;
      font-size: 11px;
      font-weight: 900;
      transition: 160ms ease;
      position: relative;
      user-select: none;
      height: 36px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      overflow: hidden;
    }
    #abfChatPageRoot .abfBtn:hover{ background: rgba(255,255,255,0.10); }
    #abfChatPageRoot .abfBtn:active{ transform: translateY(1px); }

    #abfChatPageRoot .abfBtnPrimary{
      background: linear-gradient(180deg, rgba(56,189,248,.22), rgba(56,189,248,.10));
      border-color: rgba(56,189,248,.30);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    #abfChatPageRoot .abfBtnPrimary:hover{
      background: linear-gradient(180deg, rgba(56,189,248,.28), rgba(56,189,248,.12));
      border-color: rgba(56,189,248,.42);
      box-shadow: 0 14px 40px rgba(0,0,0,.32);
      transform: translateY(-1px);
    }

    #abfChatPageRoot .abfBtnGhost{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.12);
      font-weight: 800;
      padding: 0 10px;
      height: 30px;
      border-radius: 12px;
      font-size: 10px;
    }
    #abfChatPageRoot .abfBtnGhost:hover{
      background: rgba(255,255,255,.08);
      transform: translateY(-1px);
    }

    #abfChatPageRoot .abfBtnShine{
      pointer-events:none;
      position:absolute;
      inset:-2px;
      background: radial-gradient(600px 100px at 0% 50%, rgba(255,255,255,.20), rgba(255,255,255,0) 60%);
      transform: translateX(-60%);
      opacity: .55;
      animation: abfShine 4.6s ease-in-out infinite;
    }
    @keyframes abfShine{
      0%, 20%{ transform: translateX(-60%); opacity:.30; }
      50%{ transform: translateX(40%); opacity:.65; }
      80%,100%{ transform: translateX(120%); opacity:.20; }
    }

    /* Chat shell */
    #abfChatPageRoot .abfChatShell{
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(5,11,20,.64);
      backdrop-filter: blur(14px);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      overflow: hidden;
    }
    #abfChatPageRoot .abfChatTopBar{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 5px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
      min-height: 40px;
    }
    #abfChatPageRoot .abfChatTopLeft{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 11px;
    }

    #abfChatPageRoot .abfRoomPill{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,.18);
      background: rgba(56,189,248,.10);
      color: rgba(232,242,255,.90);
      font-weight: 900;
      letter-spacing: .02em;
      font-size: 11px;
    }

    #abfChatPageRoot .abfMuted{ color: rgba(232,242,255,.55); }

    /* smaller chat window */
    #abfChatPageRoot .abfChatLog{
      height: min(34vh, 260px);
      overflow: auto;
      padding: 10px 10px 12px;
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.10));
      scroll-behavior: smooth;
    }

    /* Messages */
    #abfChatPageRoot .abfMsgRow{
      display:flex;
      gap: 0;
      align-items: flex-end;
      margin: 0 0 10px;
      animation: abfIn .18s ease-out both;
    }
    @keyframes abfIn{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }
    #abfChatPageRoot .abfMsgRow.self{ justify-content: flex-end; }

    #abfChatPageRoot .abfAvatar{ display:none !important; }

    #abfChatPageRoot .abfBubble{
      max-width: min(760px, 96%);
      border-radius: 16px;
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: 0 12px 40px rgba(0,0,0,.22);
      display:flex;
      align-items: baseline;
      gap: 10px;
    }
    #abfChatPageRoot .abfMsgRow.self .abfBubble{
      background: linear-gradient(180deg, rgba(56,189,248,.16), rgba(56,189,248,.07));
      border-color: rgba(56,189,248,.24);
    }

    #abfChatPageRoot .abfMeta{
      display:inline-flex;
      align-items: baseline;
      gap: 7px;
      margin: 0;
      font-size: 10px;
      color: rgba(232,242,255,.70);
      flex: 0 0 auto;
      white-space: nowrap;
    }
    #abfChatPageRoot .abfUserDot{
      width: 7px;
      height: 7px;
      border-radius: 99px;
      display:inline-block;
      box-shadow: 0 0 0 4px rgba(255,255,255,.06);
      transform: translateY(1px);
      flex: 0 0 auto;
    }
    #abfChatPageRoot .abfName{ font-weight: 900; }
    #abfChatPageRoot .abfTime{ color: rgba(232,242,255,.45); font-weight: 700; }

    #abfChatPageRoot .abfText{
      font-size: 12px;
      line-height: 1.25;
      color: rgba(232,242,255,.92);
      word-break: break-word;
      white-space: pre-wrap;
      flex: 1 1 auto;
      min-width: 0;
    }

    #abfChatPageRoot .abfSys{
      margin: 8px 0 10px;
      text-align: center;
      color: rgba(232,242,255,.55);
      font-size: 10px;
      letter-spacing: .02em;
    }
    #abfChatPageRoot .abfSys span{
      display:inline-block;
      padding: 5px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }

    #abfChatPageRoot .abfComposer{
      display:flex;
      gap: 8px;
      padding: 7px 10px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      position: sticky;
      bottom: 0;
      align-items: center;
    }
    #abfChatPageRoot .abfComposerInput{
      flex: 1;
      height: 36px;
      border-radius: 14px;
      font-size: 10px;
    }
    #abfChatPageRoot .abfSendBtn{
      height: 36px;
      border-radius: 14px;
      padding: 0 14px;
    }

    /* Emoji picker */
    #abfChatPageRoot .abfEmojiWrap{ position: relative; flex: 0 0 auto; }
    #abfChatPageRoot .abfEmojiBtn{
      height: 36px;
      width: 42px;
      padding: 0;
      border-radius: 14px;
      font-size: 16px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #abfChatPageRoot .abfEmojiPanel{
      position: absolute;
      bottom: calc(100% + 10px);
      left: 0;
      width: 270px;
      max-width: min(78vw, 320px);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(5,11,20,.92);
      backdrop-filter: blur(14px);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      overflow: hidden;
      z-index: 30;
    }
    #abfChatPageRoot .abfEmojiHeader{
      display:flex;
      align-items:center;
      justify-content: space-between;
      padding: 8px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    #abfChatPageRoot .abfEmojiTitle{
      font-size: 11px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: rgba(232,242,255,.72);
      font-weight: 900;
    }
    #abfChatPageRoot .abfEmojiClose{
      height: 28px;
      width: 32px;
      padding: 0;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
    }
    #abfChatPageRoot .abfEmojiGrid{
      padding: 10px;
      display:grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 6px;
    }
    #abfChatPageRoot .abfEmojiItem{
      height: 28px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor: pointer;
      user-select: none;
      font-size: 16px;
      transition: transform .10s ease, background .10s ease, border-color .10s ease;
    }
    #abfChatPageRoot .abfEmojiItem:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.08);
      border-color: rgba(56,189,248,.28);
    }

    @media (max-width: 640px){
      #abfChatPageRoot .abfChatLog{ padding: 10px 9px 12px; height: min(40vh, 300px); }
      #abfChatPageRoot .abfBubble{ max-width: 98%; }
      #abfChatPageRoot .abfEmojiGrid{ grid-template-columns: repeat(7, 1fr); }
    }

    @media (prefers-reduced-motion: reduce){
      #abfChatPageRoot .abfMsgRow{ animation: none !important; }
      #abfChatPageRoot .abfChatLog{ scroll-behavior: auto; }
      #abfChatPageRoot .abfBtnShine{ animation: none !important; }
    }
  </style>

  <script is:inline>
    (() => {
      const WS_URL = "wss://chat.radioabf.com/ws";
      const $ = (id) => document.getElementById(id);

      const pseudoEl      = $("abfChatPseudo");
      const joinBtn       = $("abfChatJoin");
      const logEl         = $("abfChatLog");
      const msgEl         = $("abfChatMsg");
      const sendBtn       = $("abfChatSend");
      const statusEl      = $("abfChatStatus");
      const errEl         = $("abfChatError");
      const roomLabelEl   = $("abfChatRoomLabel");
      const scrollBtn     = $("abfChatScrollBtn");
      const onlineEl      = $("abfChatOnline");
      const roomPillEl    = $("abfChatRoomPill");

      const heroDot       = document.getElementById("abfChatHeroBadgeDot");
      const heroText      = document.getElementById("abfChatHeroBadgeText");

      const emojiBtn      = $("abfChatEmojiBtn");
      const emojiPanel    = $("abfChatEmojiPanel");
      const emojiGrid     = $("abfChatEmojiGrid");
      const emojiClose    = $("abfChatEmojiClose");

      let ws              = null;
      let joined          = false;
      let myPseudo        = "";
      const currentRoom   = "general"; // fixe pour toujours

      let stickToBottom   = true;
      let reconnectTimer  = null;
      let reconnectAttempt= 0;
      let manualClosed    = false;
      let lastConnectTry  = 0;

      const ONLINE_TTL_MS = 1000 * 60 * 3;
      const seen          = new Map();

      const esc = (s) => String(s).replace(/[&<>"']/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));

      const guest = () => "Guest " + Math.floor(1000 + Math.random()*9000);

      function setStatus(t, ok = false) {
        statusEl.textContent = t;
        statusEl.style.color = ok ? "rgba(124,252,179,.95)" : "rgba(255,255,255,.75)";
      }

      function showErr(t = "") {
        if (!t) { errEl.classList.add("hidden"); errEl.textContent = ""; return; }
        errEl.classList.remove("hidden");
        errEl.textContent = t;
      }

      function nowHHMM(ts) {
        try { return new Date(ts).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }); }
        catch { return ""; }
      }

      function updateRoomUI() {
        if (roomLabelEl) roomLabelEl.textContent = "General";
        if (roomPillEl) roomPillEl.setAttribute("data-room", "general");
        if (heroDot && heroText) {
          heroText.textContent = "GENERAL";
          heroDot.style.background = "rgb(52 211 153)";
          heroDot.classList.remove("animate-pulse");
        }
      }

      function shouldStick() {
        const threshold = 56;
        return (logEl.scrollHeight - logEl.scrollTop - logEl.clientHeight) < threshold;
      }

      function scrollToLatest(force = false) {
        if (force || stickToBottom) logEl.scrollTop = logEl.scrollHeight;
      }

      function updateScrollState() {
        stickToBottom = shouldStick();
        scrollBtn.classList.toggle("hidden", stickToBottom);
      }

      function sysLine(html) {
        const div = document.createElement("div");
        div.className = "abfSys";
        div.innerHTML = `<span>${html}</span>`;
        logEl.appendChild(div);
        scrollToLatest();
      }

      function msgBubble({ pseudo, message, created_at }) {
        const isSelf = myPseudo && pseudo === myPseudo;
        const row = document.createElement("div");
        row.className = "abfMsgRow" + (isSelf ? " self" : "");

        const bubble = document.createElement("div");
        bubble.className = "abfBubble";

        const meta = document.createElement("div");
        meta.className = "abfMeta";
        const t = nowHHMM(created_at);

        meta.innerHTML = `
          <span class="abfTime">${esc(t)}</span>
          <span class="abfTime">â€¢</span>
          <span class="abfName">${esc(pseudo || "Listener")}</span>
        `;

        const txt = document.createElement("div");
        txt.className = "abfText";
        txt.textContent = message || "";

        bubble.append(meta, txt);
        row.appendChild(bubble);
        logEl.appendChild(row);
        scrollToLatest();
      }

      function touchSeen(pseudo) {
        if (!pseudo) return;
        seen.set(pseudo, Date.now());
        pruneSeen();
        onlineEl.textContent = seen.size || "â€”";
      }

      function pruneSeen() {
        const now = Date.now();
        for (const [k, v] of seen) {
          if (now - v > ONLINE_TTL_MS) seen.delete(k);
        }
      }

      setInterval(pruneSeen, 10000);

      function closeWs() {
        if (ws) {
          try { ws.close(); } catch {}
          ws = null;
        }
        joined = false;
      }

      function clearReconnect() {
        if (reconnectTimer) {
          clearTimeout(reconnectTimer);
          reconnectTimer = null;
        }
      }

      function scheduleReconnect() {
        if (manualClosed) return;
        clearReconnect();

        reconnectAttempt = Math.min(reconnectAttempt + 1, 6);
        const delay = 1000 + reconnectAttempt * 1200;

        setStatus(`Reconnecting in ${Math.round(delay/1000)}sâ€¦`);
        reconnectTimer = setTimeout(connectFresh, delay);
      }

      function connectFresh() {
        const now = Date.now();
        if (now - lastConnectTry < 1200) return;
        lastConnectTry = now;

        clearReconnect();
        closeWs();

        ws = new WebSocket(WS_URL);
        setStatus("Connectingâ€¦");

        ws.onopen = () => {
          setStatus("Connected", true);
          sysLine("connected");

          const pseudo = myPseudo || guest();
          myPseudo = pseudo;

          if (ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ type: "join", pseudo, room: "general" }));
          }
        };

        ws.onclose = () => {
          setStatus("Disconnected");
          sysLine("disconnected");
          scheduleReconnect();
        };

        ws.onerror = () => {
          showErr("Connection error");
          scheduleReconnect();
        };

        ws.onmessage = (e) => {
          showErr("");
          let m;
          try { m = JSON.parse(e.data); } catch { return; }

          if (m.type === "joined") {
            joined = true;
            reconnectAttempt = 0;
            clearReconnect();
            logEl.innerHTML = "";
            sysLine(`joined <b>#General</b> as <b>${esc(m.pseudo)}</b>`);

            (m.history || []).forEach(h => {
              if (h) {
                touchSeen(h.pseudo);
                msgBubble(h);
              }
            });

            scrollToLatest(true);
            updateScrollState();
          }

          if (m.type === "presence") {
            touchSeen(m.pseudo);
            sysLine(`${esc(m.pseudo || "Listener")} ${esc(m.event)}`);
          }

          if (m.type === "msg") {
            touchSeen(m.pseudo);
            msgBubble({
              pseudo: m.pseudo || "Listener",
              message: m.message || "",
              created_at: m.created_at || Date.now()
            });
          }

          if (m.type === "error") showErr("Error: " + (m.code || "unknown"));
        };
      }

      function join() {
        showErr("");
        connectFresh();
      }

      function send() {
        if (!ws || ws.readyState !== 1) return showErr("Not connected.");
        if (!joined) return showErr("Not joined yet.");
        const text = msgEl.value.trim();
        if (!text) return;
        ws.send(JSON.stringify({ type: "msg", message: text }));
        touchSeen(myPseudo);
        msgEl.value = "";
        msgEl.focus();
      }

      // Emoji (inchangÃ©)
      const EMOJIS = ["ðŸ˜€","ðŸ˜„","ðŸ˜","ðŸ˜…","ðŸ˜‚","ðŸ¤£","ðŸ˜Š","ðŸ˜","ðŸ˜Ž","ðŸ¤©","ðŸ¥³","ðŸ¤¯","ðŸ˜´","ðŸ˜­","ðŸ˜¡","ðŸ¤","ðŸ‘","ðŸ‘Ž","ðŸ‘","ðŸ™","ðŸ”¥","ðŸ’Ž","âœ¨","âš¡","ðŸŽ¶","ðŸŽ§","ðŸŽšï¸","ðŸŽ›ï¸","ðŸŽ¤","ðŸ“»","ðŸš€","ðŸŒ™","â¤ï¸","ðŸ’™","ðŸ’œ","ðŸ¤","ðŸ–¤","ðŸ’š","ðŸ§¡","ðŸ’›"];

      function setEmojiOpen(open) {
        emojiPanel.classList.toggle("hidden", !open);
      }

      function insertAtCursor(input, text) {
        const start = input.selectionStart ?? input.value.length;
        const end = input.selectionEnd ?? input.value.length;
        input.value = input.value.slice(0, start) + text + input.value.slice(end);
        input.setSelectionRange(start + text.length, start + text.length);
        input.focus();
      }

      function buildEmojiGrid() {
        emojiGrid.innerHTML = "";
        EMOJIS.forEach(e => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "abfEmojiItem";
          btn.textContent = e;
          btn.onclick = () => { insertAtCursor(msgEl, e); setEmojiOpen(false); };
          emojiGrid.appendChild(btn);
        });
      }
      buildEmojiGrid();

      emojiBtn.onclick = () => setEmojiOpen(emojiPanel.classList.contains("hidden"));
      emojiClose.onclick = () => setEmojiOpen(false);

      document.addEventListener("click", e => {
        if (!emojiPanel.classList.contains("hidden") &&
            !emojiPanel.contains(e.target) &&
            !emojiBtn.contains(e.target)) {
          setEmojiOpen(false);
        }
      });

      document.addEventListener("keydown", e => {
        if (e.key === "Escape") setEmojiOpen(false);
      });

      logEl.addEventListener("scroll", updateScrollState, { passive: true });
      scrollBtn.onclick = () => { stickToBottom = true; scrollToLatest(true); updateScrollState(); };
      joinBtn.onclick = join;
      sendBtn.onclick = send;
      msgEl.onkeydown = e => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); send(); } };

      // Reconnexion fiable lors des changements de page / retour onglet
      function tryReconnect() {
        if (document.visibilityState !== "visible" && document.visibilityState !== "hidden") return;
        if (!ws || ws.readyState === WebSocket.CLOSED) {
          connectFresh();
        }
      }

      document.addEventListener("visibilitychange", tryReconnect);
      window.addEventListener("pageshow", tryReconnect);
      window.addEventListener("focus", tryReconnect);

      window.addEventListener("pagehide", () => {
        manualClosed = true;
        clearReconnect();
        closeWs();
      });

      // DÃ©marrage
      updateRoomUI();
      setStatus("Connectingâ€¦");
      connectFresh();
      requestAnimationFrame(updateScrollState);
    })();
  </script>
</Base>