---
import Base from "../layouts/Base.astro";
export const prerender = false;
---

<Base
  title="ABF Chat â€” RadioABF"
  description="Join the ABF live chat: pick a room, connect with the community, and chat in real time."
  canonical="/chat"
  image="/og-image.jpg"
>
  <!-- âœ… ROOT -->
  <div id="chatPageRoot">
    <!-- âœ… HERO (same typography + scale as /music hero) -->
    <section class="relative overflow-hidden rounded-3xl border border-white/10 bg-[#0A1F33] p-5 sm:p-6 mb-6 shadow-2xl">
      <div class="pointer-events-none absolute -top-40 -left-40 w-[520px] h-[520px] rounded-full bg-cyan-500/15 blur-[120px]"></div>
      <div class="pointer-events-none absolute -bottom-40 -right-40 w-[520px] h-[520px] rounded-full bg-blue-600/15 blur-[120px]"></div>

      <div class="relative z-10">
        <div class="flex items-start justify-between gap-4 flex-wrap">
          <div class="min-w-0">
            <div class="flex items-center gap-3 text-sm tracking-widest text-white/60 uppercase mb-3">
              <span class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></span>
              ABF Chat
            </div>

            <h1 class="text-3xl sm:text-4xl font-extrabold leading-tight">
              Community <span class="text-cyan-200">Live Chat</span>
            </h1>

            <p class="text-white/65 mt-3 max-w-2xl">
              Pick a room, connect, and chat live with the ABF community â€” fast, clean and premium.
            </p>
          </div>

          <!-- âœ… Login card back in the hero (right) -->
          <div class="w-full lg:w-[420px]">
            <div class="rounded-3xl border border-white/10 bg-white/[0.04] overflow-hidden shadow-xl">
              <div class="p-4 sm:p-5 border-b border-white/10 flex items-start justify-between gap-4">
                <div class="min-w-0">
                  <div class="text-sm text-white/60 uppercase tracking-wider">Connect</div>
                  <div class="text-xs text-white/50 mt-1">Choose a room and join</div>
                </div>
              </div>

              <form id="chatLoginForm" class="p-4 sm:p-5 space-y-3">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <div>
                    <label class="block text-xs text-white/60 mb-2">Username</label>
                    <input
                      id="chatName"
                      type="text"
                      maxlength="24"
                      autocomplete="nickname"
                      class="abfInput w-full"
                      placeholder="Loic Molo"
                      required
                    />
                  </div>
                  <div>
                    <label class="block text-xs text-white/60 mb-2">Room</label>
                    <select id="roomSelect" class="abfInput w-full" aria-label="Select room">
                      <option value="general">General</option>
                      <option value="all">All</option>
                      <option value="music">Music</option>
                      <option value="djs">Djs</option>
                      <option value="events">Events</option>
                    </select>
                  </div>
                </div>

                <div class="flex items-center justify-between gap-3 flex-wrap">
                  <div class="text-xs text-white/50">
                    Status:
                    <span id="chatStatus" class="text-white/75 font-semibold">disconnected</span>
                  </div>

                  <button
                    id="joinBtn"
                    type="submit"
                    class="abfBtnPrimaryMini"
                  >
                    Join
                  </button>
                </div>

                <div id="chatLoginHint" class="text-xs text-white/45">
                  Tip: your username color is auto-generated and stable on this device.
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- âœ… Badges moved to bottom-left of the hero header -->
        <div class="mt-4 flex items-center justify-start gap-2 flex-nowrap overflow-x-auto no-scrollbar">
          <span class="text-xs text-white/70 border border-white/10 bg-white/5 px-3 py-2 rounded-xl flex-none">
            Realtime rooms
          </span>
          <span class="text-xs text-white/70 border border-white/10 bg-white/5 px-3 py-2 rounded-xl flex-none">
            Emoji picker
          </span>
          <span class="text-xs text-white/70 border border-white/10 bg-white/5 px-3 py-2 rounded-xl flex-none">
            User color mapping
          </span>
        </div>
      </div>
    </section>

    <!-- âœ… MAIN GRID -->
    <section class="grid grid-cols-1 xl:grid-cols-[minmax(0,1fr)_minmax(0,0.55fr)] gap-6 items-start">
      <!-- CHAT -->
      <div class="rounded-3xl border border-white/10 bg-[#0A1F33] overflow-hidden shadow-xl">
        <div class="p-5 border-b border-white/10 flex items-center justify-between gap-4 flex-wrap">
          <div class="min-w-0">
            <div class="text-sm text-white/60 uppercase tracking-wider">Chat</div>
            <div class="text-xs text-white/50 mt-1">
              Room:
              <span id="roomBadge" class="text-white/80 font-semibold">#general</span>
              <span class="text-white/40">â€¢</span>
              Users:
              <span id="usersBadge" class="tabular-nums text-white/80 font-semibold">0</span>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <button id="clearChatBtn" type="button" class="abfBtnMini">Clear</button>
            <button id="disconnectBtn" type="button" class="abfBtnMini abfBtnDangerMini">Disconnect</button>
          </div>
        </div>

        <div class="p-4 sm:p-5">
          <div
            id="chatLog"
            class="space-y-3 max-h-[62vh] overflow-y-auto scrollbar-thin scrollbar-thumb-white/20 scrollbar-track-transparent pr-1"
          ></div>

          <div id="chatEmpty" class="text-white/55 text-sm hidden">
            Connect to a room to start chatting.
          </div>

          <!-- composer -->
          <div class="mt-4 rounded-3xl border border-white/10 bg-white/[0.04] overflow-hidden">
            <div class="p-3 sm:p-4 flex items-end gap-2">
              <div class="flex-1 min-w-0">
                <label class="block text-xs text-white/60 mb-2">Message</label>
                <textarea
                  id="chatMessage"
                  rows="2"
                  maxlength="500"
                  class="abfTextarea w-full"
                  placeholder="Type a messageâ€¦"
                ></textarea>
                <div class="mt-2 flex items-center justify-between gap-3">
                  <div class="text-[11px] text-white/40">
                    Enter to send â€¢ Shift+Enter new line
                  </div>
                  <div class="flex items-center gap-2">
                    <button id="emojiBtn" type="button" class="abfBtnMini" aria-label="Open emoji picker">ðŸ™‚</button>
                    <button id="sendBtn" type="button" class="abfBtnPrimaryMini">Send</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- emoji picker -->
            <div id="emojiPanel" class="hidden border-t border-white/10 bg-[#050B14]/35 p-3">
              <div class="text-xs text-white/60 uppercase tracking-wider mb-2">Emoji</div>
              <div id="emojiGrid" class="grid grid-cols-10 sm:grid-cols-12 gap-2"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- SIDE -->
      <aside class="space-y-6">
        <div class="rounded-3xl border border-white/10 bg-[#0A1F33] overflow-hidden shadow-xl">
          <div class="p-5 border-b border-white/10">
            <div class="text-sm text-white/60 uppercase tracking-wider">Online</div>
            <div class="text-xs text-white/50 mt-1">Users in current room</div>
          </div>
          <div class="p-4 sm:p-5">
            <div id="usersList" class="flex flex-wrap gap-2"></div>
            <div id="usersEmpty" class="text-white/55 text-sm hidden">No users yet.</div>
          </div>
        </div>

        <div class="rounded-3xl border border-white/10 bg-gradient-to-br from-[#061220] via-[#0A1F33] to-[#050B14] overflow-hidden shadow-xl relative">
          <div class="pointer-events-none absolute -top-24 -right-24 w-[260px] h-[260px] bg-cyan-500/15 rounded-full blur-[90px]"></div>
          <div class="p-6 relative">
            <div class="text-xs text-white/50 uppercase tracking-wider">How it works</div>
            <div class="mt-2 font-extrabold text-lg leading-tight">Rooms, colors & etiquette</div>
            <ul class="mt-3 text-sm text-white/70 leading-relaxed space-y-2 list-disc pl-5">
              <li><strong>Pick a room</strong> and click <strong>Join</strong>.</li>
              <li><strong>Usernames have unique colors</strong> (stable on your device).</li>
              <li><strong>Be cool</strong>: no spam, no hate, keep it ABF vibes ðŸ™‚</li>
              <li><strong>Emoji</strong>: use the picker for fast reactions.</li>
            </ul>
          </div>
        </div>
      </aside>
    </section>

    <style>
      .tabular-nums { font-variant-numeric: tabular-nums; }
      .scrollbar-thin::-webkit-scrollbar { width: 6px; }
      .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
      .scrollbar-thin::-webkit-scrollbar-thumb { background-color: rgba(255,255,255,0.2); border-radius: 9999px; }
      .no-scrollbar::-webkit-scrollbar{ display:none; }
      .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }

      .abfInput{
        appearance: none;
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(255,255,255,0.06);
        color: rgba(255,255,255,0.9);
        border-radius: 14px;
        padding: 10px 12px;
        font-size: 12px;
        outline: none;
      }
      .abfInput:focus{
        border-color: rgba(47,194,255,0.35);
        box-shadow: 0 0 0 3px rgba(47,194,255,0.10);
      }
      .abfTextarea{
        appearance:none;
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(255,255,255,0.06);
        color: rgba(255,255,255,0.9);
        border-radius: 16px;
        padding: 10px 12px;
        font-size: 13px;
        outline: none;
        resize: vertical;
        min-height: 44px;
        max-height: 160px;
      }
      .abfTextarea:focus{
        border-color: rgba(47,194,255,0.35);
        box-shadow: 0 0 0 3px rgba(47,194,255,0.10);
      }

      .abfBtnMini{
        border: 1px solid rgba(255,255,255,0.12);
        background: rgba(255,255,255,0.06);
        color: rgba(255,255,255,0.9);
        border-radius: 14px;
        padding: 10px 12px;
        font-size: 12px;
        font-weight: 800;
        transition: 150ms ease;
        white-space: nowrap;
      }
      .abfBtnMini:hover{ background: rgba(255,255,255,0.10); }

      .abfBtnPrimaryMini{
        border: 1px solid rgba(47,194,255,0.35);
        background: linear-gradient(90deg, rgba(20,92,143,0.9), rgba(47,194,255,0.9));
        color: rgba(255,255,255,0.95);
        border-radius: 14px;
        padding: 10px 14px;
        font-size: 12px;
        font-weight: 900;
        transition: 150ms ease;
        white-space: nowrap;
      }
      .abfBtnPrimaryMini:hover{ filter: brightness(1.05); }

      .abfBtnDangerMini{
        border-color: rgba(239,68,68,0.35) !important;
        background: rgba(239,68,68,0.10) !important;
      }
      .abfBtnDangerMini:hover{ background: rgba(239,68,68,0.16) !important; }

      /* join effect */
      @keyframes abfJoinGlow {
        0%   { transform: translateY(6px) scale(.985); opacity: 0; }
        35%  { transform: translateY(0px) scale(1); opacity: 1; }
        100% { transform: translateY(0px) scale(1); opacity: 1; }
      }
      .abfJoinFx{
        animation: abfJoinGlow .35s ease-out both;
      }

      .userPill{
        display:inline-flex;
        align-items:center;
        gap:8px;
        border: 1px solid rgba(255,255,255,0.10);
        background: rgba(255,255,255,0.04);
        border-radius: 999px;
        padding: 8px 10px;
        font-size: 12px;
        font-weight: 800;
        color: rgba(255,255,255,0.92);
        white-space: nowrap;
      }
      .userDot{
        width:10px; height:10px; border-radius:999px;
        box-shadow: 0 0 0 3px rgba(255,255,255,0.06);
      }

      .msgRow{
        border: 1px solid rgba(255,255,255,0.10);
        background: rgba(255,255,255,0.03);
        border-radius: 18px;
        padding: 12px;
      }
      .msgTop{
        display:flex;
        align-items:baseline;
        justify-content:space-between;
        gap: 12px;
      }
      .msgName{
        font-weight: 900;
        letter-spacing: .02em;
      }
      .msgTime{
        flex:none;
        font-size: 11px;
        color: rgba(255,255,255,0.45);
        font-variant-numeric: tabular-nums;
      }
      .msgText{
        margin-top: 6px;
        color: rgba(255,255,255,0.78);
        font-size: 13px;
        line-height: 1.45;
        white-space: pre-wrap;
        word-break: break-word;
      }

      /* emoji buttons */
      .emojiBtn{
        border: 1px solid rgba(255,255,255,0.10);
        background: rgba(255,255,255,0.04);
        border-radius: 14px;
        padding: 8px 0;
        text-align:center;
        font-size: 18px;
        line-height: 1;
        transition: 120ms ease;
        cursor:pointer;
      }
      .emojiBtn:hover{ background: rgba(255,255,255,0.08); }
    </style>

    <!-- âœ… Socket.IO client (only if your server exposes /socket.io)
         If you already load it elsewhere, you can remove this script. -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <!-- âœ… CHAT LOGIC (Astro swap safe / re-join fix) -->
    <script is:inline data-astro-rerun>
(() => {
  const ROUTE = "/chat";
  const KEY = "__abfChat";
  const MAX_LOG = 140;

  // -------- GLOBAL SINGLETON --------
  const S = (window[KEY] = window[KEY] || {
    socket: null,
    bound: false,
    username: "",
    room: "general",
    isConnected: false,
    users: [],
    msgLog: [],
  });

  const $ = (id) => document.getElementById(id);
  const isChatRoute = () => window.location.pathname === ROUTE;
  const nowTs = () => Date.now();

  function esc(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function fmtTime(ts){
    const d = new Date(ts || nowTs());
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return \`\${hh}:\${mm}\`;
  }

  // -------- USER COLOR (stable per device) --------
  function hashStr(str){
    let h = 2166136261;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0);
  }

  function userColor(name){
    const n = String(name || "").trim().toLowerCase();
    const h = hashStr("abf:" + n);
    const hue = h % 360;
    // bright but not neon
    return \`hsl(\${hue} 85% 72%)\`;
  }

  // -------- UI references --------
  function refs(){
    return {
      root: $("chatPageRoot"),
      form: $("chatLoginForm"),
      name: $("chatName"),
      roomSel: $("roomSelect"),
      status: $("chatStatus"),
      roomBadge: $("roomBadge"),
      usersBadge: $("usersBadge"),
      usersList: $("usersList"),
      usersEmpty: $("usersEmpty"),
      chatLog: $("chatLog"),
      chatEmpty: $("chatEmpty"),
      msg: $("chatMessage"),
      sendBtn: $("sendBtn"),
      clearBtn: $("clearChatBtn"),
      discBtn: $("disconnectBtn"),
      emojiBtn: $("emojiBtn"),
      emojiPanel: $("emojiPanel"),
      emojiGrid: $("emojiGrid"),
    };
  }

  // -------- SOCKET --------
  function ensureSocket(){
    if (S.socket && (S.socket.connected || S.socket.connecting)) return S.socket;
    if (!window.io) return null;

    S.socket = window.io({
      transports: ["websocket"],
      reconnection: true,
      reconnectionAttempts: 12,
      reconnectionDelay: 450,
    });

    S.socket.on("connect", () => {
      S.isConnected = true;
      updateStatusUI("connected");
      // âœ… Auto re-join when returning on /chat
      if (isChatRoute() && S.username) {
        try { S.socket.emit("join", { username: S.username, room: S.room }); } catch {}
      }
    });

    S.socket.on("disconnect", () => {
      S.isConnected = false;
      updateStatusUI("disconnected");
    });

    // Server events (adapt names if your backend differs)
    S.socket.on("room:users", (payload) => {
      const list = Array.isArray(payload?.users) ? payload.users : [];
      S.users = list.map(x => String(x || "").trim()).filter(Boolean);
      renderUsers();
    });

    S.socket.on("chat:message", (m) => {
      const msg = {
        id: String(m?.id || "") || String(nowTs() + Math.random()),
        ts: Number(m?.ts || nowTs()),
        room: String(m?.room || S.room),
        user: String(m?.user || "Unknown"),
        text: String(m?.text || ""),
        kind: String(m?.kind || "msg"),
      };
      pushMsg(msg);
      renderLog();
      scrollToBottom();
    });

    S.socket.on("room:joined", (payload) => {
      // expected { room, usersCount }
      if (payload?.room) S.room = String(payload.room);
      renderRoomBadge();
      joinFx();
    });

    return S.socket;
  }

  function updateStatusUI(text){
    const r = refs();
    if (!r.status) return;
    r.status.textContent = text;
    r.status.className =
      text === "connected"
        ? "text-cyan-200 font-semibold"
        : text === "connecting"
        ? "text-white/70 font-semibold"
        : "text-white/60 font-semibold";
  }

  function joinRoom(username, room){
    const sock = ensureSocket();
    if (!sock) {
      updateStatusUI("socket missing");
      return;
    }
    S.username = String(username || "").trim();
    S.room = String(room || "general").trim() || "general";
    if (!S.username) return;

    updateStatusUI(sock.connected ? "connected" : "connecting");

    // If not connected yet, connect will auto-join
    if (!sock.connected) {
      try { sock.connect(); } catch {}
      return;
    }

    try { sock.emit("join", { username: S.username, room: S.room }); } catch {}
  }

  function leaveAll(){
    if (S.socket && S.socket.connected) {
      try { S.socket.emit("leave"); } catch {}
    }
  }

  function disconnect(){
    try { leaveAll(); } catch {}
    try { S.socket?.disconnect?.(); } catch {}
    S.isConnected = false;
    updateStatusUI("disconnected");
  }

  // -------- LOG + USERS RENDER --------
  function pushMsg(m){
    S.msgLog = S.msgLog || [];
    S.msgLog.push(m);
    if (S.msgLog.length > MAX_LOG) S.msgLog.splice(0, S.msgLog.length - MAX_LOG);
  }

  function renderRoomBadge(){
    const r = refs();
    if (r.roomBadge) r.roomBadge.textContent = "#" + String(S.room || "general");
  }

  function renderUsers(){
    const r = refs();
    if (!r.usersList || !r.usersBadge) return;
    const list = Array.isArray(S.users) ? S.users : [];
    r.usersBadge.textContent = String(list.length);

    if (!list.length){
      r.usersList.innerHTML = "";
      if (r.usersEmpty) r.usersEmpty.classList.remove("hidden");
      return;
    }
    if (r.usersEmpty) r.usersEmpty.classList.add("hidden");

    r.usersList.innerHTML = list.map((u) => {
      const c = userColor(u);
      return \`
        <div class="userPill">
          <span class="userDot" style="background:\${esc(c)}"></span>
          <span style="color:\${esc(c)}">\${esc(u)}</span>
        </div>
      \`;
    }).join("");
  }

  function renderLog(){
    const r = refs();
    if (!r.chatLog) return;
    const list = Array.isArray(S.msgLog) ? S.msgLog : [];

    if (!list.length){
      r.chatLog.innerHTML = "";
      if (r.chatEmpty) r.chatEmpty.classList.remove("hidden");
      return;
    }
    if (r.chatEmpty) r.chatEmpty.classList.add("hidden");

    r.chatLog.innerHTML = list.map((m) => {
      const name = String(m.user || "Unknown");
      const col = userColor(name);
      const time = fmtTime(m.ts);
      const kind = String(m.kind || "msg");

      // system / join messages
      if (kind === "system") {
        return \`
          <div class="msgRow" style="background:rgba(255,255,255,0.035)">
            <div class="msgTop">
              <div class="msgName" style="color:rgba(255,255,255,0.75); font-weight:900">SYSTEM</div>
              <div class="msgTime">\${esc(time)}</div>
            </div>
            <div class="msgText" style="color:rgba(255,255,255,0.70)">\${esc(m.text)}</div>
          </div>
        \`;
      }

      return \`
        <div class="msgRow">
          <div class="msgTop">
            <div class="msgName" style="color:\${esc(col)}">\${esc(name)}</div>
            <div class="msgTime">\${esc(time)}</div>
          </div>
          <div class="msgText">\${esc(m.text)}</div>
        </div>
      \`;
    }).join("");
  }

  function scrollToBottom(){
    const r = refs();
    if (!r.chatLog) return;
    r.chatLog.scrollTop = r.chatLog.scrollHeight + 9999;
  }

  function joinFx(){
    const r = refs();
    const hero = r.root?.querySelector?.("section");
    if (!hero) return;
    hero.classList.remove("abfJoinFx");
    void hero.offsetWidth;
    hero.classList.add("abfJoinFx");
  }

  // -------- EMOJI PICKER --------
  const EMOJIS = [
    "ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ™‚","ðŸ˜‰","ðŸ˜Š","ðŸ˜","ðŸ˜˜","ðŸ˜Ž",
    "ðŸ”¥","ðŸš€","ðŸŽ§","ðŸŽ¶","ðŸŽµ","ðŸ’™","ðŸ’œ","âœ¨","âš¡","ðŸ¤",
    "ðŸ‘","ðŸ‘","ðŸ™","ðŸ’¯","ðŸ•º","ðŸ’ƒ","ðŸ¥³","ðŸ¤©","ðŸ˜‡","ðŸ«¶",
    "ðŸ˜ˆ","ðŸ¤–","ðŸ‘‘","ðŸŒ™","â­","â˜•","ðŸ»","ðŸŒŠ","ðŸŽ›ï¸","ðŸŽšï¸"
  ];

  function ensureEmojiGrid(){
    const r = refs();
    if (!r.emojiGrid) return;
    if (r.emojiGrid.dataset.built === "1") return;
    r.emojiGrid.dataset.built = "1";

    r.emojiGrid.innerHTML = EMOJIS.map(e => \`
      <button type="button" class="emojiBtn" data-emoji="\${esc(e)}">\${esc(e)}</button>
    \`).join("");

    r.emojiGrid.addEventListener("click", (ev) => {
      const btn = ev.target?.closest?.("[data-emoji]");
      if (!btn) return;
      const emoji = btn.getAttribute("data-emoji") || "";
      const msg = $("chatMessage");
      if (!msg) return;
      insertAtCursor(msg, emoji);
      msg.focus();
    });
  }

  function insertAtCursor(el, text){
    try{
      const start = el.selectionStart ?? el.value.length;
      const end = el.selectionEnd ?? el.value.length;
      const v = el.value || "";
      el.value = v.slice(0,start) + text + v.slice(end);
      const p = start + text.length;
      el.selectionStart = el.selectionEnd = p;
    } catch {
      el.value = (el.value || "") + text;
    }
  }

  function toggleEmoji(open){
    const r = refs();
    if (!r.emojiPanel) return;
    const on = typeof open === "boolean" ? open : r.emojiPanel.classList.contains("hidden");
    if (on) {
      ensureEmojiGrid();
      r.emojiPanel.classList.remove("hidden");
    } else {
      r.emojiPanel.classList.add("hidden");
    }
  }

  // -------- SEND MESSAGE --------
  function canSend(){
    return S.socket && S.socket.connected && S.username && S.room;
  }

  function sendMessage(){
    const r = refs();
    const text = String(r.msg?.value || "").trim();
    if (!text) return;

    if (!canSend()){
      // local feedback message
      pushMsg({ id: "local-"+nowTs(), ts: nowTs(), user: "SYSTEM", text: "You are not connected. Please Join a room.", kind: "system" });
      renderLog();
      scrollToBottom();
      return;
    }

    try{
      S.socket.emit("chat:message", { room: S.room, user: S.username, text });
      r.msg.value = "";
      toggleEmoji(false);
    } catch {}
  }

  // -------- UI BIND (swap-safe) --------
  function bindUI(){
    if (!isChatRoute()) return;
    const r = refs();
    if (!r.root) return;

    // prevent double binding on *this DOM instance*
    if (r.root.dataset.uiBound === "1") return;
    r.root.dataset.uiBound = "1";

    // restore
    if (S.username && r.name && !r.name.value) r.name.value = S.username;
    if (S.room && r.roomSel) r.roomSel.value = S.room;
    renderRoomBadge();
    renderUsers();
    renderLog();

    // login / join
    if (r.form){
      r.form.addEventListener("submit", (e) => {
        e.preventDefault();
        joinRoom(r.name?.value, r.roomSel?.value);
      });
    }

    // room change -> join new room
    if (r.roomSel){
      r.roomSel.addEventListener("change", () => {
        const u = String(r.name?.value || S.username || "").trim();
        const rr = String(r.roomSel.value || "general").trim();
        if (!u) return;
        joinRoom(u, rr);
      });
    }

    // send
    if (r.sendBtn) r.sendBtn.addEventListener("click", (e) => { e.preventDefault(); sendMessage(); });

    if (r.msg){
      r.msg.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey){
          e.preventDefault();
          sendMessage();
        }
      });
    }

    // emoji
    if (r.emojiBtn){
      r.emojiBtn.addEventListener("click", (e) => {
        e.preventDefault();
        toggleEmoji();
      });
    }
    document.addEventListener("click", (e) => {
      if (!isChatRoute()) return;
      const hitBtn = e.target?.closest?.("#emojiBtn");
      const hitPanel = e.target?.closest?.("#emojiPanel");
      if (!hitBtn && !hitPanel) toggleEmoji(false);
    });

    // clear log
    if (r.clearBtn){
      r.clearBtn.addEventListener("click", () => {
        S.msgLog = [];
        renderLog();
      });
    }

    // disconnect
    if (r.discBtn){
      r.discBtn.addEventListener("click", () => {
        disconnect();
      });
    }

    // if already connected when coming back, re-join
    if (S.isConnected && S.username){
      joinRoom(S.username, r.roomSel?.value || S.room);
    }
  }

  // -------- CLEANUP BEFORE SWAP --------
  function beforeSwap(){
    const r = refs();
    if (r.root) r.root.dataset.uiBound = "0";
    // Keep socket alive (so user doesn't lose connection) but UI is rebuilt next time
    toggleEmoji(false);
  }

  function init(){
    if (!isChatRoute()) return;
    ensureSocket();
    bindUI();
    // status
    updateStatusUI(S.socket?.connected ? "connected" : (S.socket ? "connecting" : "socket missing"));
  }

  // one-time global binds
  if (!S.bound){
    S.bound = true;
    document.addEventListener("astro:page-load", init);
    document.addEventListener("astro:after-swap", init);
    document.addEventListener("astro:before-swap", beforeSwap);
  }

  init();
})();
    </script>
  </div>
</Base>