---
import Base from "../layouts/Base.astro";
export const prerender = false;
---

<Base
  title="Chat â€” RadioABF"
  description="Live chat on RadioABF."
  canonical="/chat"
  image="/og-image.jpg"
>
  <div id="abfChatPageRoot">
    <!-- HERO agrandi / style music-videos -->
    <section class="relative overflow-hidden rounded-3xl border border-white/10 bg-[#0A1F33] p-5 sm:p-8 md:p-10 mb-6 shadow-2xl">
      <div class="pointer-events-none absolute -top-40 -left-40 w-[520px] h-[520px] rounded-full bg-cyan-500/20 blur-[140px]"></div>
      <div class="pointer-events-none absolute -bottom-40 -right-40 w-[580px] h-[580px] rounded-full bg-blue-600/20 blur-[140px]"></div>
      <div class="relative z-10">
        <div class="flex items-start justify-between gap-6 flex-wrap">
          <!-- LEFT -->
          <div class="min-w-0 flex-1">
            <div class="flex items-center gap-4 text-base sm:text-lg tracking-widest text-white/60 uppercase mb-4">
              <span class="w-3 h-3 bg-cyan-400 rounded-full animate-pulse"></span>
              Live Chat
            </div>
            <h1 class="text-5xl sm:text-6xl md:text-7xl font-black leading-tight tracking-tight">
              RadioABF <span class="text-cyan-300/95 drop-shadow-[0_4px_12px_rgba(34,211,238,0.4)]">Chat</span>
            </h1>
            <p class="text-white/70 mt-4 md:mt-5 text-lg sm:text-xl max-w-3xl leading-relaxed">
              Rejoins le salon, discute avec les auditeurs et reste connectÃ© pendant les lives.
            </p>
            <div class="flex items-center gap-3 flex-wrap mt-5 md:mt-6">
              <span class="text-sm sm:text-base text-white/80 border border-white/15 bg-white/8 px-4 py-2.5 rounded-2xl inline-flex items-center gap-2.5 shadow-sm">
                <span class="w-3 h-3 rounded-full bg-cyan-300 animate-pulse"></span>
                ON AIR
              </span>
              <span class="text-sm sm:text-base text-white/80 border border-white/15 bg-white/8 px-4 py-2.5 rounded-2xl inline-flex items-center gap-2.5 shadow-sm">
                <span class="w-3 h-3 rounded-full bg-emerald-400/90"></span>
                <span id="abfChatOnline" class="tabular-nums font-bold">â€”</span>
                online
              </span>
              <span class="text-sm sm:text-base text-white/75 border border-white/15 bg-white/6 px-4 py-2.5 rounded-2xl shadow-sm">
                Smart scroll
              </span>
              <span class="text-sm text-white/70">
                Status: <span id="abfChatStatus" class="font-bold">Connectingâ€¦</span>
              </span>
            </div>
            <div id="abfChatError" class="mt-4 text-sm text-red-300 hidden"></div>
          </div>

          <!-- RIGHT: Join card -->
          <div class="w-full sm:w-[320px] flex-shrink-0">
            <div class="rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl shadow-xl p-4">
              <div class="text-sm text-white/60 uppercase tracking-wider mb-3">
                Join a room
              </div>
              <div class="space-y-3">
                <input
                  id="abfChatPseudo"
                  class="abfInput w-full"
                  placeholder="Pseudo (optionnel)"
                  maxlength="24"
                />
                <select id="abfChatRoom" class="abfInput w-full abfSelect">
                  <option value="general">General</option>
                  <option value="onair">Onair</option>
                  <option value="support">Support</option>
                </select>
                <button id="abfChatJoin" class="abfBtn abfBtnPrimary w-full" type="button">
                  Join
                  <span class="abfBtnShine"></span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CHAT -->
    <section class="abfChatShell">
      <div class="abfChatTopBar">
        <div class="abfChatTopLeft">
          <span class="abfRoomPill"><span id="abfChatRoomPill">#general</span></span>
          <span class="abfMuted">â€¢</span>
          <span class="abfMuted">Premium ABF UI</span>
        </div>
        <button id="abfChatScrollBtn" class="abfBtn abfBtnGhost hidden" title="Scroll to latest">
          Latest
        </button>
      </div>
      <div id="abfChatLog" class="abfChatLog" aria-live="polite"></div>

      <div class="abfComposer">
        <div class="abfEmojiWrap">
          <button id="abfChatEmojiBtn" class="abfBtn abfBtnGhost abfEmojiBtn" type="button" title="Emoji">
            ðŸ˜Š
          </button>
          <div id="abfChatEmojiPanel" class="abfEmojiPanel hidden" role="dialog" aria-label="Emoji picker">
            <div class="abfEmojiHeader">
              <div class="abfEmojiTitle">Emojis</div>
              <button id="abfChatEmojiClose" class="abfBtn abfBtnGhost abfEmojiClose" type="button" title="Close">
                âœ•
              </button>
            </div>
            <div id="abfChatEmojiGrid" class="abfEmojiGrid"></div>
          </div>
        </div>
        <input id="abfChatMsg" class="abfInput abfComposerInput" placeholder="Messageâ€¦" />
        <button id="abfChatSend" class="abfBtn abfBtnPrimary abfSendBtn">
          Send
          <span class="abfBtnShine"></span>
        </button>
      </div>
    </section>
  </div>

  <style>
    .tabular-nums { font-variant-numeric: tabular-nums; }
    .no-scrollbar::-webkit-scrollbar { display:none; }
    .no-scrollbar { -ms-overflow-style:none; scrollbar-width:none; }

    #abfChatPageRoot {
      --abf-border: rgba(255,255,255,.10);
      --abf-text: rgba(232,242,255,.95);
      --abf-muted: rgba(232,242,255,.62);
      color: var(--abf-text);
    }

    #abfChatPageRoot .hidden { display:none !important; }

    #abfChatPageRoot .abfInput {
      appearance: none;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.9);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 12px;
      outline: none;
      transition: 150ms ease;
      height: 40px;
    }

    #abfChatPageRoot .abfInput:focus {
      border-color: rgba(47,194,255,0.35);
      box-shadow: 0 0 0 3px rgba(47,194,255,0.10);
    }

    #abfChatPageRoot .abfSelect {
      background: rgba(10,31,51,.72);
      color: rgba(232,242,255,.95);
    }

    #abfChatPageRoot select.abfSelect option {
      background: #0B1726;
      color: rgba(232,242,255,.95);
    }

    #abfChatPageRoot .abfBtn {
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.9);
      border-radius: 14px;
      padding: 10px 14px;
      font-size: 12px;
      font-weight: 900;
      transition: 160ms ease;
      position: relative;
      user-select: none;
      height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      overflow: hidden;
    }

    #abfChatPageRoot .abfBtn:hover { background: rgba(255,255,255,0.10); }
    #abfChatPageRoot .abfBtn:active { transform: translateY(1px); }

    #abfChatPageRoot .abfBtnPrimary {
      background: linear-gradient(180deg, rgba(56,189,248,.24), rgba(56,189,248,.12));
      border-color: rgba(56,189,248,.30);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }

    #abfChatPageRoot .abfBtnPrimary:hover {
      background: linear-gradient(180deg, rgba(56,189,248,.30), rgba(56,189,248,.14));
      border-color: rgba(56,189,248,.42);
      box-shadow: 0 14px 40px rgba(0,0,0,.32);
      transform: translateY(-1px);
    }

    #abfChatPageRoot .abfBtnGhost {
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.12);
      font-weight: 800;
      padding: 0 12px;
      height: 34px;
      border-radius: 12px;
    }

    #abfChatPageRoot .abfBtnGhost:hover {
      background: rgba(255,255,255,.08);
      transform: translateY(-1px);
    }

    #abfChatPageRoot .abfBtnShine {
      pointer-events: none;
      position: absolute;
      inset: -2px;
      background: radial-gradient(600px 100px at 0% 50%, rgba(255,255,255,.20), rgba(255,255,255,0) 60%);
      transform: translateX(-60%);
      opacity: .55;
      animation: abfShine 4.6s ease-in-out infinite;
    }

    @keyframes abfShine {
      0%, 20% { transform: translateX(-60%); opacity:.30; }
      50% { transform: translateX(40%); opacity:.65; }
      80%,100% { transform: translateX(120%); opacity:.20; }
    }

    #abfChatPageRoot .abfChatShell {
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(5,11,20,.64);
      backdrop-filter: blur(14px);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
      overflow: hidden;
    }

    #abfChatPageRoot .abfChatTopBar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 6px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.14);
    }

    #abfChatPageRoot .abfChatTopLeft {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 12px;
    }

    #abfChatPageRoot .abfRoomPill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(56,189,248,.18);
      background: rgba(56,189,248,.10);
      color: rgba(232,242,255,.90);
      font-weight: 900;
    }

    #abfChatPageRoot .abfMuted { color: rgba(232,242,255,.55); }

    #abfChatPageRoot .abfChatLog {
      height: min(44vh, 330px);
      overflow: auto;
      padding: 10px 12px 12px;
      background: linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.10));
      scroll-behavior: smooth;
    }

    #abfChatPageRoot .abfMsgRow {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      margin: 0 0 10px;
      animation: abfIn .18s ease-out both;
    }

    @keyframes abfIn {
      from { opacity:0; transform: translateY(6px); }
      to { opacity:1; transform: translateY(0); }
    }

    #abfChatPageRoot .abfMsgRow.self { flex-direction: row-reverse; }

    #abfChatPageRoot .abfAvatar { display:none !important; }

    #abfChatPageRoot .abfBubble {
      width: 100%;
      max-width: min(760px, 96%);
      border-radius: 16px;
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      box-shadow: 0 12px 40px rgba(0,0,0,.22);
    }

    #abfChatPageRoot .abfMsgRow.self .abfBubble {
      background: linear-gradient(180deg, rgba(56,189,248,.18), rgba(56,189,248,.08));
      border-color: rgba(56,189,248,.26);
    }

    /* Ligne message unique + wrap naturel */
    #abfChatPageRoot .abfLine {
      display: flex;
      align-items: baseline;
      gap: 8px;
      font-size: 11px;
      color: rgba(232,242,255,.72);
      flex-wrap: wrap;
      line-height: 1.35;
    }

    #abfChatPageRoot .abfTime {
      color: rgba(232,242,255,.50);
      font-weight: 800;
      letter-spacing: .02em;
      flex-shrink: 0;
      min-width: 42px;
    }

    #abfChatPageRoot .abfPseudo {
      font-weight: 900;
      color: rgba(232,242,255,.92);
      flex-shrink: 0;
    }

    #abfChatPageRoot .abfPseudo::before {
      content: "â€¢ ";
      color: rgba(232,242,255,.42);
      font-weight: 900;
    }

    #abfChatPageRoot .abfText {
      font-size: 10.5px;           /* police rÃ©duite */
      line-height: 1.35;
      color: rgba(232,242,255,.92);
      flex: 1 1 auto;
      white-space: pre-wrap;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    #abfChatPageRoot .abfMsgRow.self .abfText {
      color: rgba(232,242,255,.95);
    }

    #abfChatPageRoot .abfSys {
      margin: 8px 0 10px;
      text-align: center;
      color: rgba(232,242,255,.55);
      font-size: 10.5px;
      letter-spacing: .02em;
    }

    #abfChatPageRoot .abfSys span {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
    }

    #abfChatPageRoot .abfComposer {
      display: flex;
      gap: 10px;
      padding: 8px 10px;
      border-top: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      position: sticky;
      bottom: 0;
      align-items: center;
    }

    #abfChatPageRoot .abfComposerInput {
      flex: 1;
      height: 40px;
      border-radius: 14px;
      font-size: 11px;
      padding: 10px 12px;
    }

    #abfChatPageRoot .abfSendBtn {
      height: 40px;
      border-radius: 14px;
      padding: 0 16px;
    }

    #abfChatPageRoot .abfEmojiWrap { position: relative; flex: 0 0 auto; }

    #abfChatPageRoot .abfEmojiBtn {
      height: 40px;
      width: 46px;
      padding: 0;
      border-radius: 14px;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #abfChatPageRoot .abfEmojiPanel {
      position: absolute;
      bottom: calc(100% + 10px);
      left: 0;
      width: 280px;
      max-width: min(78vw, 320px);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(5,11,20,.92);
      backdrop-filter: blur(14px);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
      overflow: hidden;
      z-index: 30;
    }

    #abfChatPageRoot .abfEmojiHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }

    #abfChatPageRoot .abfEmojiTitle {
      font-size: 12px;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: rgba(232,242,255,.72);
      font-weight: 900;
    }

    #abfChatPageRoot .abfEmojiClose {
      height: 30px;
      width: 34px;
      padding: 0;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
    }

    #abfChatPageRoot .abfEmojiGrid {
      padding: 10px;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 6px;
    }

    #abfChatPageRoot .abfEmojiItem {
      height: 30px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      font-size: 18px;
      transition: transform .10s ease, background .10s ease, border-color .10s ease;
    }

    #abfChatPageRoot .abfEmojiItem:hover {
      transform: translateY(-1px);
      background: rgba(255,255,255,.08);
      border-color: rgba(56,189,248,.28);
    }

    @media (max-width: 640px) {
      #abfChatPageRoot .abfChatLog { padding: 10px 10px 12px; height: min(48vh, 360px); }
      #abfChatPageRoot .abfEmojiGrid { grid-template-columns: repeat(7, 1fr); }
    }

    @media (prefers-reduced-motion: reduce) {
      #abfChatPageRoot .abfMsgRow { animation: none !important; }
      #abfChatPageRoot .abfChatLog { scroll-behavior: auto; }
      #abfChatPageRoot .abfBtnShine { animation: none !important; }
    }
  </style>

  <script is:inline data-astro-rerun>
    (() => {
      const WS_URL = "wss://chat.radioabf.com/ws";
      const $ = (id) => document.getElementById(id);

      const pseudoEl = $("abfChatPseudo");
      const roomEl = $("abfChatRoom");
      const joinBtn = $("abfChatJoin");
      const logEl = $("abfChatLog");
      const msgEl = $("abfChatMsg");
      const sendBtn = $("abfChatSend");
      const statusEl = $("abfChatStatus");
      const errEl = $("abfChatError");
      const scrollBtn = $("abfChatScrollBtn");
      const onlineEl = $("abfChatOnline");
      const roomPillEl = $("abfChatRoomPill");
      const emojiBtn = $("abfChatEmojiBtn");
      const emojiPanel = $("abfChatEmojiPanel");
      const emojiGrid = $("abfChatEmojiGrid");
      const emojiClose = $("abfChatEmojiClose");

      if (!pseudoEl || !roomEl || !joinBtn || !logEl || !msgEl || !sendBtn || !statusEl || !errEl || !roomPillEl) return;

      const G = (window.__abfChat = window.__abfChat || {});
      G.ws = G.ws || null;
      G.joined = G.joined || false;
      G.myPseudo = G.myPseudo || "";
      G.currentRoom = G.currentRoom || (roomEl.value || "general");
      G.stickToBottom = G.stickToBottom ?? true;
      G.manualClosed = G.manualClosed ?? false;
      G.recoTimer = G.recoTimer || 0;
      G.recoTry = G.recoTry || 0;
      G.lastVisibleTry = G.lastVisibleTry || 0;
      const ONLINE_TTL_MS = 1000 * 60 * 3;
      G.seen = G.seen || new Map();

      const esc = (s) => String(s).replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
      const guest = () => "Guest " + Math.floor(1000 + Math.random()*9000);

      function setStatus(t, ok=false){
        statusEl.textContent = t;
        statusEl.style.color = ok ? "rgba(124,252,179,.95)" : "rgba(255,255,255,.75)";
      }

      function showErr(t=""){
        if (!t) { errEl.classList.add("hidden"); errEl.textContent=""; return; }
        errEl.classList.remove("hidden");
        errEl.textContent = t;
      }

      function nowHHMM(ts){
        try{ return new Date(ts).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"}); }
        catch{ return ""; }
      }

      function roomLabel(room){
        const r = String(room || "").toLowerCase();
        return r || "general";
      }

      function setRoomPill(room){
        const r = roomLabel(room);
        roomPillEl.textContent = `#${r}`;
      }

      function shouldStick(){
        const threshold = 64;
        return (logEl.scrollHeight - logEl.scrollTop - logEl.clientHeight) < threshold;
      }

      function scrollToLatest(force=false){
        if (force || G.stickToBottom) logEl.scrollTop = logEl.scrollHeight;
      }

      function updateScrollState(){
        G.stickToBottom = shouldStick();
        if (!G.stickToBottom) scrollBtn.classList.remove("hidden");
        else scrollBtn.classList.add("hidden");
      }

      function sysLine(html){
        const div = document.createElement("div");
        div.className = "abfSys";
        div.innerHTML = `<span>${html}</span>`;
        logEl.appendChild(div);
        scrollToLatest();
      }

      function msgBubble({ pseudo, message, created_at }){
        const isSelf = G.myPseudo && pseudo === G.myPseudo;
        const row = document.createElement("div");
        row.className = "abfMsgRow" + (isSelf ? " self" : "");
        const bubble = document.createElement("div");
        bubble.className = "abfBubble";
        const line = document.createElement("div");
        line.className = "abfLine";

        const t = document.createElement("span");
        t.className = "abfTime";
        t.textContent = nowHHMM(created_at);

        const txt = document.createElement("span");
        txt.className = "abfText";
        txt.textContent = String(message || "");

        const name = document.createElement("span");
        name.className = "abfPseudo";
        name.textContent = String(pseudo || "Listener");

        line.appendChild(t);
        line.appendChild(txt);
        line.appendChild(name);

        bubble.appendChild(line);
        row.appendChild(bubble);
        logEl.appendChild(row);
        scrollToLatest();
      }

      function touchSeen(pseudo){
        if (!pseudo) return;
        G.seen.set(pseudo, Date.now());
        pruneSeen();
        onlineEl.textContent = String(G.seen.size);
      }

      function pruneSeen(){
        const now = Date.now();
        for (const [k, v] of G.seen.entries()){
          if (now - v > ONLINE_TTL_MS) G.seen.delete(k);
        }
      }

      if (!G.__seenTimer){
        G.__seenTimer = setInterval(() => {
          pruneSeen();
          onlineEl.textContent = G.seen.size ? String(G.seen.size) : "â€”";
        }, 8000);
      }

      function clearReconnect(){
        if (G.recoTimer){ clearTimeout(G.recoTimer); G.recoTimer = 0; }
      }

      function scheduleReconnect(){
        if (G.manualClosed) return;
        if (G.recoTimer) return;
        const base = 900;
        const max = 8000;
        const wait = Math.min(max, base * Math.pow(1.55, Math.min(8, G.recoTry++)));
        G.recoTimer = setTimeout(() => {
          G.recoTimer = 0;
          connectFresh(false);
        }, wait);
      }

      function connectFresh(showConnectedLine=true){
        if (G.ws) {
          try { G.ws.close(); } catch(e) {}
          G.ws = null;
        }

        G.ws = new WebSocket(WS_URL);
        setStatus("Connectingâ€¦", false);

        G.ws.addEventListener("open", () => {
          setStatus("Connected", true);
          if (showConnectedLine) sysLine(`connected`);

          if (G.myPseudo && G.currentRoom && G.ws.readyState === WebSocket.OPEN) {
            try {
              G.ws.send(JSON.stringify({
                type: "join",
                pseudo: G.myPseudo,
                room: G.currentRoom
              }));
            } catch {}
          }
        });

        G.ws.addEventListener("close", () => {
          setStatus("Disconnected", false);
          sysLine(`disconnected`);
          G.joined = false;
          scheduleReconnect();
        });

        G.ws.addEventListener("error", () => {
          showErr("WebSocket error (TLS/DNS/proxy).");
          scheduleReconnect();
        });

        G.ws.addEventListener("message", (e) => {
          showErr("");
          let m;
          try { m = JSON.parse(e.data); } catch { return; }

          if (m.type === "hello") return;
          if (m.type === "joined") {
            G.joined = true;
            G.currentRoom = m.room || G.currentRoom;
            setRoomPill(G.currentRoom);
            sysLine(`joined <b>${esc(`#${roomLabel(G.currentRoom)}`)}</b> as <b>${esc(m.pseudo)}</b>`);
            (m.history || []).forEach((h) => {
              if (!h) return;
              touchSeen(h.pseudo);
              msgBubble({
                pseudo: h.pseudo || "Listener",
                message: h.message || "",
                created_at: h.created_at || Date.now(),
              });
            });
            G.stickToBottom = true;
            scrollToLatest(true);
            updateScrollState();
            return;
          }
          if (m.type === "presence") {
            const p = m.pseudo || "Listener";
            sysLine(`${esc(p)} ${esc(m.event)}`);
            touchSeen(p);
            return;
          }
          if (m.type === "msg") {
            touchSeen(m.pseudo);
            msgBubble({
              pseudo: m.pseudo || "Listener",
              message: m.message || "",
              created_at: m.created_at || Date.now(),
            });
            return;
          }
          if (m.type === "error") showErr("Error: " + m.code);
        });
      }

      function ensureConnected(){
        if (!G.ws || G.ws.readyState === WebSocket.CLOSED) connectFresh(false);
      }

      function join(){
        showErr("");
        ensureConnected();
        const pseudo = (pseudoEl.value || "").trim() || guest();
        const room = roomEl.value || "general";

        G.myPseudo = pseudo;
        G.currentRoom = room;
        setRoomPill(G.currentRoom);

        logEl.innerHTML = "";
        G.seen.clear();
        onlineEl.textContent = "â€”";
        G.joined = false;

        const sendJoin = () => {
          if (!G.ws || G.ws.readyState !== WebSocket.OPEN) return;
          try { G.ws.send(JSON.stringify({ type:"join", pseudo, room })); } catch {}
        };

        if (G.ws && G.ws.readyState === WebSocket.OPEN) {
          sendJoin();
        } else {
          const t0 = Date.now();
          const tick = () => {
            if (!G.ws) return;
            if (G.ws.readyState === WebSocket.OPEN) return sendJoin();
            if (Date.now() - t0 > 2500) return showErr("Not connected.");
            requestAnimationFrame(tick);
          };
          tick();
        }
      }

      function send(){
        showErr("");
        if (!G.ws || G.ws.readyState !== WebSocket.OPEN) return showErr("Not connected.");
        if (!G.joined) return showErr("Join a room first.");
        const text = (msgEl.value || "").trim();
        if (!text) return;
        try { G.ws.send(JSON.stringify({ type:"msg", message: text })); } catch {}
        touchSeen(G.myPseudo);
        msgEl.value = "";
        msgEl.focus();
      }

      // Emojis
      const EMOJIS = [
        "ðŸ˜€","ðŸ˜„","ðŸ˜","ðŸ˜…","ðŸ˜‚","ðŸ¤£","ðŸ˜Š","ðŸ˜",
        "ðŸ˜Ž","ðŸ¤©","ðŸ¥³","ðŸ¤¯","ðŸ˜´","ðŸ˜­","ðŸ˜¡","ðŸ¤",
        "ðŸ‘","ðŸ‘Ž","ðŸ‘","ðŸ™","ðŸ”¥","ðŸ’Ž","âœ¨","âš¡",
        "ðŸŽ¶","ðŸŽ§","ðŸŽšï¸","ðŸŽ›ï¸","ðŸŽ¤","ðŸ“»","ðŸš€","ðŸŒ™",
        "â¤ï¸","ðŸ’™","ðŸ’œ","ðŸ¤","ðŸ–¤","ðŸ’š","ðŸ§¡","ðŸ’›"
      ];

      function setEmojiOpen(open){
        if (open) emojiPanel.classList.remove("hidden");
        else emojiPanel.classList.add("hidden");
      }

      function insertAtCursor(input, text){
        const start = input.selectionStart ?? input.value.length;
        const end = input.selectionEnd ?? input.value.length;
        const before = input.value.slice(0, start);
        const after = input.value.slice(end);
        input.value = before + text + after;
        const pos = start + text.length;
        input.setSelectionRange(pos, pos);
        input.focus();
      }

      function buildEmojiGrid(){
        emojiGrid.innerHTML = "";
        EMOJIS.forEach((e) => {
          const b = document.createElement("button");
          b.type = "button";
          b.className = "abfEmojiItem";
          b.textContent = e;
          b.addEventListener("click", () => {
            insertAtCursor(msgEl, e);
            setEmojiOpen(false);
          });
          emojiGrid.appendChild(b);
        });
      }

      buildEmojiGrid();

      emojiBtn.addEventListener("click", () => {
        const isOpen = !emojiPanel.classList.contains("hidden");
        setEmojiOpen(!isOpen);
      });

      emojiClose.addEventListener("click", () => setEmojiOpen(false));

      document.addEventListener("click", (e) => {
        const t = e.target;
        if (!t) return;
        if (emojiPanel.classList.contains("hidden")) return;
        if (emojiPanel.contains(t) || emojiBtn.contains(t)) return;
        setEmojiOpen(false);
      });

      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") setEmojiOpen(false);
      });

      logEl.addEventListener("scroll", () => updateScrollState(), { passive: true });

      scrollBtn.addEventListener("click", () => {
        G.stickToBottom = true;
        scrollToLatest(true);
        updateScrollState();
      });

      roomEl.addEventListener("change", () => setRoomPill(roomEl.value));

      joinBtn.addEventListener("click", join);
      sendBtn.addEventListener("click", send);
      msgEl.addEventListener("keydown", (e) => { if (e.key === "Enter") send(); });

      setRoomPill(G.currentRoom || roomEl.value || "general");

      connectFresh(true);

      function onVisible(){
        if (document.visibilityState !== "visible") return;
        const now = Date.now();
        if (now - G.lastVisibleTry < 1400) return;
        G.lastVisibleTry = now;
        if (!G.ws || G.ws.readyState >= WebSocket.CLOSING) {
          connectFresh(false);
        }
      }

      document.addEventListener("visibilitychange", onVisible);

      window.addEventListener("pagehide", () => {
        G.manualClosed = true;
        clearReconnect();
        try { if (G.ws) G.ws.close(); } catch {}
      });

      requestAnimationFrame(() => updateScrollState());
    })();
  </script>
</Base>