---
import Base from "../layouts/Base.astro";
---

<Base
  title="Music ‚Äî RadioABF"
  description="Latest tracks played on RadioABF radioabf.com. Vote for favorites and check real-time community charts."
  canonical="/music"
  image="/og-image.jpg"
>
  <section class="relative overflow-hidden rounded-3xl border border-white/10 bg-[#0A1F33] p-5 sm:p-6 mb-6 shadow-2xl">
    <!-- background glow -->
    <div class="pointer-events-none absolute -top-40 -left-40 w-[520px] h-[520px] rounded-full bg-cyan-500/15 blur-[120px]"></div>
    <div class="pointer-events-none absolute -bottom-40 -right-40 w-[520px] h-[520px] rounded-full bg-blue-600/15 blur-[120px]"></div>

    <div class="relative z-10">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div class="min-w-0">
          <div class="flex items-center gap-3 text-sm tracking-widest text-white/60 uppercase mb-3">
            <span class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></span>
            Music
          </div>

          <h1 class="text-3xl sm:text-4xl font-extrabold leading-tight">
            Latest tracks played on <span class="text-cyan-200">RadioABF</span>
          </h1>

          <p class="text-white/65 mt-3 max-w-2xl">
            Live history, covers and weekly community votes.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- NOW PLAYING (bigger / classier) -->
  <section class="relative overflow-hidden rounded-3xl border border-white/10 bg-[#0A1F33] p-6 md:p-8 mb-10 shadow-2xl">
    <!-- background glow -->
    <div class="pointer-events-none absolute -top-40 -left-40 w-[520px] h-[520px] rounded-full bg-cyan-500/15 blur-[120px]"></div>
    <div class="pointer-events-none absolute -bottom-40 -right-40 w-[520px] h-[520px] rounded-full bg-blue-600/15 blur-[120px]"></div>

    <div class="relative">
      <div class="flex items-center justify-between gap-4 mb-5">
        <div class="flex items-center gap-3">
          <span class="w-2 h-2 rounded-full bg-cyan-400 animate-pulse"></span>
          <div class="text-sm text-white/60 uppercase tracking-wider">Now Playing</div>
        </div>

        <div
          id="musicTime"
          class="flex-none text-xs px-3 py-1.5 rounded-xl border border-white/10 bg-white/5 text-white/70 tabular-nums"
        >
          --:--
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-[140px_1fr_auto] gap-5 items-center">
        <div class="flex items-center justify-center">
          <div
            id="musicCoverWrapper"
            class="abfCover w-28 h-28 md:w-32 md:h-32 rounded-2xl border border-white/10 overflow-hidden flex-none shadow-xl"
          >
            <img id="musicCover" class="hidden" alt="Current cover" />
            <div class="abfCoverFallback">
              <img src="/logo-abf.png" alt="ABF" loading="lazy" decoding="async" />
            </div>
          </div>
        </div>

        <div class="min-w-0">
          <div id="musicArtist" class="text-xl md:text-2xl font-semibold text-white truncate leading-tight">‚Äî</div>
          <div id="musicTitle" class="text-white/70 text-base md:text-lg truncate mt-1">‚Äî</div>

          <div class="mt-4 flex flex-wrap items-center gap-2">
            <span class="text-xs text-white/60 border border-white/10 bg-white/5 px-3 py-1.5 rounded-xl">
              Live metadata
            </span>
            <span class="text-xs text-white/60 border border-white/10 bg-white/5 px-3 py-1.5 rounded-xl">
              Vote once / 24h
            </span>
          </div>
        </div>

        <button
          id="nowVoteBtn"
          class="group w-full md:w-auto justify-center bg-white/5 hover:bg-white/10 border border-white/10 rounded-2xl px-5 py-4 text-sm text-white/85 transition flex items-center gap-3"
          type="button"
        >
          <span class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-white/5 border border-white/10 group-hover:bg-white/10 transition">
            üëç
          </span>
          <span class="flex items-baseline gap-2">
            <span class="font-semibold">Vote</span>
            <span class="text-white/60">‚Ä¢</span>
            <span class="tabular-nums font-semibold"><span id="nowVoteCount">0</span></span>
          </span>
        </button>
      </div>
    </div>
  </section>

  <!-- TOP THIS WEEK (more visible) -->
  <section class="rounded-3xl border border-white/10 bg-[#0A1F33] p-6 md:p-8 mb-10 shadow-xl">
    <div class="flex items-start justify-between gap-4 mb-5">
      <div class="min-w-0">
        <div class="text-sm text-white/60 uppercase tracking-wider">Top This Week</div>
        <div class="text-xs text-white/50 mt-1">
          Community votes ‚Ä¢ updates in real time
        </div>
      </div>
      <div class="text-xs text-white/70 border border-white/10 bg-white/5 px-3 py-1.5 rounded-xl flex-none">
        Week <span id="musicWeekId" class="tabular-nums">‚Äî</span>
      </div>
    </div>
    <ol id="topChart" class="space-y-3"></ol>
  </section>

  <!-- LAST PLAYED -->
  <section class="rounded-3xl border border-white/10 bg-[#0A1F33] p-6 md:p-8">
    <div class="flex items-center justify-between gap-4 mb-5">
      <div class="text-sm text-white/60 uppercase tracking-wider">Last Played</div>
      <div class="text-xs text-white/50">Tap üëç to vote</div>
    </div>
    <ul id="lastPlayed" class="space-y-3 text-white/80 text-sm"></ul>
  </section>

  <style>
    #topChart { text-transform: none; }
    .tabular-nums { font-variant-numeric: tabular-nums; }
  </style>

  <script is:inline data-astro-rerun>
  (() => {
    const HISTORY_KEY = "abf_history"; // legacy fallback (lecture seule)
    const DAY = 24 * 60 * 60 * 1000;

    function isMusicRoute(){
      return window.location.pathname === "/music";
    }

    // ====== WEEK ID ======
    function getISOWeekId(d = new Date()){
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = date.getUTCDay() || 7;
      date.setUTCDate(date.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
      return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2, "0")}`;
    }
    function weekLabel(){ return getISOWeekId().replace("-W"," W"); }

    function nowTs(){ return Date.now(); }

    function splitTrack(entry){
      const s = String(entry || "").trim().replace(/^undefined\s*-\s*/i, "");
      const idx = s.indexOf(" - ");
      if (idx === -1) return { artist: s, title: "" };
      return { artist: s.slice(0, idx).trim(), title: s.slice(idx + 3).trim() };
    }

    // ‚úÖ Block voting for ABF CLUB shows
    function isBlockedShow(artist){
      return /^abf\s*club\b/i.test(String(artist || "").trim());
    }
    function blockedVoteMsg(){
      alert("Voting is disabled for ABF CLUB shows. Please vote for tracks only üôÇ");
    }

    // NORM key for session
    function normKey(artist, title){
      return (artist + " - " + title)
        .toLowerCase()
        .replace(/\s+/g, " ")
        .replace(/[‚Äú‚Äù"']/g, "")
        .trim();
    }

    // RAW key for server
    function rawKey(artist, title){
      const a = String(artist || "").trim();
      const t = String(title || "").trim();
      return `${a} - ${t}`.trim();
    }

    function esc(s){
      return String(s || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    function fmtTime(ts){
      if (!ts) return "--:--";
      const d = new Date(ts);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${hh}:${mm}`;
    }

    // ===== Formatting rules =====
    function upperArtist(s){ return String(s || "‚Äî").trim().toUpperCase(); }
    function titleCaseEN(input){
      const s = String(input || "").trim();
      if (!s) return "‚Äî";
      const lowerWords = new Set([
        "a","an","the","and","but","or","nor","for","so","yet",
        "as","at","by","for","from","in","into","near","of","on","onto","over","per","to","up","via","with","within","without"
      ]);
      const parts = s.split(/(\s+)/);
      return parts.map((chunk, idx) => {
        if (/^\s+$/.test(chunk)) return chunk;
        const word = chunk;
        if (word === word.toUpperCase() && /[A-Z]/.test(word) && word.length <= 6) return word;
        const hyParts = word.split("-");
        const rebuilt = hyParts.map((w, hIdx) => {
          const cleaned = w.replace(/[^\p{L}\p{N}'‚Äô]/gu, "");
          const lower = cleaned.toLowerCase();
          const isFirst = idx === 0 && hIdx === 0;
          const isLast = idx === parts.length - 1 && hIdx === hyParts.length - 1;
          if (!cleaned) return w;
          if (!isFirst && !isLast && lowerWords.has(lower)) return w.replace(cleaned, lower);
          const cap = lower.charAt(0).toUpperCase() + lower.slice(1);
          return w.replace(cleaned, cap);
        });
        return rebuilt.join("-");
      }).join("");
    }

    // ===== History fallback (local) ‚Äî lecture seule =====
    function loadHistory(){
      let raw = [];
      try{ raw = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]"); }
      catch{ raw = []; }
      return (raw || []).map((x) => {
        if (typeof x === "string") return { t: x, ts: 0, cover_url: "" };
        if (x && typeof x === "object" && typeof x.t === "string") {
          return { t: x.t, ts: Number(x.ts) || 0, cover_url: String(x.cover_url || "") };
        }
        return null;
      }).filter(Boolean);
    }

    // ===== Server nowplaying (expects cover_url in now + history) =====
    async function fetchServerNowPlaying(limit = 12){
      try{
        const res = await fetch(`/api/nowplaying?limit=${limit}`, { cache: "no-store" });
        const data = await res.json().catch(()=> ({}));
        if (!data?.ok) return [];

        const out = [];

        // now
        if (data?.now){
          const rawNow = String(data?.now?.raw || "").trim();
          const a = String(data?.now?.artist || "").trim();
          const t = String(data?.now?.title || "").trim();
          const raw = rawNow || (a || t ? `${a} - ${t}`.trim() : "");
          if (raw){
            out.push({
              t: raw,
              ts: Number(data?.now?.played_at_ms) ||
                  (data?.now?.played_at ? new Date(data.now.played_at).getTime() : Date.now()),
              cover_url: String(data?.now?.cover_url || "")
            });
          }
        }

        // history
        if (Array.isArray(data?.history)){
          for (const row of data.history){
            const raw = String(row?.raw || `${row?.artist || ""} - ${row?.title || ""}`.trim() || "").trim();
            if (!raw) continue;
            out.push({
              t: raw,
              ts: Number(row?.played_at_ms) ||
                  (row?.played_at ? new Date(row.played_at).getTime() : 0),
              cover_url: String(row?.cover_url || "")
            });
          }
        }

        // dedupe
        const seen = new Set();
        const deduped = [];
        for (const item of out){
          const k = String(item.t || "").toLowerCase();
          if (!k || seen.has(k)) continue;
          seen.add(k);
          deduped.push(item);
        }

        return deduped.slice(0, limit);
      }catch{
        return [];
      }
    }

    function setCover(url){
      const img = document.getElementById("musicCover");
      if (!img) return;
      const u = String(url || "").trim();
      if (u){
        img.src = u;
        img.classList.remove("hidden");
      } else {
        img.removeAttribute("src");
        img.classList.add("hidden");
      }
    }

    // Helper cover HTML
    function coverHtmlByUrl(url, sizeClass = "w-12 h-12 rounded-xl") {
      const u = String(url || "").trim();
      return `
        <div class="abfCover ${sizeClass} border border-white/10 overflow-hidden flex-none">
          <img src="${u ? esc(u) : ""}" alt="" class="${u ? "" : "hidden"}" loading="lazy" decoding="async" />
          <div class="abfCoverFallback">
            <img src="/logo-abf.png" alt="ABF" loading="lazy" decoding="async" />
          </div>
        </div>
      `;
    }

    // ===== Votes API (server-side) =====
    const VOTES_TTL_MS = 10_000; // 10s
    function votesCacheKey(){ return `votes:${getISOWeekId()}`; }

async function apiGetVotes(){
  const week = getISOWeekId();
  const k = votesCacheKey();

  window.__abfVotesCache = window.__abfVotesCache || {};
  const c = window.__abfVotesCache[k];
  const now = nowTs();
  if (c && now < c.exp) return c.payload || { votes: {}, covers: {} };

  try {
    const res = await fetch(`/api/vote?week=${encodeURIComponent(week)}`, { cache: "no-store" });
    const data = await res.json().catch(() => ({}));

    const votes = {};
    const covers = {}; // ‚úÖ track_key -> cover_url
    const top = Array.isArray(data?.top) ? data.top : [];

    for (const row of top){
      const key = String(row?.track_key || "").trim();
      const count = Number(row?.count || 0);
      if (!key) continue;

      votes[key] = count;

      const cu = String(row?.cover_url || "").trim();
      if (cu) covers[key] = cu;
    }

    const payload = { votes, covers };
    window.__abfVotesCache[k] = { exp: now + VOTES_TTL_MS, payload };
    return payload;
  } catch {
    return { votes: {}, covers: {} };
  }
}


    // Session UX anti-spam (24h) ‚Äî uses NORM key
    function markSessionVoted(norm){
      window.__abfVotedSession = window.__abfVotedSession || {};
      window.__abfVotedSession[norm] = nowTs();
    }
    function sessionAlreadyVoted(norm){
      const m = window.__abfVotedSession || {};
      const last = m[norm] || 0;
      return (nowTs() - last) < DAY;
    }

    async function apiVote(trackKeyRaw, artist = "", title = ""){
      const week = getISOWeekId();

      const res = await fetch("/api/vote", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ week, track_key: trackKeyRaw, artist, title }),
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok || data?.ok === false){
        return {
          ok: false,
          status: res.status,
          error: data?.error || `HTTP ${res.status}`,
          reason: data?.reason || "",
        };
      }

      return { ok: true, status: res.status, week: data?.week || week, count: data?.count };
    }

    function voteErrorToast(r){
      if (r?.status === 429){
        alert("You already voted today. Come back in 24h üôÇ");
        return;
      }
      if (r?.status === 409 || r?.reason === "cooldown"){
        alert("You already voted for this track. Come back in 24h üôÇ");
        return;
      }
      alert(`Vote failed: ${r?.error || "Unknown error"}`);
    }

    // ‚úÖ Dedupe TOP by normalized key and filters ABF CLUB from Top.
    function dedupeTopEntries(votesObj){
      const bestByNorm = new Map(); // norm -> { key, count }
      for (const [key, count] of Object.entries(votesObj || {})){
        const parts = String(key).split(" - ");
        const aRaw = (parts[0] || "").trim();
        const tRaw = (parts.slice(1).join(" - ") || "").trim();
        if (!aRaw || !tRaw) continue;

        if (isBlockedShow(aRaw)) continue;

        const n = normKey(aRaw, tRaw);
        const c = Number(count) || 0;
        const prev = bestByNorm.get(n);
        if (!prev || c > prev.count){
          bestByNorm.set(n, { key, count: c });
        }
      }
      return Array.from(bestByNorm.values());
    }

    async function renderHistory(){
      if (!isMusicRoute()) return;

      const artistEl = document.getElementById("musicArtist");
      const titleEl = document.getElementById("musicTitle");
      const timeEl = document.getElementById("musicTime");
      const listEl = document.getElementById("lastPlayed");
      const chartEl = document.getElementById("topChart");
      const nowVoteBtn = document.getElementById("nowVoteBtn");
      const nowVoteCount = document.getElementById("nowVoteCount");
      const weekEl = document.getElementById("musicWeekId");

      if (weekEl) weekEl.textContent = weekLabel();
      if (!artistEl || !titleEl || !listEl || !chartEl) return;

      let history = await fetchServerNowPlaying(12);
      if (!history.length) history = loadHistory();

      if (!history.length){
        artistEl.textContent = "‚Äî";
        titleEl.textContent = "‚Äî";
        if (timeEl) timeEl.textContent = "--:--";
        listEl.innerHTML = `<li class="text-white/50">Start the player to load the history.</li>`;
        chartEl.innerHTML = `<li class="text-white/50">No votes yet this week.</li>`;
        setCover("");
        if (nowVoteBtn) nowVoteBtn.style.display = "none";
        return;
      }

      // Build cover map from server payload only (‚úÖ no abf_covers_v1)
      const coverByNorm = {};
      for (const entry of history){
        const t = splitTrack(entry.t);
        const n = normKey(t.artist, t.title);
        const u = String(entry.cover_url || "").trim();
        if (n && u) coverByNorm[n] = u;
      }

      function getCoverUrl(artist, title){
        const n = normKey(artist, title);
        return coverByNorm[n] || "";
      }

      const { votes, covers: coverByKey } = await apiGetVotes();

      // NOW PLAYING
      const currentEntry = history[0];
      const current = splitTrack(currentEntry.t);

      const prettyNowArtist = upperArtist(current.artist || "‚Äî");
      const prettyNowTitle = titleCaseEN(current.title || "‚Äî");

      artistEl.textContent = prettyNowArtist;
      titleEl.textContent = prettyNowTitle;
      if (timeEl) timeEl.textContent = fmtTime(currentEntry.ts);

      setCover(String(currentEntry.cover_url || "").trim() || getCoverUrl(current.artist, current.title));

      const currentKeyNorm = normKey(current.artist, current.title);
      const currentKeyRaw  = rawKey(current.artist, current.title);

      const currentCount = (votes[currentKeyRaw] != null)
        ? votes[currentKeyRaw]
        : (votes[currentKeyNorm] || 0);

      if (nowVoteCount) nowVoteCount.textContent = String(currentCount);

      const blockedNow = isBlockedShow(current.artist);

      if (nowVoteBtn){
        nowVoteBtn.style.display = "flex";

        if (blockedNow){
          nowVoteBtn.style.opacity = "0.45";
          nowVoteBtn.style.cursor = "not-allowed";
          nowVoteBtn.onclick = () => blockedVoteMsg();
        } else {
          const alreadySession = sessionAlreadyVoted(currentKeyNorm);
          nowVoteBtn.style.opacity = alreadySession ? "0.55" : "1";
          nowVoteBtn.style.cursor = alreadySession ? "not-allowed" : "pointer";

          nowVoteBtn.onclick = async () => {
            if (sessionAlreadyVoted(currentKeyNorm)){
              alert("You already voted for this track. Come back in 24h üôÇ");
              return;
            }

            nowVoteBtn.style.opacity = "0.7";
            nowVoteBtn.style.cursor = "wait";

            const r = await apiVote(currentKeyRaw, current.artist, current.title);

            if (!r.ok){
              nowVoteBtn.style.opacity = "1";
              nowVoteBtn.style.cursor = "pointer";
              voteErrorToast(r);
              return;
            }

            markSessionVoted(currentKeyNorm);

            const newCount = (r.count != null) ? r.count : (Number(currentCount || 0) + 1);
            if (nowVoteCount) nowVoteCount.textContent = String(newCount);

            const k = votesCacheKey();
            if (window.__abfVotesCache?.[k]) window.__abfVotesCache[k].exp = 0;

            nowVoteBtn.style.opacity = "0.55";
            nowVoteBtn.style.cursor = "not-allowed";
            renderHistory();
          };
        }
      }

      // LAST PLAYED
      listEl.innerHTML = history
        .slice(1)
        .map((entry) => {
          const t = splitTrack(entry.t);
          const prettyArtist = upperArtist(t.artist || "‚Äî");
          const prettyTitle = titleCaseEN(t.title || "‚Äî");

          const kNorm = normKey(t.artist, t.title);
          const kRaw  = rawKey(t.artist, t.title);

          const time = fmtTime(entry.ts);
          const blocked = isBlockedShow(t.artist);

          const coverUrl = String(entry.cover_url || "").trim() || getCoverUrl(t.artist, t.title);

          return `
            <li class="flex items-center justify-between gap-3 border border-white/5 bg-white/[0.03] hover:bg-white/[0.05] transition rounded-2xl p-3">
              <div class="flex items-center gap-3 min-w-0 flex-1">
                ${coverHtmlByUrl(coverUrl)}
                <div class="min-w-0 flex-1">
                  <div class="flex items-center gap-3">
                    <div class="font-semibold text-white truncate">${esc(prettyArtist)}</div>
                    <div class="ml-auto flex-none text-xs px-2 py-0.5 rounded-lg border border-white/10 bg-white/5 text-white/60 tabular-nums">
                      ${time}
                    </div>
                  </div>
                  <div class="text-white/60 text-sm truncate">${esc(prettyTitle)}</div>
                </div>
              </div>
              <button
                class="voteBtn flex-none bg-white/5 hover:bg-white/10 border border-white/10 rounded-2xl px-3 py-2 text-sm text-white/85 transition"
                data-norm="${esc(kNorm)}"
                data-raw="${esc(kRaw)}"
                data-artist="${esc(t.artist || "")}"
                data-title="${esc(t.title || "")}"
                data-blocked="${blocked ? "1" : "0"}"
                type="button"
                aria-label="Vote"
                title="${blocked ? "Voting disabled for ABF CLUB" : "Vote"}"
                style="${blocked ? "opacity:0.45;cursor:not-allowed;" : ""}"
              >
                üëç <span class="voteCount tabular-nums">0</span>
              </button>
            </li>
          `;
        })
        .join("");

      // TOP THIS WEEK (covers from server map only)
      const deduped = dedupeTopEntries(votes)
        .filter((x) => Number(x.count) > 0)
        .sort((a,b) => Number(b.count) - Number(a.count))
        .slice(0, 10);

      if (!deduped.length){
        chartEl.innerHTML = `<li class="text-white/50">No votes yet ‚Äî be the first üôÇ</li>`;
      } else {
        const max = Math.max(...deduped.map((e) => Number(e.count) || 0), 1);

        chartEl.innerHTML = deduped.map(({ key, count }, i) => {
          const parts = String(key).split(" - ");
          const artistRaw = (parts[0] || "‚Äî").trim();
          const titleRaw = (parts.slice(1).join(" - ") || "‚Äî").trim();

          const artist = upperArtist(artistRaw);
          const title = titleCaseEN(titleRaw);

          const pct = Math.round((Number(count) / max) * 100);
          const rankBadge =
            i === 0 ? "bg-white/10 border-white/15" :
            i === 1 ? "bg-white/8 border-white/15" :
            i === 2 ? "bg-white/6 border-white/15" :
            "bg-white/5 border-white/10";

          const n = normKey(artistRaw, titleRaw);
          const coverUrl = coverByKey[key] || coverByNorm[n] || "";

          return `
            <li class="group flex items-center gap-4 p-4 rounded-3xl border border-white/5 bg-white/[0.03] hover:bg-white/[0.05] transition">
              <div class="flex-none w-10 h-10 rounded-2xl border ${rankBadge} flex items-center justify-center text-sm font-semibold text-white/90 tabular-nums">
                ${i+1}
              </div>
              ${coverHtmlByUrl(coverUrl, "w-14 h-14 rounded-2xl")}
              <div class="min-w-0 flex-1">
                <div class="flex items-start gap-3">
                  <div class="min-w-0">
                    <div class="font-semibold text-white truncate">${esc(artist)}</div>
                    <div class="text-white/65 text-sm truncate">${esc(title)}</div>
                  </div>
                  <div class="ml-auto flex-none text-sm text-white/90 font-semibold tabular-nums">
                    ${count} <span class="text-white/50 font-normal">votes</span>
                  </div>
                </div>
                <div class="mt-3 h-2 rounded-full bg-white/5 border border-white/10 overflow-hidden">
                  <div class="h-full bg-gradient-to-r from-[#145C8F] to-[#2FC2FF]" style="width:${pct}%"></div>
                </div>
              </div>
            </li>
          `;
        }).join("");
      }

      // Wire vote buttons
      listEl.querySelectorAll(".voteBtn").forEach((btn) => {
        const kNorm = btn.dataset.norm || "";
        const kRaw  = btn.dataset.raw || "";
        const a     = btn.dataset.artist || "";
        const t     = btn.dataset.title || "";
        const blocked = btn.dataset.blocked === "1";

        const countEl = btn.querySelector(".voteCount");

        const c = (votes[kRaw] != null) ? votes[kRaw] : (votes[kNorm] || 0);
        if (countEl) countEl.textContent = String(c);

        if (blocked){
          btn.onclick = () => blockedVoteMsg();
          return;
        }

        const alreadySession = sessionAlreadyVoted(kNorm);
        btn.style.opacity = alreadySession ? "0.55" : "1";
        btn.style.cursor = alreadySession ? "not-allowed" : "pointer";

        btn.onclick = async () => {
          if (sessionAlreadyVoted(kNorm)){
            alert("You already voted for this track. Come back in 24h üôÇ");
            return;
          }

          btn.style.opacity = "0.7";
          btn.style.cursor = "wait";

          const r = await apiVote(kRaw || rawKey(a, t), a, t);

          if (!r.ok){
            btn.style.opacity = "1";
            btn.style.cursor = "pointer";
            voteErrorToast(r);
            return;
          }

          markSessionVoted(kNorm);

          const newCount = (r.count != null) ? r.count : (Number(c || 0) + 1);
          if (countEl) countEl.textContent = String(newCount);

          const kk = votesCacheKey();
          if (window.__abfVotesCache?.[kk]) window.__abfVotesCache[kk].exp = 0;

          btn.style.opacity = "0.55";
          btn.style.cursor = "not-allowed";
          renderHistory();
        };
      });
    }

    function startMusicTimer(){
      if (window.__abfMusicTimer) clearInterval(window.__abfMusicTimer);
      window.__abfMusicTimer = setInterval(renderHistory, 8000);
    }

    function initMusicPage(){
      if (!isMusicRoute()) return;
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          renderHistory();
          startMusicTimer();
        });
      });
    }

    initMusicPage();

    // bind listeners once globally
    if (!window.__abfMusicListeners){
      document.addEventListener("astro:page-load", initMusicPage);
      document.addEventListener("astro:after-swap", initMusicPage);

      window.addEventListener("abf:history-updated", () => {
        if (!isMusicRoute()) return;
        renderHistory();
      });

      document.addEventListener("astro:before-swap", () => {
        if (window.__abfMusicTimer) clearInterval(window.__abfMusicTimer);
      });

      window.__abfMusicListeners = true;
    }
  })();
  </script>a---
import Base from "../layouts/Base.astro";
---

<Base
  title="Music ‚Äî RadioABF"
  description="Live track history, covers and weekly community charts on RadioABF."
  canonical="/music"
  image="/og-image.jpg"
>
  <!-- PREMIUM PORTAL HEADER -->
  <section class="relative overflow-hidden rounded-3xl border border-white/10 bg-[#0A1F33] p-5 sm:p-6 mb-6 shadow-2xl">
    <div class="pointer-events-none absolute -top-40 -left-40 w-[560px] h-[560px] rounded-full bg-cyan-500/15 blur-[120px]"></div>
    <div class="pointer-events-none absolute -bottom-40 -right-40 w-[560px] h-[560px] rounded-full bg-blue-600/15 blur-[120px]"></div>

    <div class="relative z-10 flex items-start justify-between gap-4 flex-wrap">
      <div class="min-w-0">
        <div class="flex items-center gap-3 text-sm tracking-widest text-white/60 uppercase mb-3">
          <span class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></span>
          Music Portal
        </div>

        <h1 class="text-3xl sm:text-4xl font-extrabold leading-tight">
          Live track history &amp; <span class="text-cyan-200">community charts</span>
        </h1>

        <p class="text-white/65 mt-3 max-w-2xl">
          Clear titles, Directus-first covers, and real-time votes ‚Äî all in one place.
        </p>
      </div>

      <div class="flex items-center gap-2 flex-wrap">
        <div class="text-xs text-white/70 border border-white/10 bg-white/5 px-3 py-1.5 rounded-xl flex-none">
          Week <span id="musicWeekId" class="tabular-nums">‚Äî</span>
        </div>
        <div class="text-xs text-white/70 border border-white/10 bg-white/5 px-3 py-1.5 rounded-xl flex-none">
          Updated <span id="musicUpdatedAt" class="tabular-nums">--:--</span>
        </div>
      </div>
    </div>
  </section>

  <!-- NOW PLAYING HERO -->
  <section class="relative overflow-hidden rounded-3xl border border-white/10 bg-[#0A1F33] p-6 md:p-8 mb-6 shadow-2xl">
    <div class="pointer-events-none absolute -top-40 -left-40 w-[560px] h-[560px] rounded-full bg-cyan-500/15 blur-[120px]"></div>
    <div class="pointer-events-none absolute -bottom-40 -right-40 w-[560px] h-[560px] rounded-full bg-blue-600/15 blur-[120px]"></div>

    <div class="relative">
      <div class="flex items-center justify-between gap-4 mb-5 flex-wrap">
        <div class="flex items-center gap-3">
          <span class="w-2 h-2 rounded-full bg-cyan-400 animate-pulse"></span>
          <div class="text-sm text-white/60 uppercase tracking-wider">Now Playing</div>
        </div>

        <div class="flex items-center gap-2 flex-wrap">
          <div
            id="musicTime"
            class="flex-none text-xs px-3 py-1.5 rounded-xl border border-white/10 bg-white/5 text-white/70 tabular-nums"
          >
            --:--
          </div>

          <div
            id="musicCoverSource"
            class="hidden text-xs px-3 py-1.5 rounded-xl border border-white/10 bg-white/5 text-white/70"
          >
            ‚Äî
          </div>

          <div class="text-xs px-3 py-1.5 rounded-xl border border-white/10 bg-white/5 text-white/60">
            Vote once / 24h
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-[160px_1fr_auto] gap-5 items-center">
        <div class="flex items-center justify-center">
          <div
            id="musicCoverWrapper"
            class="abfCover w-32 h-32 md:w-36 md:h-36 rounded-2xl border border-white/10 overflow-hidden flex-none shadow-xl"
          >
            <img id="musicCover" class="hidden" alt="Current cover" />
            <div class="abfCoverFallback">
              <img src="/logo-abf.png" alt="ABF" loading="lazy" decoding="async" />
            </div>
          </div>
        </div>

        <div class="min-w-0">
          <div
            id="musicArtist"
            class="text-2xl md:text-3xl font-extrabold text-white truncate leading-tight"
          >
            ‚Äî
          </div>
          <div id="musicTitle" class="text-white/70 text-base md:text-lg truncate mt-1">‚Äî</div>

          <div class="mt-4 flex flex-wrap items-center gap-2">
            <span class="text-xs text-white/60 border border-white/10 bg-white/5 px-3 py-1.5 rounded-xl">
              Live metadata
            </span>
            <span class="text-xs text-white/60 border border-white/10 bg-white/5 px-3 py-1.5 rounded-xl">
              Directus-first covers
            </span>
            <span class="text-xs text-white/60 border border-white/10 bg-white/5 px-3 py-1.5 rounded-xl">
              Clean titling
            </span>
          </div>
        </div>

        <button
          id="nowVoteBtn"
          class="group w-full md:w-auto justify-center bg-white/5 hover:bg-white/10 border border-white/10 rounded-2xl px-5 py-4 text-sm text-white/85 transition flex items-center gap-3"
          type="button"
        >
          <span class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-white/5 border border-white/10 group-hover:bg-white/10 transition">
            üëç
          </span>
          <span class="flex items-baseline gap-2">
            <span class="font-semibold">Vote</span>
            <span class="text-white/60">‚Ä¢</span>
            <span class="tabular-nums font-semibold"><span id="nowVoteCount">0</span></span>
          </span>
        </button>
      </div>
    </div>
  </section>

  <!-- MAIN GRID: HISTORY (LEFT) + CHARTS (RIGHT) -->
  <section class="grid grid-cols-1 xl:grid-cols-[1fr_420px] gap-6">
    <!-- LEFT: LIVE HISTORY TABLE -->
    <div class="rounded-3xl border border-white/10 bg-[#0A1F33] shadow-xl overflow-hidden">
      <div class="p-5 md:p-6 flex items-center justify-between gap-4 flex-wrap">
        <div>
          <div class="text-sm text-white/60 uppercase tracking-wider">Live History</div>
          <div class="text-xs text-white/50 mt-1">Clear time, cover, artist, title ‚Äî tap üëç to vote.</div>
        </div>

        <a
          href="/"
          class="text-xs text-cyan-200 hover:text-cyan-100 transition border border-white/10 bg-white/5 px-3 py-1.5 rounded-xl"
        >
          Back to home ‚Üí
        </a>
      </div>

      <div class="border-t border-white/10">
        <!-- header row -->
        <div class="hidden md:grid grid-cols-[90px_72px_1fr_140px] gap-3 px-5 md:px-6 py-3 text-xs text-white/45 uppercase tracking-wider">
          <div>Time</div>
          <div>Cover</div>
          <div>Track</div>
          <div class="text-right">Vote</div>
        </div>

        <div id="historyTable" class="divide-y divide-white/5"></div>

        <div id="historyEmpty" class="p-5 md:p-6 text-white/55 text-sm hidden">
          Start the player to load the history.
        </div>
      </div>
    </div>

    <!-- RIGHT: CHARTS SIDEBAR -->
    <aside class="space-y-6">
      <!-- Top this week -->
      <div class="rounded-3xl border border-white/10 bg-[#0A1F33] p-5 md:p-6 shadow-xl">
        <div class="flex items-start justify-between gap-4 mb-4">
          <div class="min-w-0">
            <div class="text-sm text-white/60 uppercase tracking-wider">Top This Week</div>
            <div class="text-xs text-white/50 mt-1">
              Community votes ‚Ä¢ updates in real time
            </div>
          </div>

          <div class="text-xs text-white/70 border border-white/10 bg-white/5 px-3 py-1.5 rounded-xl flex-none">
            <span id="topThisWeekLabel">‚Äî</span>
          </div>
        </div>

        <ol id="topChartThisWeek" class="space-y-3"></ol>

        <div id="topThisWeekEmpty" class="text-white/55 text-sm hidden">
          No votes yet ‚Äî be the first üôÇ
        </div>
      </div>

      <!-- Top last week -->
      <div class="rounded-3xl border border-white/10 bg-[#0A1F33] p-5 md:p-6 shadow-xl">
        <div class="flex items-start justify-between gap-4 mb-4">
          <div class="min-w-0">
            <div class="text-sm text-white/60 uppercase tracking-wider">Top Last Week</div>
            <div class="text-xs text-white/50 mt-1">
              The previous week‚Äôs Top 5
            </div>
          </div>

          <div class="text-xs text-white/70 border border-white/10 bg-white/5 px-3 py-1.5 rounded-xl flex-none">
            <span id="topLastWeekLabel">‚Äî</span>
          </div>
        </div>

        <ol id="topChartLastWeek" class="space-y-3"></ol>

        <div id="topLastWeekEmpty" class="text-white/55 text-sm hidden">
          Not enough data yet.
        </div>
      </div>

      <!-- Small ‚Äúhow it works‚Äù -->
      <div class="rounded-3xl border border-white/10 bg-[#0A1F33] p-5 md:p-6 shadow-xl">
        <div class="text-sm text-white/60 uppercase tracking-wider">How it works</div>
        <ul class="mt-3 space-y-2 text-sm text-white/70">
          <li>‚Ä¢ 1 vote per track / 24h (per device + server checks)</li>
          <li>‚Ä¢ Covers: Directus upload ‚Üí iTunes fallback ‚Üí ABF logo</li>
          <li>‚Ä¢ Clean titles: removes common suffixes like ‚Äú(Radio Edit)‚Äù</li>
        </ul>
        <a
          href="/music"
          class="inline-flex mt-4 items-center justify-center w-full bg-gradient-to-r from-[#145C8F] to-[#2FC2FF]
                 px-5 py-3 rounded-xl font-semibold shadow-lg shadow-cyan-500/25 hover:scale-[1.01] transition"
        >
          Vote &amp; charts ‚Üí
        </a>
      </div>
    </aside>
  </section>

  <style>
    .tabular-nums { font-variant-numeric: tabular-nums; }
  </style>

  <script is:inline data-astro-rerun>
  (() => {
    const HISTORY_KEY = "abf_history"; // legacy fallback (read-only)
    const DAY = 24 * 60 * 60 * 1000;

    function isMusicRoute(){ return window.location.pathname === "/music"; }
    function nowTs(){ return Date.now(); }

    // ===== ISO WEEK =====
    function getISOWeekId(d = new Date()){
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = date.getUTCDay() || 7;
      date.setUTCDate(date.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
      return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2, "0")}`;
    }
    function getPrevWeekId(){
      const d = new Date();
      d.setDate(d.getDate() - 7);
      return getISOWeekId(d);
    }
    function weekLabel(w){ return String(w || "").replace("-W"," W"); }

    // ===== Safe dash normalization + split (Jean-Pierre safe) =====
    function normalizeDashes(s){
      return String(s || "")
        .replace(/\s+‚Äî\s+/g, " - ")
        .replace(/\s+‚Äì\s+/g, " - ")
        .replace(/\s+-\s+/g, " - ")
        .trim();
    }
    function splitTrack(entry){
      const s = normalizeDashes(String(entry || "").trim().replace(/^undefined\s*-\s*/i, ""));
      const idx = s.indexOf(" - ");
      if (idx === -1) return { artist: s, title: "" };
      return { artist: s.slice(0, idx).trim(), title: s.slice(idx + 3).trim() };
    }

    // ===== Block voting for ABF CLUB shows =====
    function isBlockedShow(artist){
      return /^abf\s*club\b/i.test(String(artist || "").trim());
    }
    function blockedVoteMsg(){
      alert("Voting is disabled for ABF CLUB shows. Please vote for tracks only üôÇ");
    }

    // ===== Keys =====
    function normKey(artist, title){
      return (String(artist || "") + " - " + String(title || ""))
        .toLowerCase()
        .replace(/\u00A0/g, " ")
        .replace(/\s+/g, " ")
        .replace(/[‚Äú‚Äù"']/g, "")
        .trim();
    }
    function rawKey(artist, title){
      const a = String(artist || "").trim();
      const t = String(title || "").trim();
      return `${a} - ${t}`.trim();
    }

    function esc(s){
      return String(s || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    function fmtTime(ts){
      if (!ts) return "--:--";
      const d = new Date(ts);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${hh}:${mm}`;
    }

    // ===== Formatting rules =====
    function upperArtist(s){ return String(s || "‚Äî").trim().toUpperCase(); }
    function titleCaseEN(input){
      const s = String(input || "").trim();
      if (!s) return "‚Äî";
      const lowerWords = new Set([
        "a","an","the","and","but","or","nor","for","so","yet",
        "as","at","by","for","from","in","into","near","of","on","onto","over","per","to","up","via","with","within","without"
      ]);
      const parts = s.split(/(\s+)/);
      return parts.map((chunk, idx) => {
        if (/^\s+$/.test(chunk)) return chunk;
        const word = chunk;
        if (word === word.toUpperCase() && /[A-Z]/.test(word) && word.length <= 6) return word;
        const hyParts = word.split("-");
        const rebuilt = hyParts.map((w, hIdx) => {
          const cleaned = w.replace(/[^\p{L}\p{N}'‚Äô]/gu, "");
          const lower = cleaned.toLowerCase();
          const isFirst = idx === 0 && hIdx === 0;
          const isLast = idx === parts.length - 1 && hIdx === hyParts.length - 1;
          if (!cleaned) return w;
          if (!isFirst && !isLast && lowerWords.has(lower)) return w.replace(cleaned, lower);
          const cap = lower.charAt(0).toUpperCase() + lower.slice(1);
          return w.replace(cleaned, cap);
        });
        return rebuilt.join("-");
      }).join("");
    }

    // ===== Clean title for DISPLAY ONLY (removes suffixes like (Radio Edit), (Extended Mix), etc.) =====
    function cleanTitleForDisplay(title){
      let t = String(title || "").trim();
      if (!t) return "";

      const killWords =
        "(?:original|extended|radio|club|dub|edit|mix|version|remix|rework|bootleg|vip|instrumental|acapella|a cappella|mono|stereo|clean|explicit|single|album|live|demo)";

      for (let i = 0; i < 6; i++){
        const before = t;

        // (Extended Mix) / [Radio Edit] at end
        t = t.replace(
          new RegExp(`\\s*[\\(\\[][^\\)\\]]*?\\b${killWords}\\b[^\\)\\]]*[\\)\\]]\\s*$`, "i"),
          ""
        );

        // "- Radio Edit" / "‚Äì Extended Mix" / "‚Äî Original Mix" at end
        t = t.replace(new RegExp(`\\s*(?:-|‚Äì|‚Äî)\\s*${killWords}\\b.*$`, "i"), "");

        t = t.replace(/\s{2,}/g, " ").trim();
        if (t === before) break;
      }

      return t;
    }
    function cleanArtistForDisplay(artist){
      return String(artist || "").replace(/\s{2,}/g, " ").trim();
    }

    // ===== History fallback (local) ‚Äî read-only =====
    function loadHistory(){
      let raw = [];
      try{ raw = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]"); }
      catch{ raw = []; }
      return (raw || []).map((x) => {
        if (typeof x === "string") return { t: x, ts: 0, cover_url: "" };
        if (x && typeof x === "object" && typeof x.t === "string") {
          return { t: x.t, ts: Number(x.ts) || 0, cover_url: String(x.cover_url || "") };
        }
        return null;
      }).filter(Boolean);
    }

    // ===== Server nowplaying (expects cover_url in now + history) =====
    async function fetchServerNowPlaying(limit = 12){
      try{
        const res = await fetch(`/api/nowplaying?limit=${limit}`, { cache: "no-store" });
        const data = await res.json().catch(()=> ({}));
        if (!data?.ok) return [];

        const out = [];

        // now
        if (data?.now){
          const rawNow = String(data?.now?.raw || "").trim();
          const a = String(data?.now?.artist || "").trim();
          const t = String(data?.now?.title || "").trim();
          const raw = rawNow || (a || t ? `${a} - ${t}`.trim() : "");
          if (raw){
            out.push({
              t: raw,
              ts: Number(data?.now?.played_at_ms) ||
                  (data?.now?.played_at ? new Date(data.now.played_at).getTime() : Date.now()),
              cover_url: String(data?.now?.cover_url || "")
            });
          }
        }

        // history
        if (Array.isArray(data?.history)){
          for (const row of data.history){
            const raw = String(row?.raw || `${row?.artist || ""} - ${row?.title || ""}`.trim() || "").trim();
            if (!raw) continue;
            out.push({
              t: raw,
              ts: Number(row?.played_at_ms) ||
                  (row?.played_at ? new Date(row.played_at).getTime() : 0),
              cover_url: String(row?.cover_url || "")
            });
          }
        }

        // dedupe
        const seen = new Set();
        const deduped = [];
        for (const item of out){
          const k = String(item.t || "").toLowerCase();
          if (!k || seen.has(k)) continue;
          seen.add(k);
          deduped.push(item);
        }

        return deduped.slice(0, limit);
      }catch{
        return [];
      }
    }

    function setCover(url){
      const img = document.getElementById("musicCover");
      if (!img) return;
      const u = String(url || "").trim();
      if (u){
        img.src = u;
        img.classList.remove("hidden");
      } else {
        img.removeAttribute("src");
        img.classList.add("hidden");
      }
    }

    function setCoverSourceBadge(coverUrl){
      const el = document.getElementById("musicCoverSource");
      if (!el) return;
      const u = String(coverUrl || "").trim();
      if (!u){
        el.textContent = "No cover";
        el.classList.remove("hidden");
        return;
      }
      // Heuristic: Directus assets usually contain "/assets/"
      const isDirectus = /\/assets\//i.test(u);
      el.textContent = isDirectus ? "Directus cover" : "iTunes cover";
      el.classList.remove("hidden");
    }

    // Helper cover HTML
    function coverHtmlByUrl(url, sizeClass = "w-12 h-12 rounded-xl") {
      const u = String(url || "").trim();
      return `
        <div class="abfCover ${sizeClass} border border-white/10 overflow-hidden flex-none">
          <img src="${u ? esc(u) : ""}" alt="" class="${u ? "" : "hidden"}" loading="lazy" decoding="async" />
          <div class="abfCoverFallback">
            <img src="/logo-abf.png" alt="ABF" loading="lazy" decoding="async" />
          </div>
        </div>
      `;
    }

    // ===== Votes API (Top list) with caching =====
    const VOTES_TTL_MS = 10_000; // 10s
    function votesCacheKey(week){ return `votes:${week}`; }

    async function apiGetTop(week){
      const k = votesCacheKey(week);
      window.__abfVotesCache = window.__abfVotesCache || {};
      const c = window.__abfVotesCache[k];
      const now = nowTs();
      if (c && now < c.exp) return c.top || [];

      try {
        const res = await fetch(`/api/vote?week=${encodeURIComponent(week)}`, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        const top = Array.isArray(data?.top) ? data.top : [];
        window.__abfVotesCache[k] = { exp: now + VOTES_TTL_MS, top };
        return top;
      } catch {
        return [];
      }
    }

    // Session UX anti-spam (24h) ‚Äî uses NORM key
    function markSessionVoted(norm){
      window.__abfVotedSession = window.__abfVotedSession || {};
      window.__abfVotedSession[norm] = nowTs();
    }
    function sessionAlreadyVoted(norm){
      const m = window.__abfVotedSession || {};
      const last = m[norm] || 0;
      return (nowTs() - last) < DAY;
    }

    async function apiVote(trackKeyRaw, artist = "", title = ""){
      const week = getISOWeekId();

      const res = await fetch("/api/vote", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ week, track_key: trackKeyRaw, artist, title }),
      });

      const data = await res.json().catch(() => ({}));

      if (!res.ok || data?.ok === false){
        return {
          ok: false,
          status: res.status,
          error: data?.error || `HTTP ${res.status}`,
          reason: data?.reason || "",
        };
      }

      return { ok: true, status: res.status, week: data?.week || week, count: data?.count };
    }

    function voteErrorToast(r){
      if (r?.status === 429){
        alert("You already voted today. Come back in 24h üôÇ");
        return;
      }
      if (r?.status === 409 || r?.reason === "cooldown"){
        alert("You already voted for this track. Come back in 24h üôÇ");
        return;
      }
      alert(`Vote failed: ${r?.error || "Unknown error"}`);
    }

    // Build vote maps from Top list
    function buildVoteMaps(top){
      const votesByRaw = {};   // raw track_key -> count
      const votesByNorm = {};  // normKey(artist,title) -> count
      const coverByRaw = {};   // raw track_key -> cover_url
      for (const row of (top || [])){
        const tk = String(row?.track_key || "").trim();
        if (!tk) continue;
        const c = Number(row?.count || 0) || 0;
        votesByRaw[tk] = c;

        const a = String(row?.artist || "").trim();
        const t = String(row?.title || "").trim();
        const nk = normKey(a, t);
        if (nk) votesByNorm[nk] = Math.max(Number(votesByNorm[nk] || 0), c);

        const cu = String(row?.cover_url || "").trim();
        if (cu) coverByRaw[tk] = cu;
      }
      return { votesByRaw, votesByNorm, coverByRaw };
    }

    // Dedup top entries by normalized key, keep highest count
    function dedupeTopRows(top){
      const best = new Map(); // norm -> row
      for (const row of (top || [])){
        const a = String(row?.artist || "").trim();
        const t = String(row?.title || "").trim();
        if (!a || !t) continue;
        if (isBlockedShow(a)) continue;

        const nk = normKey(a, t);
        const c = Number(row?.count || 0) || 0;
        const prev = best.get(nk);
        if (!prev || c > (Number(prev.count || 0) || 0)) best.set(nk, row);
      }
      return Array.from(best.values()).sort((x,y) => (Number(y?.count||0)||0) - (Number(x?.count||0)||0));
    }

    // ===== Render =====
    async function renderMusicPortal(){
      if (!isMusicRoute()) return;

      const weekThis = getISOWeekId();
      const weekPrev = getPrevWeekId();

      const weekEl = document.getElementById("musicWeekId");
      const updEl = document.getElementById("musicUpdatedAt");
      const topThisLabel = document.getElementById("topThisWeekLabel");
      const topPrevLabel = document.getElementById("topLastWeekLabel");

      if (weekEl) weekEl.textContent = weekLabel(weekThis);
      if (topThisLabel) topThisLabel.textContent = weekLabel(weekThis);
      if (topPrevLabel) topPrevLabel.textContent = weekLabel(weekPrev);
      if (updEl) updEl.textContent = fmtTime(Date.now());

      // Elements (Now)
      const artistEl = document.getElementById("musicArtist");
      const titleEl = document.getElementById("musicTitle");
      const timeEl = document.getElementById("musicTime");
      const nowVoteBtn = document.getElementById("nowVoteBtn");
      const nowVoteCount = document.getElementById("nowVoteCount");

      // Elements (History)
      const tableEl = document.getElementById("historyTable");
      const emptyEl = document.getElementById("historyEmpty");

      // Charts
      const chartThis = document.getElementById("topChartThisWeek");
      const chartPrev = document.getElementById("topChartLastWeek");
      const emptyThis = document.getElementById("topThisWeekEmpty");
      const emptyPrev = document.getElementById("topLastWeekEmpty");

      if (!artistEl || !titleEl || !tableEl || !chartThis || !chartPrev) return;

      // Fetch data
      let history = await fetchServerNowPlaying(18);
      if (!history.length) history = loadHistory();

      const topThisRaw = await apiGetTop(weekThis);
      const topPrevRaw = await apiGetTop(weekPrev);

      // Build maps for votes/covers (this week only, used by vote buttons)
      const { votesByRaw, votesByNorm, coverByRaw } = buildVoteMaps(topThisRaw);

      // Cover map from nowplaying payload (Directus/iTunes already resolved server-side)
      const coverByNormFromHistory = {};
      for (const entry of history){
        const t = splitTrack(entry.t);
        const nk = normKey(t.artist, t.title);
        const u = String(entry.cover_url || "").trim();
        if (nk && u) coverByNormFromHistory[nk] = u;
      }

      function bestCoverFor(artist, title, rawTrackKeyMaybe){
        const nk = normKey(artist, title);
        const raw = String(rawTrackKeyMaybe || "").trim();
        return coverByRaw[raw] || coverByNormFromHistory[nk] || "";
      }

      // If no history
      if (!history.length){
        if (emptyEl) emptyEl.classList.remove("hidden");
        tableEl.innerHTML = "";
        artistEl.textContent = "‚Äî";
        titleEl.textContent = "‚Äî";
        if (timeEl) timeEl.textContent = "--:--";
        setCover("");
        setCoverSourceBadge("");
        if (nowVoteBtn) nowVoteBtn.style.display = "none";

        // Charts still render
      } else {
        if (emptyEl) emptyEl.classList.add("hidden");

        // NOW PLAYING
        const currentEntry = history[0];
        const current = splitTrack(currentEntry.t);

        const dispArtist = upperArtist(cleanArtistForDisplay(current.artist) || "‚Äî");
        const dispTitle  = titleCaseEN(cleanTitleForDisplay(current.title) || "‚Äî");

        artistEl.textContent = dispArtist;
        titleEl.textContent = dispTitle;
        if (timeEl) timeEl.textContent = fmtTime(currentEntry.ts);

        const nowCover = String(currentEntry.cover_url || "").trim() || bestCoverFor(current.artist, current.title, rawKey(current.artist, current.title));
        setCover(nowCover);
        setCoverSourceBadge(nowCover);

        const currentKeyNorm = normKey(current.artist, current.title);
        const currentKeyRaw  = rawKey(current.artist, current.title);

        const currentCount = (votesByRaw[currentKeyRaw] != null)
          ? votesByRaw[currentKeyRaw]
          : (votesByNorm[currentKeyNorm] || 0);

        if (nowVoteCount) nowVoteCount.textContent = String(currentCount);

        const blockedNow = isBlockedShow(current.artist);

        if (nowVoteBtn){
          nowVoteBtn.style.display = "flex";

          if (blockedNow){
            nowVoteBtn.style.opacity = "0.45";
            nowVoteBtn.style.cursor = "not-allowed";
            nowVoteBtn.onclick = () => blockedVoteMsg();
          } else {
            const alreadySession = sessionAlreadyVoted(currentKeyNorm);
            nowVoteBtn.style.opacity = alreadySession ? "0.55" : "1";
            nowVoteBtn.style.cursor = alreadySession ? "not-allowed" : "pointer";

            nowVoteBtn.onclick = async () => {
              if (sessionAlreadyVoted(currentKeyNorm)){
                alert("You already voted for this track. Come back in 24h üôÇ");
                return;
              }

              nowVoteBtn.style.opacity = "0.7";
              nowVoteBtn.style.cursor = "wait";

              const r = await apiVote(currentKeyRaw, current.artist, current.title);

              if (!r.ok){
                nowVoteBtn.style.opacity = "1";
                nowVoteBtn.style.cursor = "pointer";
                voteErrorToast(r);
                return;
              }

              markSessionVoted(currentKeyNorm);

              const newCount = (r.count != null) ? r.count : (Number(currentCount || 0) + 1);
              if (nowVoteCount) nowVoteCount.textContent = String(newCount);

              // invalidate cache for this week
              const kk = votesCacheKey(weekThis);
              if (window.__abfVotesCache?.[kk]) window.__abfVotesCache[kk].exp = 0;

              nowVoteBtn.style.opacity = "0.55";
              nowVoteBtn.style.cursor = "not-allowed";

              // re-render
              renderMusicPortal();
            };
          }
        }

        // HISTORY TABLE (includes NOW row + last played)
        const rows = history.slice(0, 18);
        tableEl.innerHTML = rows.map((entry, idx) => {
          const t = splitTrack(entry.t);
          const aRaw = String(t.artist || "").trim();
          const tiRaw = String(t.title || "").trim();

          const aDisp = upperArtist(cleanArtistForDisplay(aRaw) || "‚Äî");
          const tDisp = titleCaseEN(cleanTitleForDisplay(tiRaw) || "‚Äî");

          const time = fmtTime(entry.ts);

          const kNorm = normKey(aRaw, tiRaw);
          const kRaw  = rawKey(aRaw, tiRaw);

          const blocked = isBlockedShow(aRaw);
          const alreadySession = sessionAlreadyVoted(kNorm);

          const count = (votesByRaw[kRaw] != null) ? votesByRaw[kRaw] : (votesByNorm[kNorm] || 0);

          const coverUrl = String(entry.cover_url || "").trim() || bestCoverFor(aRaw, tiRaw, kRaw);

          const isNow = idx === 0;

          return `
            <div class="grid grid-cols-1 md:grid-cols-[90px_72px_1fr_140px] gap-3 px-5 md:px-6 py-4 ${isNow ? "bg-white/[0.06]" : "bg-white/[0.02] hover:bg-white/[0.04]"} transition">
              <div class="flex items-center gap-2">
                ${isNow ? `
                  <span class="inline-flex items-center gap-2 text-xs px-2.5 py-1 rounded-full bg-cyan-500/10 border border-cyan-400/20 text-cyan-200 font-semibold tracking-wider">
                    <span class="w-2 h-2 rounded-full bg-cyan-400 animate-pulse"></span>
                    LIVE
                  </span>
                ` : `
                  <span class="text-sm text-white/70 tabular-nums">${time}</span>
                `}
              </div>

              <div class="flex items-center">
                ${coverHtmlByUrl(coverUrl, "w-14 h-14 rounded-2xl")}
              </div>

              <div class="min-w-0 flex items-center">
                <div class="min-w-0">
                  <div class="font-semibold text-white truncate">${esc(aDisp)}</div>
                  <div class="text-white/65 text-sm truncate">${esc(tDisp)}</div>
                </div>
              </div>

              <div class="flex items-center justify-end">
                <button
                  class="voteBtn flex-none bg-white/5 hover:bg-white/10 border border-white/10 rounded-2xl px-3 py-2 text-sm text-white/85 transition flex items-center gap-2"
                  data-norm="${esc(kNorm)}"
                  data-raw="${esc(kRaw)}"
                  data-artist="${esc(aRaw)}"
                  data-title="${esc(tiRaw)}"
                  data-blocked="${blocked ? "1" : "0"}"
                  ${blocked ? 'style="opacity:0.45;cursor:not-allowed;"' : (alreadySession ? 'style="opacity:0.55;cursor:not-allowed;"' : '')}
                  type="button"
                  aria-label="Vote"
                  title="${blocked ? "Voting disabled for ABF CLUB" : (alreadySession ? "Already voted today" : "Vote")}"
                >
                  üëç <span class="voteCount tabular-nums">${count}</span>
                </button>
              </div>
            </div>
          `;
        }).join("");

        // Wire vote buttons
        tableEl.querySelectorAll(".voteBtn").forEach((btn) => {
          const kNorm = btn.dataset.norm || "";
          const kRaw  = btn.dataset.raw || "";
          const a     = btn.dataset.artist || "";
          const t     = btn.dataset.title || "";
          const blocked = btn.dataset.blocked === "1";

          if (blocked){
            btn.onclick = () => blockedVoteMsg();
            return;
          }

          if (sessionAlreadyVoted(kNorm)){
            btn.onclick = () => alert("You already voted for this track. Come back in 24h üôÇ");
            return;
          }

          btn.onclick = async () => {
            if (sessionAlreadyVoted(kNorm)){
              alert("You already voted for this track. Come back in 24h üôÇ");
              return;
            }

            btn.style.opacity = "0.7";
            btn.style.cursor = "wait";

            const r = await apiVote(kRaw || rawKey(a, t), a, t);

            if (!r.ok){
              btn.style.opacity = "1";
              btn.style.cursor = "pointer";
              voteErrorToast(r);
              return;
            }

            markSessionVoted(kNorm);

            // invalidate this week cache then rerender
            const kk = votesCacheKey(weekThis);
            if (window.__abfVotesCache?.[kk]) window.__abfVotesCache[kk].exp = 0;

            renderMusicPortal();
          };
        });
      }

      // ===== Charts rendering =====
      function renderChart(listEl, emptyEl, topList, limit){
        const deduped = dedupeTopRows(topList).filter(x => Number(x?.count||0) > 0).slice(0, limit);

        if (!deduped.length){
          if (emptyEl) emptyEl.classList.remove("hidden");
          listEl.innerHTML = "";
          return;
        }
        if (emptyEl) emptyEl.classList.add("hidden");

        const max = Math.max(...deduped.map(r => Number(r?.count||0) || 0), 1);

        listEl.innerHTML = deduped.map((row, i) => {
          const aRaw = String(row?.artist || "").trim();
          const tRaw = String(row?.title || "").trim();

          const a = upperArtist(cleanArtistForDisplay(aRaw) || "‚Äî");
          const tt = titleCaseEN(cleanTitleForDisplay(tRaw) || "‚Äî");

          const count = Number(row?.count || 0) || 0;
          const pct = Math.round((count / max) * 100);

          const coverUrl =
            String(row?.cover_url || "").trim() ||
            bestCoverFor(aRaw, tRaw, String(row?.track_key || "").trim()) ||
            "";

          const rankBadge =
            i === 0 ? "bg-white/10 border-white/15" :
            i === 1 ? "bg-white/8 border-white/15" :
            i === 2 ? "bg-white/6 border-white/15" :
            "bg-white/5 border-white/10";

          return `
            <li class="group flex items-center gap-3 p-3 rounded-2xl border border-white/5 bg-white/[0.03] hover:bg-white/[0.05] transition">
              <div class="flex-none w-9 h-9 rounded-2xl border ${rankBadge} flex items-center justify-center text-sm font-semibold text-white/90 tabular-nums">
                ${i+1}
              </div>
              ${coverHtmlByUrl(coverUrl, "w-12 h-12 rounded-2xl")}
              <div class="min-w-0 flex-1">
                <div class="font-semibold text-white truncate">${esc(a)}</div>
                <div class="text-white/65 text-xs truncate">${esc(tt)}</div>
                <div class="mt-2 h-2 rounded-full bg-white/5 border border-white/10 overflow-hidden">
                  <div class="h-full bg-gradient-to-r from-[#145C8F] to-[#2FC2FF]" style="width:${pct}%"></div>
                </div>
              </div>
              <div class="flex-none text-sm text-white/90 font-semibold tabular-nums">
                ${count}
              </div>
            </li>
          `;
        }).join("");
      }

      renderChart(chartThis, emptyThis, topThisRaw, 10);
      renderChart(chartPrev, emptyPrev, topPrevRaw, 5);
    }

    function startMusicTimer(){
      if (window.__abfMusicTimer) clearInterval(window.__abfMusicTimer);
      window.__abfMusicTimer = setInterval(renderMusicPortal, 8000);
    }

    function initMusicPage(){
      if (!isMusicRoute()) return;
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          renderMusicPortal();
          startMusicTimer();
        });
      });
    }

    initMusicPage();

    if (!window.__abfMusicListeners){
      document.addEventListener("astro:page-load", initMusicPage);
      document.addEventListener("astro:after-swap", initMusicPage);

      window.addEventListener("abf:history-updated", () => {
        if (!isMusicRoute()) return;
        renderMusicPortal();
      });

      document.addEventListener("astro:before-swap", () => {
        if (window.__abfMusicTimer) clearInterval(window.__abfMusicTimer);
      });

      window.__abfMusicListeners = true;
    }
  })();
  </script>
</Base>
</Base>
