---
import Base from "../layouts/Base.astro";
export const prerender = false;
---

<Base
  title="Music ‚Äî RadioABF"
  description="Live history, covers and weekly community votes on RadioABF."
  canonical="/music"
  image="/og-image.jpg"
>
  <!-- HERO -->
  <section class="relative overflow-hidden rounded-3xl border border-white/10 bg-[#0A1F33] p-6 md:p-8 shadow-2xl">
    <div class="pointer-events-none absolute -top-40 -left-40 w-[600px] h-[600px] bg-cyan-500/20 rounded-full blur-[120px]"></div>
    <div class="pointer-events-none absolute -bottom-40 -right-40 w-[600px] h-[600px] bg-blue-600/20 rounded-full blur-[120px]"></div>

    <div class="relative z-10">
      <div class="flex items-center gap-3 text-sm tracking-widest text-white/60 uppercase mb-3">
        <span class="w-2 h-2 bg-cyan-400 rounded-full animate-pulse"></span>
        Music portal
      </div>

      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
        <div class="min-w-0">
          <h1 class="text-3xl md:text-4xl font-extrabold leading-tight">
            Live titles, covers & weekly community charts
          </h1>
          <p class="mt-3 text-white/65 max-w-2xl">
            Directus-first cover system (manual uploads) with iTunes fallback ‚Äî clean metadata and a premium portal view.
          </p>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <span class="text-xs text-white/70 border border-white/10 bg-white/5 px-3 py-2 rounded-xl">
            Vote once / 24h
          </span>
          <span class="text-xs text-white/70 border border-white/10 bg-white/5 px-3 py-2 rounded-xl">
            Covers: Directus ‚Üí iTunes fallback
          </span>
          <span class="text-xs text-white/70 border border-white/10 bg-white/5 px-3 py-2 rounded-xl">
            Updates every 8s
          </span>
        </div>
      </div>
    </div>
  </section>

  <!-- PORTAL GRID -->
  <section class="mt-8 grid grid-cols-1 xl:grid-cols-[1.35fr_0.65fr] gap-6 items-start">
    <!-- LEFT: LIVE HISTORY -->
    <div class="rounded-3xl border border-white/10 bg-[#0A1F33] overflow-hidden shadow-xl">
      <div class="p-5 md:p-6 border-b border-white/10">
        <div class="flex items-center justify-between gap-4 flex-wrap">
          <div class="min-w-0">
            <div class="text-sm text-white/60 uppercase tracking-wider">Live history</div>
            <div class="text-xs text-white/50 mt-1">Now playing + last tracks (clean titles)</div>
          </div>

          <div class="flex items-center gap-2">
            <!-- ‚úÖ LIVE badge becomes RED -->
            <div
              id="npLiveBadge"
              class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-red-500/15 border border-red-500/25 text-red-200 text-xs font-semibold tracking-wider"
            >
              <span class="w-2 h-2 rounded-full bg-red-400 animate-pulse"></span>
              LIVE
            </div>

            <!-- ‚úÖ time badge becomes BLUE -->
            <div
              id="npTimeBadge"
              class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-cyan-500/10 border border-cyan-400/20 text-cyan-200 text-xs font-semibold tabular-nums"
              aria-label="Now playing time"
            >
              <span class="w-2 h-2 rounded-full bg-cyan-300/80"></span>
              <span id="musicTime">--:--</span>
            </div>
          </div>
        </div>

        <!-- NOW PLAYING CARD -->
        <div class="mt-5 rounded-3xl border border-white/10 bg-white/5 overflow-hidden">
          <div class="p-4 md:p-5 flex flex-col sm:flex-row gap-5 items-center sm:items-stretch">
            <div class="flex-none">
              <div
                id="musicCoverWrapper"
                class="abfCover w-24 h-24 md:w-28 md:h-28 rounded-2xl border border-white/10 overflow-hidden shadow-xl bg-black/20"
              >
                <img id="musicCover" class="hidden w-full h-full object-cover" alt="Current cover" />
                <div class="abfCoverFallback w-full h-full grid place-items-center">
                  <img src="/logo-abf.png" alt="ABF" loading="lazy" decoding="async" class="w-16 h-16 opacity-90" />
                </div>
              </div>
            </div>

            <div class="min-w-0 flex-1">
              <div id="musicArtist" class="text-xl md:text-2xl font-extrabold text-white truncate leading-tight">‚Äî</div>
              <div id="musicTitle" class="mt-1 text-white/70 text-base md:text-lg truncate">‚Äî</div>

              <div class="mt-4 flex flex-wrap items-center gap-2">
                <span class="text-xs text-white/70 border border-white/10 bg-white/5 px-3 py-1.5 rounded-xl">
                  Auto-cleaned titles
                </span>
                <span class="text-xs text-white/70 border border-white/10 bg-white/5 px-3 py-1.5 rounded-xl">
                  Hyphen-safe split
                </span>
              </div>
            </div>

            <button
              id="nowVoteBtn"
              class="group w-full sm:w-auto justify-center bg-white/5 hover:bg-white/10 border border-white/10 rounded-2xl px-5 py-4 text-sm text-white/85 transition flex items-center gap-3"
              type="button"
              aria-label="Vote for now playing"
            >
              <span class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-white/5 border border-white/10 group-hover:bg-white/10 transition">
                üëç
              </span>
              <span class="flex items-baseline gap-2">
                <span class="font-semibold">Vote</span>
                <span class="text-white/60">‚Ä¢</span>
                <span class="tabular-nums font-semibold"><span id="nowVoteCount">0</span></span>
              </span>
            </button>
          </div>
        </div>
      </div>

      <!-- HISTORY TABLE -->
      <div class="p-4 md:p-6">
        <div class="flex items-center justify-between gap-4 mb-4">
          <div class="text-sm text-white/60 uppercase tracking-wider">Last played</div>
          <div class="text-xs text-white/50">Tap üëç to vote</div>
        </div>

        <div id="historyTable" class="space-y-3"></div>

        <div id="historyEmpty" class="text-white/55 text-sm hidden">
          Start the player to load the history.
        </div>
      </div>
    </div>

    <!-- RIGHT: CHARTS + EXPLAIN -->
    <aside class="space-y-6">
      <!-- THIS WEEK -->
      <div class="rounded-3xl border border-white/10 bg-[#0A1F33] overflow-hidden shadow-xl">
        <div class="p-5 border-b border-white/10 flex items-start justify-between gap-4">
          <div class="min-w-0">
            <div class="text-sm text-white/60 uppercase tracking-wider">Top this week</div>
            <div class="text-xs text-white/50 mt-1">Community votes ‚Ä¢ updates in real time</div>
          </div>
          <div class="text-xs text-white/70 border border-white/10 bg-white/5 px-3 py-1.5 rounded-xl flex-none">
            Week <span id="weekThis" class="tabular-nums">‚Äî</span>
          </div>
        </div>

        <div class="p-4 md:p-5">
          <ol id="topThisWeek" class="space-y-3"></ol>
          <div id="topThisEmpty" class="text-white/55 text-sm hidden">
            No votes yet ‚Äî be the first üôÇ
          </div>
        </div>
      </div>

      <!-- PREVIOUS WEEK TOP 5 -->
      <div class="rounded-3xl border border-white/10 bg-[#0A1F33] overflow-hidden shadow-xl">
        <div class="p-5 border-b border-white/10 flex items-start justify-between gap-4">
          <div class="min-w-0">
            <div class="text-sm text-white/60 uppercase tracking-wider">Last week</div>
            <div class="text-xs text-white/50 mt-1">Top 5 snapshot</div>
          </div>
          <div class="text-xs text-white/70 border border-white/10 bg-white/5 px-3 py-1.5 rounded-xl flex-none">
            Week <span id="weekPrev" class="tabular-nums">‚Äî</span>
          </div>
        </div>

        <div class="p-4 md:p-5">
          <ol id="topPrevWeek" class="space-y-3"></ol>
          <div id="topPrevEmpty" class="text-white/55 text-sm hidden">
            No data for last week yet.
          </div>
        </div>
      </div>

      <!-- EXPLAIN CARD (the one you want aligned to bottom) -->
      <div class="rounded-3xl border border-white/10 bg-gradient-to-br from-[#061220] via-[#0A1F33] to-[#050B14] overflow-hidden shadow-xl relative">
        <div class="pointer-events-none absolute -top-24 -right-24 w-[260px] h-[260px] bg-cyan-500/15 rounded-full blur-[90px]"></div>
        <div class="p-6 relative">
          <div class="text-xs text-white/50 uppercase tracking-wider">How it works</div>
          <div class="mt-2 font-extrabold text-lg leading-tight">Directus-first covers</div>
          <p class="mt-3 text-sm text-white/70 leading-relaxed">
            If a track has a manual cover uploaded in <span class="text-cyan-200 font-semibold">Directus ‚Üí tracks.cover_art</span>,
            it always wins.
            If not, we fallback to iTunes so the portal stays visually rich.
          </p>
          <div class="mt-4 flex flex-wrap gap-2 text-xs">
            <span class="px-3 py-1.5 rounded-xl border border-white/10 bg-white/5 text-white/80">Manual override</span>
            <span class="px-3 py-1.5 rounded-xl border border-white/10 bg-white/5 text-white/80">No bulk uploads</span>
            <span class="px-3 py-1.5 rounded-xl border border-white/10 bg-white/5 text-cyan-200">Premium look</span>
          </div>
          <div class="mt-5">
            <a
              href="/"
              class="inline-flex items-center gap-2 text-sm text-cyan-200 hover:text-cyan-100 transition"
            >
              Back to Home ‚Üí
            </a>
          </div>
        </div>
      </div>
    </aside>
  </section>

  <style>
    .tabular-nums { font-variant-numeric: tabular-nums; }
  </style>

  <script is:inline data-astro-rerun>
  (() => {
    const HISTORY_KEY = "abf_history"; // legacy fallback (read-only)
    const DAY = 24 * 60 * 60 * 1000;

    function isMusicRoute(){ return window.location.pathname === "/music"; }

    // -------------------------
    // Week helpers
    // -------------------------
    function getISOWeekId(d = new Date()){
      const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = date.getUTCDay() || 7;
      date.setUTCDate(date.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(date.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
      return `${date.getUTCFullYear()}-W${String(weekNo).padStart(2, "0")}`;
    }

    function getPrevISOWeekId(){
      // easiest: subtract 7 days and compute ISO week
      const d = new Date();
      d.setDate(d.getDate() - 7);
      return getISOWeekId(d);
    }

    function nowTs(){ return Date.now(); }

    // -------------------------
    // Text helpers
    // -------------------------
    function esc(s){
      return String(s || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;");
    }

    function fmtTime(ts){
      if (!ts) return "--:--";
      const d = new Date(ts);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${hh}:${mm}`;
    }

    // ‚úÖ Strip suffixes like (Extended Mix), (Original Mix), (Radio Edit), etc.
    // Keeps other parentheses when they look meaningful (best-effort).
    function stripTitleSuffixes(input){
      let s = String(input || "").trim();
      if (!s) return "";

      // remove bracketed suffixes that are common "versions"
      // Note: case-insensitive, handles Mix/Edit/Version/Remaster/Remix/Instrumental/Acapella/Radio/Club/Extended/Original
      const rx = /\s*[\(\[]\s*(?:original|extended|radio|club|edit|version|mix|remix|re\-mix|rework|instrumental|acapella|a\s*cappella|remaster(?:ed)?|mono|stereo)\b[^)\]]*[\)\]]\s*/gi;
      s = s.replace(rx, " ");

      // normalize spaces
      s = s.replace(/\s{2,}/g, " ").trim();
      return s;
    }

    // ‚úÖ Hyphen-safe split: only split on " - " (with spaces), so Jean-Pierre won't break
    function splitTrack(entry){
      const s = String(entry || "").trim().replace(/^undefined\s*-\s*/i, "");
      const idx = s.indexOf(" - ");
      if (idx === -1) return { artist: s.trim(), title: "" };
      return { artist: s.slice(0, idx).trim(), title: s.slice(idx + 3).trim() };
    }

    function normKey(artist, title){
      return (String(artist || "") + " - " + String(title || ""))
        .toLowerCase()
        .replace(/\u00A0/g, " ")
        .replace(/\s+/g, " ")
        .replace(/[‚Äú‚Äù"']/g, "")
        .trim();
    }

    function rawKey(artist, title){
      const a = String(artist || "").trim();
      const t = String(title || "").trim();
      return `${a} - ${t}`.trim();
    }

    // Pretty formatting (artist upper, title titlecase)
    function upperArtist(s){ return String(s || "‚Äî").trim().toUpperCase(); }

    function titleCaseEN(input){
      const s = String(input || "").trim();
      if (!s) return "‚Äî";
      const lowerWords = new Set([
        "a","an","the","and","but","or","nor","for","so","yet",
        "as","at","by","for","from","in","into","near","of","on","onto","over","per","to","up","via","with","within","without"
      ]);
      const parts = s.split(/(\s+)/);
      return parts.map((chunk, idx) => {
        if (/^\s+$/.test(chunk)) return chunk;
        const word = chunk;

        // preserve short all-caps tokens (DJ, VIP, etc.)
        if (word === word.toUpperCase() && /[A-Z]/.test(word) && word.length <= 6) return word;

        const hyParts = word.split("-");
        const rebuilt = hyParts.map((w, hIdx) => {
          const cleaned = w.replace(/[^\p{L}\p{N}'‚Äô]/gu, "");
          const lower = cleaned.toLowerCase();
          const isFirst = idx === 0 && hIdx === 0;
          const isLast = idx === parts.length - 1 && hIdx === hyParts.length - 1;
          if (!cleaned) return w;
          if (!isFirst && !isLast && lowerWords.has(lower)) return w.replace(cleaned, lower);
          const cap = lower.charAt(0).toUpperCase() + lower.slice(1);
          return w.replace(cleaned, cap);
        });
        return rebuilt.join("-");
      }).join("");
    }

    // -------------------------
    // Voting rules
    // -------------------------
    function isBlockedShow(artist){
      return /^abf\s*club\b/i.test(String(artist || "").trim());
    }
    function blockedVoteMsg(){
      alert("Voting is disabled for ABF CLUB shows. Please vote for tracks only üôÇ");
    }

    // Session anti-spam (24h, client-side UX)
    function markSessionVoted(norm){
      window.__abfVotedSession = window.__abfVotedSession || {};
      window.__abfVotedSession[norm] = nowTs();
    }
    function sessionAlreadyVoted(norm){
      const m = window.__abfVotedSession || {};
      const last = m[norm] || 0;
      return (nowTs() - last) < DAY;
    }

    // -------------------------
    // Legacy history fallback (read-only)
    // -------------------------
    function loadHistory(){
      let raw = [];
      try{ raw = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]"); }
      catch{ raw = []; }
      return (raw || []).map((x) => {
        if (typeof x === "string") return { t: x, ts: 0, cover_url: "" };
        if (x && typeof x === "object" && typeof x.t === "string") {
          return { t: x.t, ts: Number(x.ts) || 0, cover_url: String(x.cover_url || "") };
        }
        return null;
      }).filter(Boolean);
    }

    // -------------------------
    // Server nowplaying (expects cover_url in now + history)
    // -------------------------
    async function fetchServerNowPlaying(limit = 12){
      try{
        const res = await fetch(`/api/nowplaying?limit=${limit}`, { cache: "no-store" });
        const data = await res.json().catch(()=> ({}));
        if (!data?.ok) return [];

        const out = [];

        if (data?.now){
          const rawNow = String(data?.now?.raw || "").trim();
          const a = String(data?.now?.artist || "").trim();
          const t = String(data?.now?.title || "").trim();
          const raw = rawNow || (a || t ? `${a} - ${t}`.trim() : "");
          if (raw){
            out.push({
              t: raw,
              ts: Number(data?.now?.played_at_ms) ||
                  (data?.now?.played_at ? new Date(data.now.played_at).getTime() : Date.now()),
              cover_url: String(data?.now?.cover_url || "")
            });
          }
        }

        if (Array.isArray(data?.history)){
          for (const row of data.history){
            const raw = String(row?.raw || `${row?.artist || ""} - ${row?.title || ""}`.trim() || "").trim();
            if (!raw) continue;
            out.push({
              t: raw,
              ts: Number(row?.played_at_ms) ||
                  (row?.played_at ? new Date(row.played_at).getTime() : 0),
              cover_url: String(row?.cover_url || "")
            });
          }
        }

        const seen = new Set();
        const deduped = [];
        for (const item of out){
          const k = String(item.t || "").toLowerCase();
          if (!k || seen.has(k)) continue;
          seen.add(k);
          deduped.push(item);
        }

        return deduped.slice(0, limit);
      }catch{
        return [];
      }
    }

    // -------------------------
    // Covers
    // -------------------------
    function setCover(url){
      const img = document.getElementById("musicCover");
      if (!img) return;
      const u = String(url || "").trim();
      if (u){
        img.src = u;
        img.classList.remove("hidden");
      } else {
        img.removeAttribute("src");
        img.classList.add("hidden");
      }
    }

    function coverHtmlByUrl(url, sizeClass = "w-12 h-12 rounded-xl") {
      const u = String(url || "").trim();
      return `
        <div class="abfCover ${sizeClass} border border-white/10 overflow-hidden flex-none bg-black/20">
          <img src="${u ? esc(u) : ""}" alt="" class="${u ? "w-full h-full object-cover" : "hidden"}" loading="lazy" decoding="async" />
          <div class="abfCoverFallback w-full h-full grid place-items-center">
            <img src="/logo-abf.png" alt="ABF" loading="lazy" decoding="async" class="w-8 h-8 opacity-90" />
          </div>
        </div>
      `;
    }

    // -------------------------
    // ‚úÖ Dynamic history limit to match aside height (your previous request)
    // -------------------------
    function computeHistoryLimit(defaultLimit = 18){
      const isTwoCols = window.matchMedia && window.matchMedia("(min-width: 1280px)").matches;
      if (!isTwoCols) return defaultLimit;

      const aside = document.querySelector("aside");
      const table = document.getElementById("historyTable");
      if (!aside || !table) return defaultLimit;

      const asideH = aside.getBoundingClientRect().height || 0;
      if (asideH < 200) return defaultLimit;

      let rowH = 92;
      const firstRow = table.firstElementChild;
      if (firstRow){
        const h = firstRow.getBoundingClientRect().height;
        if (h && h > 40) rowH = h;
      }

      const headerAllowance = 140;
      const want = Math.ceil(Math.max(0, asideH - headerAllowance) / rowH);

      return Math.max(defaultLimit, Math.min(50, want));
    }

    // -------------------------
    // Votes API (server-side)
    // -------------------------
    const VOTES_TTL_MS = 10_000;
    function votesCacheKey(week){ return `votes:${week}`; }

    async function apiGetTopWeek(week){
      const k = votesCacheKey(week);
      window.__abfVotesCache = window.__abfVotesCache || {};
      const c = window.__abfVotesCache[k];
      const now = nowTs();
      if (c && now < c.exp) return c.payload || { top: [] };

      try{
        const res = await fetch(`/api/vote?week=${encodeURIComponent(week)}`, { cache: "no-store" });
        const data = await res.json().catch(() => ({}));
        const top = Array.isArray(data?.top) ? data.top : [];
        const payload = { top };
        window.__abfVotesCache[k] = { exp: now + VOTES_TTL_MS, payload };
        return payload;
      }catch{
        return { top: [] };
      }
    }

    async function apiVote(trackKeyRaw, artist = "", title = ""){
      const week = getISOWeekId();
      const res = await fetch("/api/vote", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ week, track_key: trackKeyRaw, artist, title }),
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data?.ok === false){
        return { ok: false, status: res.status, error: data?.error || `HTTP ${res.status}`, reason: data?.reason || "" };
      }
      return { ok: true, status: res.status, week: data?.week || week, count: data?.count };
    }

    function voteErrorToast(r){
      if (r?.status === 429){
        alert("You already voted today. Come back in 24h üôÇ");
        return;
      }
      if (r?.status === 409 || r?.reason === "cooldown"){
        alert("You already voted for this track. Come back in 24h üôÇ");
        return;
      }
      alert(`Vote failed: ${r?.error || "Unknown error"}`);
    }

    // -------------------------
    // Render helpers
    // -------------------------
    function badgeTimeBlue(text){
      return `
        <span class="inline-flex items-center gap-2 px-2.5 py-1 rounded-full bg-cyan-500/10 border border-cyan-400/20 text-cyan-200 text-[11px] font-semibold tabular-nums">
          <span class="w-2 h-2 rounded-full bg-cyan-300/80"></span>
          ${esc(text || "--:--")}
        </span>
      `;
    }

    function rowHtml({ coverUrl, artist, title, time, count, blocked, kNorm, kRaw, aRaw, tRaw }){
      return `
        <div class="flex items-center justify-between gap-3 border border-white/10 bg-white/[0.03] hover:bg-white/[0.05] transition rounded-2xl p-3">
          <div class="flex items-center gap-3 min-w-0 flex-1">
            ${coverHtmlByUrl(coverUrl, "w-12 h-12 rounded-2xl")}
            <div class="min-w-0 flex-1">
              <div class="flex items-center justify-between gap-3">
                <div class="font-extrabold text-white truncate">${esc(artist || "‚Äî")}</div>
                ${badgeTimeBlue(time)}
              </div>
              <div class="text-white/65 text-sm truncate">${esc(title || "‚Äî")}</div>
            </div>
          </div>

          <button
            class="voteBtn flex-none bg-white/5 hover:bg-white/10 border border-white/10 rounded-2xl px-3 py-2 text-sm text-white/85 transition"
            data-norm="${esc(kNorm)}"
            data-raw="${esc(kRaw)}"
            data-artist="${esc(aRaw || "")}"
            data-title="${esc(tRaw || "")}"
            data-blocked="${blocked ? "1" : "0"}"
            type="button"
            aria-label="Vote"
            title="${blocked ? "Voting disabled for ABF CLUB" : "Vote"}"
            style="${blocked ? "opacity:0.45;cursor:not-allowed;" : ""}"
          >
            üëç <span class="voteCount tabular-nums">${esc(String(count ?? 0))}</span>
          </button>
        </div>
      `;
    }

    function chartRowHtml(rank, coverUrl, artist, title, count, max){
      const pct = Math.round((Number(count) / Math.max(1, Number(max))) * 100);
      const rankBadge =
        rank === 1 ? "bg-white/10 border-white/15" :
        rank === 2 ? "bg-white/8 border-white/15" :
        rank === 3 ? "bg-white/6 border-white/15" :
        "bg-white/5 border-white/10";

      return `
        <li class="group flex items-center gap-4 p-4 rounded-3xl border border-white/10 bg-white/[0.03] hover:bg-white/[0.05] transition">
          <div class="flex-none w-10 h-10 rounded-2xl border ${rankBadge} flex items-center justify-center text-sm font-extrabold text-white/90 tabular-nums">
            ${rank}
          </div>
          ${coverHtmlByUrl(coverUrl, "w-12 h-12 rounded-2xl")}
          <div class="min-w-0 flex-1">
            <div class="flex items-start gap-3">
              <div class="min-w-0">
                <div class="font-extrabold text-white truncate">${esc(artist)}</div>
                <div class="text-white/65 text-sm truncate">${esc(title)}</div>
              </div>
              <div class="ml-auto flex-none text-sm text-white/90 font-extrabold tabular-nums">
                ${esc(String(count))} <span class="text-white/50 font-normal">votes</span>
              </div>
            </div>
            <div class="mt-3 h-2 rounded-full bg-white/5 border border-white/10 overflow-hidden">
              <div class="h-full bg-gradient-to-r from-[#145C8F] to-[#2FC2FF]" style="width:${pct}%"></div>
            </div>
          </div>
        </li>
      `;
    }

    // -------------------------
    // Main render
    // -------------------------
    async function renderMusicPortal(){
      if (!isMusicRoute()) return;

      const artistEl = document.getElementById("musicArtist");
      const titleEl  = document.getElementById("musicTitle");
      const timeEl   = document.getElementById("musicTime");
      const histEl   = document.getElementById("historyTable");
      const histEmpty= document.getElementById("historyEmpty");
      const nowVoteBtn   = document.getElementById("nowVoteBtn");
      const nowVoteCount = document.getElementById("nowVoteCount");

      const weekThisEl = document.getElementById("weekThis");
      const weekPrevEl = document.getElementById("weekPrev");

      const topThisEl = document.getElementById("topThisWeek");
      const topPrevEl = document.getElementById("topPrevWeek");
      const topThisEmpty = document.getElementById("topThisEmpty");
      const topPrevEmpty = document.getElementById("topPrevEmpty");

      if (weekThisEl) weekThisEl.textContent = getISOWeekId().replace("-W"," W");
      if (weekPrevEl) weekPrevEl.textContent = getPrevISOWeekId().replace("-W"," W");

      if (!artistEl || !titleEl || !histEl || !topThisEl || !topPrevEl) return;

      // Fetch enough history (we'll slice dynamically)
      let history = await fetchServerNowPlaying(50);
      if (!history.length) history = loadHistory();

      if (!history.length){
        artistEl.textContent = "‚Äî";
        titleEl.textContent = "‚Äî";
        if (timeEl) timeEl.textContent = "--:--";
        setCover("");
        if (histEmpty) histEmpty.classList.remove("hidden");
        histEl.innerHTML = "";
        if (nowVoteBtn) nowVoteBtn.style.display = "none";
      } else {
        if (histEmpty) histEmpty.classList.add("hidden");

        // Cover map from server payload
        const coverByNorm = {};
        for (const entry of history){
          const t = splitTrack(entry.t);
          const n = normKey(t.artist, t.title);
          const u = String(entry.cover_url || "").trim();
          if (n && u) coverByNorm[n] = u;
        }

        // NOW PLAYING
        const currentEntry = history[0];
        const current = splitTrack(currentEntry.t);

        const prettyNowArtist = upperArtist(current.artist || "‚Äî");
        const prettyNowTitle  = titleCaseEN(stripTitleSuffixes(current.title || "‚Äî"));

        artistEl.textContent = prettyNowArtist;
        titleEl.textContent  = prettyNowTitle;

        if (timeEl) timeEl.textContent = fmtTime(currentEntry.ts);

        const nowCover = String(currentEntry.cover_url || "").trim() || (coverByNorm[normKey(current.artist, current.title)] || "");
        setCover(nowCover);

        // Votes (this week)
        const week = getISOWeekId();
        const { top: topThis } = await apiGetTopWeek(week);

        // Build quick count maps for buttons
        const votesByRaw = {};
        for (const row of (topThis || [])){
          const k = String(row?.track_key || "").trim();
          const c = Number(row?.count || 0);
          if (!k) continue;
          votesByRaw[k] = c;
        }

        // Now vote button
        const currentKeyNorm = normKey(current.artist, current.title);
        const currentKeyRaw  = rawKey(current.artist, current.title);
        const currentCount = votesByRaw[currentKeyRaw] || 0;
        if (nowVoteCount) nowVoteCount.textContent = String(currentCount);

        const blockedNow = isBlockedShow(current.artist);

        if (nowVoteBtn){
          nowVoteBtn.style.display = "flex";

          if (blockedNow){
            nowVoteBtn.style.opacity = "0.45";
            nowVoteBtn.style.cursor = "not-allowed";
            nowVoteBtn.onclick = () => blockedVoteMsg();
          } else {
            const alreadySession = sessionAlreadyVoted(currentKeyNorm);
            nowVoteBtn.style.opacity = alreadySession ? "0.55" : "1";
            nowVoteBtn.style.cursor = alreadySession ? "not-allowed" : "pointer";

            nowVoteBtn.onclick = async () => {
              if (sessionAlreadyVoted(currentKeyNorm)){
                alert("You already voted for this track. Come back in 24h üôÇ");
                return;
              }
              nowVoteBtn.style.opacity = "0.7";
              nowVoteBtn.style.cursor = "wait";

              const r = await apiVote(currentKeyRaw, current.artist, current.title);

              if (!r.ok){
                nowVoteBtn.style.opacity = "1";
                nowVoteBtn.style.cursor = "pointer";
                voteErrorToast(r);
                return;
              }

              markSessionVoted(currentKeyNorm);

              // bust cache and rerender
              const k = votesCacheKey(week);
              if (window.__abfVotesCache?.[k]) window.__abfVotesCache[k].exp = 0;

              nowVoteBtn.style.opacity = "0.55";
              nowVoteBtn.style.cursor = "not-allowed";
              renderMusicPortal();
            };
          }
        }

        // ‚úÖ Dynamic amount to fill to aside height
        const limit = computeHistoryLimit(18);
        const rows = history.slice(1, 1 + limit);

        // Render history rows
        histEl.innerHTML = rows.map((entry) => {
          const t = splitTrack(entry.t);
          const aRaw = String(t.artist || "").trim();
          const tRaw0 = String(t.title || "").trim();
          const tRaw = stripTitleSuffixes(tRaw0);

          const prettyArtist = upperArtist(aRaw || "‚Äî");
          const prettyTitle  = titleCaseEN(tRaw || "‚Äî");

          const kNorm = normKey(aRaw, tRaw0); // keep original title for key matching
          const kRaw  = rawKey(aRaw, tRaw0);

          const time = fmtTime(entry.ts);

          const blocked = isBlockedShow(aRaw);

          const coverUrl = String(entry.cover_url || "").trim() || (coverByNorm[normKey(aRaw, tRaw0)] || "");

          const count = votesByRaw[kRaw] || 0;

          return rowHtml({
            coverUrl,
            artist: prettyArtist,
            title: prettyTitle,
            time,
            count,
            blocked,
            kNorm,
            kRaw,
            aRaw,
            tRaw: tRaw0
          });
        }).join("");

        // Wire vote buttons
        histEl.querySelectorAll(".voteBtn").forEach((btn) => {
          const kNorm = btn.dataset.norm || "";
          const kRaw  = btn.dataset.raw || "";
          const a     = btn.dataset.artist || "";
          const t0    = btn.dataset.title || "";
          const blocked = btn.dataset.blocked === "1";
          const countEl = btn.querySelector(".voteCount");

          const c = votesByRaw[kRaw] || 0;
          if (countEl) countEl.textContent = String(c);

          if (blocked){
            btn.onclick = () => blockedVoteMsg();
            return;
          }

          const alreadySession = sessionAlreadyVoted(kNorm);
          btn.style.opacity = alreadySession ? "0.55" : "1";
          btn.style.cursor  = alreadySession ? "not-allowed" : "pointer";

          btn.onclick = async () => {
            if (sessionAlreadyVoted(kNorm)){
              alert("You already voted for this track. Come back in 24h üôÇ");
              return;
            }

            btn.style.opacity = "0.7";
            btn.style.cursor = "wait";

            const r = await apiVote(kRaw || rawKey(a, t0), a, t0);

            if (!r.ok){
              btn.style.opacity = "1";
              btn.style.cursor = "pointer";
              voteErrorToast(r);
              return;
            }

            markSessionVoted(kNorm);

            // bust cache and rerender
            const k = votesCacheKey(week);
            if (window.__abfVotesCache?.[k]) window.__abfVotesCache[k].exp = 0;

            btn.style.opacity = "0.55";
            btn.style.cursor = "not-allowed";
            renderMusicPortal();
          };
        });

        // --- Charts (this week) ---
        const topThisSafe = (topThis || [])
          .filter(x => x && x.track_key && !isBlockedShow(String(x.artist || "")))
          .slice(0, 10);

        if (!topThisSafe.length){
          if (topThisEmpty) topThisEmpty.classList.remove("hidden");
          topThisEl.innerHTML = "";
        } else {
          if (topThisEmpty) topThisEmpty.classList.add("hidden");
          const max = Math.max(...topThisSafe.map(x => Number(x.count || 0)), 1);

          topThisEl.innerHTML = topThisSafe.map((row, idx) => {
            const a = upperArtist(String(row.artist || "").trim() || splitTrack(row.track_key).artist || "‚Äî");
            const ti = titleCaseEN(stripTitleSuffixes(String(row.title || "").trim() || splitTrack(row.track_key).title || "‚Äî"));

            const coverUrl =
              String(row.cover_url || "").trim() ||
              (coverByNorm[normKey(splitTrack(row.track_key).artist, splitTrack(row.track_key).title)] || "");

            return chartRowHtml(idx + 1, coverUrl, a, ti, Number(row.count || 0), max);
          }).join("");
        }

        // --- Charts (previous week top 5) ---
        const prevWeek = getPrevISOWeekId();
        const { top: topPrev } = await apiGetTopWeek(prevWeek);

        const topPrevSafe = (topPrev || [])
          .filter(x => x && x.track_key && !isBlockedShow(String(x.artist || "")))
          .slice(0, 5);

        if (!topPrevSafe.length){
          if (topPrevEmpty) topPrevEmpty.classList.remove("hidden");
          topPrevEl.innerHTML = "";
        } else {
          if (topPrevEmpty) topPrevEmpty.classList.add("hidden");
          const maxP = Math.max(...topPrevSafe.map(x => Number(x.count || 0)), 1);

          topPrevEl.innerHTML = topPrevSafe.map((row, idx) => {
            const a = upperArtist(String(row.artist || "").trim() || splitTrack(row.track_key).artist || "‚Äî");
            const ti = titleCaseEN(stripTitleSuffixes(String(row.title || "").trim() || splitTrack(row.track_key).title || "‚Äî"));

            const coverUrl =
              String(row.cover_url || "").trim() ||
              (coverByNorm[normKey(splitTrack(row.track_key).artist, splitTrack(row.track_key).title)] || "");

            return chartRowHtml(idx + 1, coverUrl, a, ti, Number(row.count || 0), maxP);
          }).join("");
        }
      }
    }

    function startMusicTimer(){
      if (window.__abfMusicTimer) clearInterval(window.__abfMusicTimer);
      window.__abfMusicTimer = setInterval(renderMusicPortal, 8000);
    }

    function initMusicPage(){
      if (!isMusicRoute()) return;
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          renderMusicPortal();
          startMusicTimer();
        });
      });
    }

    initMusicPage();

    if (!window.__abfMusicListeners){
      document.addEventListener("astro:page-load", initMusicPage);
      document.addEventListener("astro:after-swap", initMusicPage);

      window.addEventListener("abf:history-updated", () => {
        if (!isMusicRoute()) return;
        renderMusicPortal();
      });

      document.addEventListener("astro:before-swap", () => {
        if (window.__abfMusicTimer) clearInterval(window.__abfMusicTimer);
      });

      window.__abfMusicListeners = true;
    }
  })();
  </script>
</Base>